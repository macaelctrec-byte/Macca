<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.85, maximum-scale=1.0, user-scalable=yes">
    <title>مكة للأدوات الكهربائية بالمقطم | Macca Electric Tools</title>
    <meta name="description" content="مكة للأدوات الكهربائية بالمقطم – كل ما تحتاجه من لمبات، كابلات، مفاتيح، دهانات، وأدوات كهربائية منزلية. شحن سريع وخدمة تركيب احترافية.">
    <meta name="keywords" content="مكة للأدوات الكهربائية, أدوات كهربائية المقطم, محلات كهرباء القاهرة, متجر كهرباء مكة, كابلات وأسلاك, مفاتيح وبرايز, لمبات, دهانات, مستلزمات كهرباء, توريد وتركيب كهرباء">
    <meta name="author" content="مكة للأدوات الكهربائية">
    <meta name="theme-color" content="#ffcd00">
    <meta property="og:title" content="متجر مكة | للإضاءة الحديثة والدهانات">
    <meta property="og:description" content="اكتشف تشكيلتنا الواסعة من الإضاءة الحديثة، الدهانات، والكابلات. خبرة 20 عامًا في المقطم.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://macca3.shop/"> 
    <meta property="og:image" content="https://i.postimg.cc/NfqhM3Th/photo-2025-10-28-14-04-33.jpg"> 
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="متجر مكة | للإضاءة الحديثة والدهانات">
    <meta name="twitter:description" content="خبرة 20 عامًا في الإضاءة الحديثة والدهانات بالمقطم.">
    <meta name="twitter:image" content="https://i.postimg.cc/NfqhM3Th/photo-2025-10-28-14-04-33.jpg">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffcd00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M13 3L7 12h4l-1 8 7-12h-4z'/></svg>" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffcd00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M13 3L7 12h4l-1 8 7-12h-4z'/></svg>">
    <script>
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (e.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <!-- Defer loading of non-critical scripts -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Load fonts non-blockingly and use display=block to prevent CLS -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=block" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=block"></noscript>
    <style>
        body {
            font-family: 'Cairo', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Removed the misplaced 'zoom: 0.9;' rule and extra brace */

        .dark body {
            background-image: linear-gradient(to bottom, #2f2921, #19171b);
            background-attachment: fixed; 
        }
        .dark .dark\:bg-\[\#192230\] {
            background-color: transparent !important;
        }
        .dark .dark\:bg-\[\#2c2f38\] {
            background-color: #2f2921 !important; 
        }

        .dark .dark\:bg-\[\#2c2f38\]\/90 {
            background-color: rgba(47, 41, 33, 0.9) !important; 
        }
        .dark .dark\:bg-\[\#3d474e\] {
            background-color: #374151 !important; 
        }
        .dark .dark\:bg-\[\#2d2d2d\] {
            background-color: #2d2d2d !important; 
        }
        /* --- NEW MODERN SALE BADGE --- */
        .sale-badge {
            position: absolute;
            top: 10px;
            left: 10px; /* تم النقل لليسار لتجنب التداخل مع أزرار الأدمن */
            right: auto;
            z-index: 20;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            font-size: 0.75rem;
            font-weight: 800;
            border-radius: 99px; /* شكل كبسولة */
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            transform: translateZ(0);
        }
        /* --- REMOVED OLD SALE RIBBON STYLES --- */

        /* --- NEW CROWN BADGE STYLE --- */
        .special-crown-badge {
            @apply ml-2 inline-flex items-center justify-center gap-1 px-2 py-0.5 bg-gradient-to-r from-amber-100 to-yellow-100 dark:from-amber-900/30 dark:to-yellow-900/30 border border-amber-200 dark:border-amber-800 rounded-full text-xs font-bold text-amber-700 dark:text-amber-400;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .special-crown-badge i {
            @apply w-3.5 h-3.5 text-amber-500 fill-current;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));
        }
        /* ----------------------------- */

        .star-rating {
            @apply text-[#ffcd00];
        }
        .card-hover {
            @apply transition-all duration-300 ease-in-out;
        }
        .card-hover:hover {
            @apply transform -translate-y-1 scale-105 shadow-xl;
        }
        .page-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page-section.active {
            display: block;
        }
        
        /* --- NEW DROPDOWN STYLES --- */
        #user-dropdown-menu {
            transition: opacity 0.1s ease-out, transform 0.1s ease-out;
            transform-origin: top right; /* LTR */
        }
        [dir="rtl"] #user-dropdown-menu {
            transform-origin: top left; /* RTL */
        }
        #user-dropdown-menu[data-state="closed"] {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            pointer-events: none;
        }
        #user-dropdown-menu[data-state="open"] {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        /* --- END NEW DROPDOWN STYLES --- */

        .nav-link {
            @apply relative px-3 py-2 text-sm font-medium transition-all duration-200 rounded-lg;
        }
        
        /* Updated Nav Link Hover for Header compatibility */
        header .nav-link {
            @apply text-gray-700 dark:text-gray-300 hover:text-[#ffcd00];
        }
        header .nav-link.active {
            @apply text-[#ffcd00];
        }

        .mobile-nav-link.active {
            @apply bg-[#ffcd00]/10 text-[#ffcd00];
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        :root {
            color-scheme: dark;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            @apply bg-gray-100 dark:bg-gray-800;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-gray-300 dark:bg-gray-600 rounded-full;
        }
        ::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-400 dark:bg-gray-500;
        }

        .prose {
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .toast-notification {
            @apply fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-6 py-3 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-semibold rounded-lg shadow-lg;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px) translateX(-50%); }
            25%, 75% { opacity: 1; transform: translateY(0) translateX(-50%); }
        }

        #chat-history {
            scroll-behavior: smooth;
        }
        .chat-message {
            @apply p-3 rounded-xl max-w-xs md:max-w-md break-words;
            animation: slideInUp 0.3s ease-out;
        }
        .user-message {
            @apply bg-gradient-to-r from-blue-500 to-blue-600 text-white self-end chat-message rounded-br-lg;
        }
        .model-message {
            @apply bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 self-start chat-message rounded-bl-lg;
        }
        .loading-dots {
            @apply flex items-center space-x-1 p-3;
        }
        .loading-dot {
            @apply w-2 h-2 bg-gray-400 rounded-full animate-bounce;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.1s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.2s;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-recommendation-container {
            @apply flex gap-3 overflow-x-auto p-2 -mr-2 -ml-2;
            
            -webkit-mask-image: linear-gradient(to left, white 90%, transparent 100%);
            mask-image: linear-gradient(to left, white 90%, transparent 100%);
        }

        .chat-product-card {
            @apply flex-shrink-0 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden border border-gray-200 dark:border-gray-700 transition-transform duration-200 hover:scale-105;
        }
        .chat-product-card img {
            @apply w-full h-24 object-cover;
        }
        .chat-product-card-content {
            @apply p-2;
        }
        .chat-product-card-name {
            @apply text-sm font-semibold text-gray-800 dark:text-white truncate;
        }
        .chat-product-card-price {
            @apply text-xs text-gray-600 dark:text-gray-300;
        }
        .chat-product-card-btn {
            @apply block w-full text-center bg-[#ffcd00] text-gray-900 text-xs font-bold py-1 px-2 rounded-md mt-2 hover:bg-[#ffda33];
        }
        
        /* This container is no longer used */
        /*
        .suggestion-chip-container {
            @apply p-4 border-t border-white/20 dark:border-white/10 bg-white/50 dark:bg-transparent;
        }
        .suggestion-chip-scroll {
            @apply flex gap-2 flex-wrap justify-center;
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        .suggestion-chip-scroll::-webkit-scrollbar {
            display: none; 
        }
        */

        /* This new class styles the suggestions container INSIDE the chat */
        .chat-suggestions-container {
            @apply flex gap-2 flex-wrap justify-start self-start pt-2;
            animation: slideInUp 0.3s ease-out;
        }

        .suggestion-chip {
            /* Made the chips a bit smaller to fit better in the chat */
            @apply px-3 py-1.5 bg-gray-100/80 dark:bg-gray-900/50 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-full cursor-pointer hover:bg-[#ffcd00] hover:text-gray-900 dark:hover:bg-[#ffcd00] dark:hover:text-gray-900 transition-all duration-200 shadow-sm border border-transparent hover:border-[#ffcd00]/50;
        }
        .ai-modal-backdrop[data-state="open"] #gemini-help-panel {
            opacity: 1; transform: translateY(0);
        }
        .ai-modal-backdrop[data-state="closed"] #gemini-help-panel {
            opacity: 0; transform: translateY(24px); /* 24px = translate-y-6 */
        }
        .ai-modal-backdrop[data-state="open"] {
            opacity: 1;
        }
        .ai-modal-backdrop[data-state="closed"] {
            opacity: 0;
        }
        .suggestion-card {
            @apply bg-white dark:bg-[#2c2f38] rounded-xl overflow-hidden shadow-md border border-[#ffcd00]/30 dark:border-[#ffcd00]/50 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:border-[#ffcd00]/80;
        }
        .suggestion-card img {
            @apply w-full h-32 object-cover;
        }
        .suggestion-card-content {
            @apply p-3;
        }
        .suggestion-card-name {
            @apply text-sm font-semibold text-gray-800 dark:text-white truncate mb-1;
        }
        .suggestion-card-price {
            @apply text-sm text-gray-700 dark:text-gray-200;
        }
        .suggestion-card-btn {
            @apply block w-full text-center bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-xs font-semibold py-2 px-3 rounded-md mt-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors;
        }
        .dark .whatsapp-fab {
            background-color: rgba(255, 255, 255, 0.1) !important; 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            color: #ffcd00 !important; 
        }

        .dark .whatsapp-fab:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            color: #ffda33 !important;
        }

        /* --- NEW STYLES FOR COMPACT SUGGESTIONS --- */
        #ai-suggestions-grid .product-card-wrapper {
            @apply shadow-md border-gray-200 dark:border-gray-700;
        }
        #ai-suggestions-grid .product-card-wrapper:hover {
            @apply shadow-lg transform-none scale-100;
        }
        #ai-suggestions-grid img.object-cover {
            @apply h-32 sm:h-40; /* Smaller image */
        }
        #ai-suggestions-grid .p-4 {
            @apply p-3; /* Slightly less padding */
        }
        #ai-suggestions-grid .product-name {
            @apply text-sm; /* Smaller title */
        }
        #ai-suggestions-grid .star-rating {
            @apply mb-1 text-xs; /* Smaller stars, less margin */
        }
        #ai-suggestions-grid .text-lg {
            @apply text-base; /* Smaller price */
        }
        #ai-suggestions-grid .text-sm {
            @apply text-xs;
        }
        #ai-suggestions-grid .flex-1 {
            @apply text-xs px-3 py-1.5; /* Smaller details button */
        }
        #ai-suggestions-grid .add-to-cart-btn {
            @apply p-1.5; /* Smaller add-to-cart button */
        }
        #ai-suggestions-grid .add-to-cart-btn i {
            @apply w-4 h-4;
        }
        #ai-suggestions-grid .sale-ribbon {
            @apply w-16 h-16;
        }
        #ai-suggestions-grid .sale-ribbon span {
            @apply w-20 text-xs top-12 right-[-28px] py-0.5;
        }
        /* --- END NEW STYLES --- */
        
        /* --- NEW TESTIMONIALS SCROLL STYLES --- */
        .testimonials-scroll-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }
        .testimonials-scroll-container::before,
        .testimonials-scroll-container::after {
            content: "";
            position: absolute;
            top: 0;
            width: 100px;
            height: 100%;
            z-index: 2;
        }
        .testimonials-scroll-container::before {
            left: 0;
            background: linear-gradient(to right, var(--bg-color), transparent);
        }
        .testimonials-scroll-container::after {
            right: 0;
            background: linear-gradient(to left, var(--bg-color), transparent);
        }
        :root {
            --bg-color: #ffffff; /* Changed from #f3f4f6 to #ffffff for white bg */
        }
        .dark {
            --bg-color: #192230; /* dark:bg-[#192230] */
        }

        .testimonials-scroll-track {
            display: inline-block;
            animation: scroll-rtl 120s linear infinite; /* Increased duration for more items */
        }
        .testimonials-scroll-track:hover {
            animation-play-state: paused;
        }

        @keyframes scroll-rtl {
            0% { transform: translateX(0); }
            100% { transform: translateX(50%); } /* Move half the width (original set) */
        }
        /* --- END TESTIMONIALS SCROLL STYLES --- */

        /* --- FAQ ACCORDION STYLES (UPDATED TO MAX-HEIGHT METHOD) --- */
        .faq-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        /* Styles for open state styling (background/icon) remain the same */
        .faq-item[data-open="true"] .faq-header {
            background-color: rgba(255, 205, 0, 0.05);
        }
        .dark .faq-item[data-open="true"] .faq-header {
            background-color: rgba(255, 205, 0, 0.05);
        }
        .faq-item[data-open="true"] .faq-icon {
            transform: rotate(180deg);
            color: #ffcd00;
        }
        /* Removed .faq-inner min-height as it's not needed for this method */
        /* --- END FAQ STYLES --- */

        /* --- SLIDER STYLES --- */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* New Styles for Touch & Drag */
        .slider-container {
            -webkit-overflow-scrolling: touch; /* ناعم جداً على iOS */
            touch-action: auto; /* تم التعديل لحل مشكلة السكرول العمودي في الموبايل */
            cursor: grab; /* شكل اليد للماوس */
            scrollbar-width: none; /* إخفاء السكرول بار */
        }
        .slider-container:active {
            cursor: grabbing; /* شكل اليد المغلقة عند السحب */
        }
        .slider-container::-webkit-scrollbar {
            display: none;
        }

        /* Force width for slider items */
        #home-offers-grid .product-card-wrapper,
        #home-bestsellers-grid .product-card-wrapper {
            width: 200px;
            flex-shrink: 0;
            scroll-snap-align: start;
        }
        @media (min-width: 640px) {
            #home-offers-grid .product-card-wrapper,
            #home-bestsellers-grid .product-card-wrapper {
                width: 260px;
            }
        }
        
        /* --- COMPACT SUGGESTIONS OVERRIDES (تصغير قسم قد يعجبك أيضا) --- */
        #ai-suggestions-grid-desktop .product-card-wrapper,
        #ai-suggestions-grid-mobile .product-card-wrapper {
            border-radius: 0.75rem; /* زوايا أقل */
        }
        /* تصغير ارتفاع الصورة */
        #ai-suggestions-grid-desktop .product-card-wrapper .h-48,
        #ai-suggestions-grid-mobile .product-card-wrapper .h-48 {
            height: 6rem !important; /* 96px للموبايل */
        }
        @media (min-width: 640px) {
            #ai-suggestions-grid-desktop .product-card-wrapper .sm\:h-56,
            #ai-suggestions-grid-mobile .product-card-wrapper .sm\:h-56 {
                height: 8rem !important; /* 128px للكمبيوتر */
            }
        }
        /* تصغير الهوامش الداخلية */
        #ai-suggestions-grid-desktop .p-4, 
        #ai-suggestions-grid-desktop .sm\:p-5,
        #ai-suggestions-grid-mobile .p-4,
        #ai-suggestions-grid-mobile .sm\:p-5 {
            padding: 0.5rem !important;
        }
        /* تصغير عنوان المنتج */
        #ai-suggestions-grid-desktop h3,
        #ai-suggestions-grid-mobile h3 {
            font-size: 0.65rem !important;
            line-height: 1.2;
            height: 2.4em; /* سطرين فقط */
            margin-bottom: 0.25rem;
        }
        /* تصغير السعر */
        #ai-suggestions-grid-desktop .text-xl,
        #ai-suggestions-grid-desktop .sm\:text-2xl,
        #ai-suggestions-grid-mobile .text-xl,
        #ai-suggestions-grid-mobile .sm\:text-2xl {
            font-size: 0.75rem !important;
        }
        #ai-suggestions-grid-desktop .text-sm,
        #ai-suggestions-grid-mobile .text-sm {
            font-size: 0.5rem !important;
        }
        /* تصغير زر الإضافة للسلة */
        #ai-suggestions-grid-desktop .add-to-cart-btn,
        #ai-suggestions-grid-mobile .add-to-cart-btn {
            width: 1.5rem !important;
            height: 1.5rem !important;
        }
        #ai-suggestions-grid-desktop .add-to-cart-btn i,
        #ai-suggestions-grid-mobile .add-to-cart-btn i {
            width: 0.75rem !important;
            height: 0.75rem !important;
        }
        /* إخفاء بعض العناصر غير الضرورية في الحجم الصغير */
        #ai-suggestions-grid-desktop .sale-badge,
        #ai-suggestions-grid-mobile .sale-badge {
            padding: 1px 4px;
            font-size: 0.5rem;
            top: 2px;
            left: 2px;
        }
        /* --- END SLIDER STYLES --- */
    </style>
    
</head>
<body class="bg-white dark:bg-[#192230] text-gray-800 dark:text-gray-200 selection:bg-[#ffcd00] selection:text-gray-900 overflow-hidden"> <!-- Added overflow-hidden to body initially -->

    <!-- شاشة التحميل (Global Loader) -->
    <div id="global-loader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white dark:bg-[#192230] transition-opacity duration-700">
        <div class="relative flex items-center justify-center mb-4">
            <div class="absolute inset-0 rounded-full border-4 border-[#ffcd00]/20"></div>
            <div class="w-16 h-16 rounded-full border-4 border-transparent border-t-[#ffcd00] animate-spin"></div>
            <i data-lucide="zap" class="absolute w-6 h-6 text-[#ffcd00] fill-current animate-pulse"></i>
        </div>
        <h2 class="text-xl font-black text-gray-900 dark:text-white tracking-tight">متجر مكة</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 font-medium">جاري تجهيز المنتجات...</p>
    </div>

    <!-- Main App Container (Hidden initially with opacity) -->
    <div id="app" class="min-h-screen flex flex-col opacity-0 transition-opacity duration-700">
        
        <!-- RESTRUCTURED HEADER TO MATCH IMAGE -->
        <!-- Unified Background: bg-white for light, dark:bg-[#2f2921] (Site's Original Dark Color) for dark -->
        <!-- REMOVED: sticky top-0 shadow-lg (To make it static and part of the flow) -->
        <!-- ADDED: relative (To keep z-index working for dropdowns) -->
        <!-- REMOVED: border-b border-gray-200 dark:border-white/5 (To remove the bottom line) -->
        <header class="relative w-full bg-white dark:bg-transparent z-50">
            
            <!-- 1. Top Bar -->
            <!-- bg-transparent to inherit header color -->
            <!-- MODIFIED: Added 'hidden' class by default so it doesn't flash before Firebase loads -->
            <div id="top-notification-bar" class="hidden bg-transparent text-gray-900 dark:text-gray-300 text-xs py-1 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-0 transition-all duration-300 border-b border-gray-100 dark:border-transparent">
                
                <!-- تم حذف قسم الروابط (مساعدة وسياسة الاسترجاع) من هنا -->
                
                <!-- Dynamic Text Section -->
                <!-- Added 'hidden' by default so it only shows if there is content -->
                <div class="text-center flex gap-1 justify-center hidden" id="top-bar-content">
                    <span id="top-bar-text" class="text-gray-700 dark:text-gray-300"></span> 
                    <span id="top-bar-highlight" class="text-[#ffcd00] font-bold"></span>
                </div>
                
            </div>

            <!-- 2. Main Header (Logo, Search, Login) -->
            <!-- bg-transparent to inherit header color -->
            <!-- REDUCED PADDING: py-4 to py-2 -->
            <div class="bg-transparent py-2 px-4 sm:px-6 lg:px-8 relative">
                <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-y-4 gap-x-2 sm:gap-x-4">
                    
                    <!-- Right: Logo (Macca Electric Tools) -->
                    <!-- MODIFIED: Added w-full justify-center sm:w-auto sm:justify-start to center logo on mobile -->
                    <a href="#home" class="flex-shrink-0 flex items-center gap-3 group order-1 w-full justify-center sm:w-auto sm:justify-start" data-page="home">
                        
                        <!-- Custom Logo Image (Hidden by default) -->
                        <!-- INCREASED HEIGHT: h-14 to h-20 -->
                        <!-- تم إزالة اللوجو الثابت (default-logo-container) والإبقاء فقط على اللوجو الديناميكي -->
                        <!-- تأكد من رفع شعار من لوحة التحكم ليظهر هنا -->
                        <img id="site-logo-img" src="" alt="شعار الموقع" class="h-20 w-auto object-contain hidden transition-transform duration-300 group-hover:scale-105">

                    </a>

                    <!-- Center: Global Search Bar -->
                    <!-- MODIFIED: Changed order to 2, removed w-full, added flex-grow and min-w-0 to sit next to icons -->
                    <div class="flex-grow order-2 md:order-2 min-w-0">
                        <div class="relative max-w-2xl mx-auto">
                            <!-- REDUCED PADDING: py-3 to py-2 -->
                            <input type="text" id="global-search-input" 
                                   placeholder="أنا أبحث عن..." 
                                   class="w-full bg-gray-100 dark:bg-[#333] border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 text-sm rounded-full py-2 px-4 pl-10 focus:outline-none focus:border-[#ffcd00] focus:ring-1 focus:ring-[#ffcd00] transition-all shadow-inner">
                            <button class="absolute left-0 top-0 bottom-0 px-4 text-gray-500 dark:text-gray-400 hover:text-[#ffcd00] transition-colors" aria-label="Search">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Left: Login Button / User Actions -->
                    <!-- MODIFIED: Changed order to 3, reduced gap on mobile (gap-2) to fit next to search -->
                    <div class="flex items-center gap-2 sm:gap-4 order-3 md:order-3 flex-shrink-0">
                        
                        <!-- Favorites Icon (NEW) -->
                        <a href="#favorites" class="relative group p-1 transition-transform hover:scale-110" data-page="favorites" title="المفضلة">
                            <i data-lucide="heart" class="w-6 h-6 text-gray-700 dark:text-gray-300 group-hover:text-red-500 transition-colors"></i>
                            <!-- Badge can be enabled later if functionality is added -->
                            <span id="favorites-count-badge" class="absolute -top-1 -right-1 h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[9px] font-bold text-white border-2 border-white dark:border-[#222] hidden">0</span>
                        </a>

                        <!-- Cart Icon (Always visible) -->
                        <a href="#cart" class="relative group p-1" data-page="cart">
                            <i data-lucide="shopping-bag" class="w-6 h-6 text-gray-700 dark:text-gray-300 group-hover:text-[#ffcd00] transition-colors"></i>
                            <span id="cart-count-badge" class="absolute -top-1 -right-1 h-4 w-4 items-center justify-center rounded-full bg-[#ffcd00] text-[9px] font-bold text-gray-900 border-2 border-white dark:border-[#222] hidden">0</span>
                        </a>

                        <!-- Login Button (Desktop & Mobile) - Modified to be visible on mobile -->
                        <!-- MODIFIED: Removed 'hidden sm:inline-flex' and used 'inline-flex' to show on all screens -->
                        <button id="google-login-btn" class="inline-flex relative group p-1 transition-transform hover:scale-110" title="تسجيل الدخول">
                            <i data-lucide="user-circle-2" class="w-7 h-7 text-gray-700 dark:text-gray-300 group-hover:text-[#ffcd00] transition-colors"></i>
                        </button>

                        <!-- User Avatar (Hidden by default, shown when logged in) -->
                        <div id="user-info" class="relative hidden items-center"> 
                            <button id="user-avatar-btn" type="button" class="p-0.5 rounded-full ring-2 ring-transparent hover:ring-[#ffcd00] transition-all">
                                <img id="user-avatar" class="w-8 h-8 rounded-full object-cover" src="https://placehold.co/32x32" alt="الصورة الرمزية">
                            </button>
                            <!-- Dropdown Menu -->
                            <div id="user-dropdown-menu" data-state="closed" class="absolute left-0 top-full mt-2 w-56 bg-white dark:bg-[#2c2f38] border border-gray-200 dark:border-gray-700 rounded-xl shadow-2xl py-2 z-50 origin-top-left focus:outline-none">
                                <a href="#admin" id="dropdown-admin-link" data-page="admin" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                                    لوحة التحكم
                                </a>
                                <div class="h-px bg-gray-200 dark:bg-gray-700 my-2 mx-4"></div>
                                <button id="google-logout-btn-dropdown" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-right">
                                    <i data-lucide="log-out" class="w-4 h-4"></i>
                                    تسجيل الخروج
                                </button>
                            </div>
                        </div>

                        <!-- Mobile Menu Toggle REMOVED -->
                    </div>
                </div>
            </div>
            
            <!-- NEW: Mobile Horizontal Navigation Bar (Like Desktop) -->
            <div class="md:hidden w-full border-t border-gray-100 dark:border-white/5 bg-white dark:bg-[#2c2f38] shadow-sm relative z-40">
                <!-- MODIFIED: Added justify-center and reduced gap to gap-4 to center items -->
                <div class="slider-container flex items-center justify-center gap-4 px-4 py-3 overflow-x-auto whitespace-nowrap text-sm font-bold no-scrollbar">
                    
                    <a href="#home" class="nav-link text-gray-800 dark:text-gray-200 hover:text-[#ffcd00] flex-shrink-0" data-page="home">
                        الرئيسية
                    </a>

                    <!-- MODIFIED: Changed to Button to toggle menu -->
                    <button id="mobile-departments-btn" class="nav-link text-gray-800 dark:text-gray-200 hover:text-[#ffcd00] flex items-center gap-1 flex-shrink-0 focus:outline-none">
                        الأقسام
                        <i id="mobile-departments-icon" data-lucide="chevron-down" class="w-3 h-3 text-[#ffcd00] transition-transform duration-300"></i>
                    </button>

                    <a href="#offers" class="nav-link text-red-600 dark:text-red-500 hover:text-red-500 flex items-center gap-1 flex-shrink-0" data-page="offers">
                        <i data-lucide="flame" class="w-3 h-3 fill-current animate-pulse"></i>
                        العروض
                    </a>

                    <a href="#blog" class="nav-link text-gray-800 dark:text-gray-200 hover:text-[#ffcd00] flex-shrink-0" data-page="blog">
                        المدونة
                    </a>

                    <a href="#contact" class="nav-link text-gray-800 dark:text-gray-200 hover:text-[#ffcd00] flex-shrink-0" data-page="contact">
                        تواصل معنا
                    </a>

                </div>

                <!-- NEW: Mobile Departments Dropdown Menu -->
                <div id="mobile-departments-menu" class="hidden absolute top-full left-0 w-full bg-white dark:bg-[#2c2f38] border-t border-gray-100 dark:border-white/5 shadow-2xl z-50 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <div class="p-4 grid grid-cols-3 gap-3">
                        
                        <a href="#products" data-page="products" data-category-filter="Lighting" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">إضاءة</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="Cables" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="plug-2" class="w-6 h-6 text-blue-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">كابلات</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="Switches" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="toggle-right" class="w-6 h-6 text-gray-500 dark:text-gray-400"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">مفاتيح</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="Paints" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="paint-bucket" class="w-6 h-6 text-green-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">دهانات</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="Ironmongery" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="hammer" class="w-6 h-6 text-orange-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">حدايد</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="Showers" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="satellite" class="w-6 h-6 text-cyan-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">دش</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="Electronics" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="cpu" class="w-6 h-6 text-indigo-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">الكترونيات</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="OpticalPanels" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="layout-grid" class="w-6 h-6 text-teal-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">لوحات</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="BuildingMaterials" class="mobile-dept-item flex flex-col items-center text-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-white/5 hover:bg-[#ffcd00]/10 transition-colors border border-transparent hover:border-[#ffcd00]/20">
                            <i data-lucide="brick-wall" class="w-6 h-6 text-stone-500"></i>
                            <span class="text-[10px] font-bold text-gray-800 dark:text-gray-200">بناء</span>
                        </a>

                        <a href="#products" data-page="products" data-category-filter="all" class="col-span-3 py-3 text-center bg-[#ffcd00] text-gray-900 font-bold rounded-xl text-xs mt-1 shadow-md mobile-dept-item">
                            عرض جميع المنتجات &larr;
                        </a>
                    </div>
                </div>
            </div>

            <!-- Mobile Menu (Old Dropdown) REMOVED -->
        </header>

        <!-- 3. Navigation Bar (SEPARATED FROM HEADER) -->
        <!-- Removed bg-white/dark inheritance to be transparent/no-background -->
        <div class="hidden md:block w-full z-40 relative my-1">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-center h-12 relative"> <!-- Changed justify-between to justify-center and added relative -->
                    
                    <!-- Navigation Links (Centered) -->
                    <div class="flex items-center gap-8 text-sm font-bold">
                        <a href="#home" class="nav-link text-gray-700 dark:text-gray-300 hover:text-[#ffcd00] transition-colors flex items-center gap-2" data-page="home">
                            الرئيسية
                        </a>
                        
                        <!-- Departments Dropdown -->
                        <div class="relative group">
                            <button class="nav-link text-gray-700 dark:text-gray-300 hover:text-[#ffcd00] transition-colors flex items-center gap-2 focus:outline-none py-4">
                                الأقسام
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-300 group-hover:-rotate-180 text-[#ffcd00]"></i>
                            </button>
                            
                            <!-- Dropdown Menu (Modern Mega Menu) -->
                            <div class="absolute top-full right-1/2 translate-x-1/2 w-[320px] sm:w-[480px] bg-white dark:bg-[#202124] border border-gray-100 dark:border-white/10 rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.15)] dark:shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)] p-4 invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-300 transform origin-top scale-95 group-hover:scale-100 z-50">
                                
                                <!-- Header Label -->
                                <div class="flex items-center justify-between mb-3 px-2">
                                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">تصفح حسب الفئة</span>
                                    <span class="w-1.5 h-1.5 rounded-full bg-[#ffcd00]"></span>
                                </div>

                                <!-- Grid Layout -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    
                                    <a href="#products" data-page="products" data-category-filter="Lighting" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center text-yellow-600 dark:text-yellow-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="lightbulb" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">إضاءة حديثة</span>
                                            <span class="block text-[10px] text-gray-400">ليد، نجف، ديكور</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Cables" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="plug-2" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">كابلات وأسلاك</span>
                                            <span class="block text-[10px] text-gray-400">السويدي، معتمدة</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Switches" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-gray-700/50 flex items-center justify-center text-gray-600 dark:text-gray-300 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="toggle-right" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">مفاتيح وبرايز</span>
                                            <span class="block text-[10px] text-gray-400">فينوس، سانشي</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Paints" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-green-50 dark:bg-green-900/20 flex items-center justify-center text-green-600 dark:text-green-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="paint-bucket" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">دهانات وديكور</span>
                                            <span class="block text-[10px] text-gray-400">جوتن، سايبس</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Ironmongery" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center text-orange-600 dark:text-orange-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="hammer" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">حدايد ومسامير</span>
                                            <span class="block text-[10px] text-gray-400">عدد يدوية</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Showers" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-cyan-50 dark:bg-cyan-900/20 flex items-center justify-center text-cyan-600 dark:text-cyan-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="satellite" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">دش ورسيفرات</span>
                                            <span class="block text-[10px] text-gray-400">أطباق، عدسات</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Electronics" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="cpu" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">الكترونيات</span>
                                            <span class="block text-[10px] text-gray-400">مشتركات، محولات</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="OpticalPanels" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-teal-50 dark:bg-teal-900/20 flex items-center justify-center text-teal-600 dark:text-teal-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="layout-grid" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">لوحات كهرباء</span>
                                            <span class="block text-[10px] text-gray-400">قواطع، عدادات</span>
                                        </div>
                                    </a>
                                    
                                    <a href="#products" data-page="products" data-category-filter="BuildingMaterials" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-stone-50 dark:bg-stone-900/20 flex items-center justify-center text-stone-600 dark:text-stone-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="brick-wall" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">مواد بناء</span>
                                            <span class="block text-[10px] text-gray-400">أسمنت، جبس</span>
                                        </div>
                                    </a>

                                    <a href="#products" data-page="products" data-category-filter="Parts" class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-white/5 transition-all group/item border border-transparent hover:border-gray-100 dark:hover:border-white/5">
                                        <div class="w-10 h-10 rounded-lg bg-purple-50 dark:bg-purple-900/20 flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover/item:scale-110 transition-transform">
                                            <i data-lucide="settings" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-bold text-gray-800 dark:text-gray-200">قطع غيار</span>
                                            <span class="block text-[10px] text-gray-400">صيانة وإصلاح</span>
                                        </div>
                                    </a>

                                </div>

                                <!-- Footer: Added data-category-filter="all" -->
                                <a href="#products" data-page="products" data-category-filter="all" class="mt-4 block w-full py-3 text-center bg-gray-50 dark:bg-white/5 rounded-xl text-sm font-bold text-gray-700 dark:text-gray-200 hover:bg-[#ffcd00] hover:text-gray-900 transition-all border border-gray-100 dark:border-white/5">
                                    عرض جميع المنتجات &larr;
                                </a>
                            </div>
                        </div>

                        <a href="#offers" class="nav-link text-red-600 dark:text-red-500 hover:text-red-500 font-black transition-colors flex items-center gap-1.5" data-page="offers">
                            العروض <i data-lucide="flame" class="w-4 h-4 fill-current animate-pulse"></i>
                        </a>
                        <a href="#blog" class="nav-link text-gray-700 dark:text-gray-300 hover:text-[#ffcd00] transition-colors flex items-center gap-2" data-page="blog">
                            المدونة
                        </a>
                        <a href="#contact" class="nav-link text-gray-700 dark:text-gray-300 hover:text-[#ffcd00] transition-colors flex items-center gap-2" data-page="contact">
                            تواصل معنا
                        </a>
                    </div>

                    <!-- Left Side: User Placeholder / Visitor Count (Positioned absolutely to left) -->
                    <div class="absolute left-0 flex items-center gap-4">
                        <!-- Happy Customers Counter (Modern Badge) -->
                        <!-- MODIFIED: Added id="header-visitor-counter" and 'hidden' class to prevent '...' flash -->
                        <div id="header-visitor-counter" class="hidden flex items-center gap-3 px-3 py-1.5 bg-white dark:bg-[#2c2f38] border border-gray-200 dark:border-gray-700 rounded-full shadow-sm hover:shadow-md transition-all duration-300 group cursor-default">
                            <div class="relative">
                                <div class="w-8 h-8 bg-[#ffcd00]/10 rounded-full flex items-center justify-center text-[#ffcd00] group-hover:bg-[#ffcd00] group-hover:text-gray-900 transition-colors">
                                    <i data-lucide="smile" class="w-5 h-5"></i>
                                </div>
                                <span class="absolute -top-1 -right-1 flex h-3 w-3">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500 border-2 border-white dark:border-[#2c2f38]"></span>
                                </span>
                            </div>
                            <div class="flex flex-col items-start">
                                <!-- REMOVED: '...' placeholder, starts empty -->
                                <span dir="ltr" id="visitor-count-number" class="text-sm font-bold text-gray-900 dark:text-white leading-none group-hover:text-[#ffcd00] transition-colors"></span>
                                <span class="text-[10px] text-gray-500 dark:text-gray-400 font-medium">عميل سعيد</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- REMOVED: Banner Divs (special-offer-banner-light & dark) deleted as requested -->

        <main class="px-4 sm:px-6 lg:px-8 pb-8 flex-1">
            
            <!-- NEW: Top "Current Offers" Section -->
            <section id="current-offers-section" class="page-section active pt-4 pb-8 hidden">
                <div class="flex items-center gap-2 mb-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-red-600 dark:text-red-400">🔥 العروض الحالية</h2>
                    <div class="h-px flex-grow bg-red-200 dark:bg-red-900/30 ml-4"></div>
                </div>
                <div id="top-offers-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 sm:gap-4">
                    <!-- Offer cards will be injected here -->
                </div>
            </section>

            <section id="page-home" class="page-section space-y-12 pt-8">
                 <!-- MODIFIED: Added 'hidden' class by default so it relies purely on Admin Config -->
                 <!-- REMOVED: Hardcoded content text to prevent flashing default data -->
                 <div id="hero-section-container" class="hidden relative w-full rounded-[2.5rem] overflow-hidden shadow-2xl isolate min-h-[400px] sm:min-h-[500px] items-center group">
                    
                    <!-- Background Image with Zoom Effect on Hover -->
                    <img id="hero-bg-image" 
                         src="" 
                         alt="خلفية المتجر" 
                         class="absolute inset-0 w-full h-full object-cover z-0 transition-transform duration-1000 group-hover:scale-105 hidden">
                    
                    <!-- Video Background -->
                    <video id="hero-video" autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-30 hidden">
                        <source id="hero-video-source" src="" type="video/mp4">
                    </video>

                    <!-- Modern Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-l from-[#1a1a1a] via-[#1a1a1a]/80 to-transparent z-10"></div>

                    <!-- Decorative Abstract Shapes -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-[#ffcd00] rounded-full mix-blend-overlay filter blur-3xl opacity-20 animate-pulse z-10 translate-x-1/2 -translate-y-1/2"></div>

                    <!-- Text Content Container -->
                    <div class="relative z-20 w-full max-w-4xl px-6 sm:px-12 lg:px-16 flex flex-col items-start text-right">
                        
                        <!-- Badge -->
                        <div id="hero-badge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[#ffcd00]/20 border border-[#ffcd00]/30 text-[#ffcd00] text-xs font-bold mb-6 backdrop-blur-md">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#ffcd00] opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-[#ffcd00]"></span>
                            </span>
                            <!-- Empty by default, populated by JS -->
                            <span id="hero-badge-text"></span>
                        </div>

                        <h1 class="text-4xl sm:text-5xl lg:text-7xl font-black text-white mb-6 tracking-tight leading-tight drop-shadow-lg">
                            <!-- Empty by default, populated by JS -->
                            <span id="hero-title-main"></span>
                            <span id="hero-title-sub" class="block text-transparent bg-clip-text bg-gradient-to-bl from-[#ffcd00] to-[#ffda33] text-2xl sm:text-4xl lg:text-5xl mt-2">
                            </span>
                        </h1>
                        
                        <!-- Empty by default, populated by JS -->
                        <p id="hero-description" class="text-lg sm:text-xl text-gray-300 font-medium mb-10 max-w-lg leading-relaxed drop-shadow-md border-r-4 border-[#ffcd00] pr-4">
                        </p>
                        
                        <div class="flex flex-wrap gap-4">
                            <a href="#products" class="nav-link inline-flex items-center gap-3 bg-[#ffcd00] text-gray-900 font-bold py-4 px-8 rounded-2xl transition-all duration-300 transform hover:-translate-y-1 shadow-[0_10px_20px_-10px_rgba(255,205,0,0.5)] hover:shadow-[0_20px_25px_-5px_rgba(255,205,0,0.6)] group/btn" data-page="products">
                                <span>تصفح المنتجات</span>
                                <i data-lucide="arrow-left" class="w-5 h-5 transition-transform group-hover/btn:-translate-x-1"></i>
                            </a>
                            
                            <a href="#contact" class="nav-link inline-flex items-center gap-3 bg-white/10 text-white font-bold py-4 px-8 rounded-2xl backdrop-blur-md border border-white/10 transition-all duration-300 hover:bg-white/20" data-page="contact">
                                <span>تواصل معنا</span>
                            </a>
                        </div>
                    </div>
                </div>
            
                <!-- REMOVED: Old Categories Section (أقسامنا الرئيسية) -->
            
                <!-- قسم العروض الحالية (Slider) -->
                <!-- MODIFIED: Added id="home-offers-section" and 'hidden' class -->
                <div id="home-offers-section" class="relative group/slider my-12 hidden">
                    <div class="flex justify-between items-center mb-6 px-2">
                        <h2 class="text-2xl sm:text-3xl font-bold text-right flex items-center gap-2">
                            <span class="w-2 h-8 bg-[#ffcd00] rounded-full inline-block"></span>
                            العروض الحالية
                        </h2>
                        <a href="#products" 
                           class="see-all-link text-sm font-bold text-gray-500 hover:text-[#ffcd00] flex items-center gap-1 transition-colors"
                           data-filter-type="sale">
                            <span>عرض الكل</span>
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        </a>
                    </div>
                    
                    <div class="relative">
                        <!-- زر اليمين (السابق) -->
                        <button id="slider-prev-offers" class="absolute -right-3 sm:-right-5 top-1/2 -translate-y-1/2 z-20 bg-white dark:bg-[#3d474e] text-gray-800 dark:text-white p-3 rounded-full shadow-lg border border-gray-100 dark:border-gray-700 opacity-0 group-hover/slider:opacity-100 transition-all duration-300 hover:bg-[#ffcd00] hover:text-black hover:scale-110 focus:outline-none">
                            <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>

                        <!-- حاوية السلايدر -->
                        <!-- ADDED CLASS: slider-container, REMOVED: no-scrollbar (merged into CSS) -->
                        <div id="home-offers-grid" class="slider-container flex gap-4 overflow-x-auto scroll-smooth pb-8 px-2 snap-x snap-mandatory" dir="rtl">
                            <!-- سيتم ملء المنتجات هنا -->
                        </div>

                        <!-- زر اليسار (التالي) -->
                        <button id="slider-next-offers" class="absolute -left-3 sm:-left-5 top-1/2 -translate-y-1/2 z-20 bg-white dark:bg-[#3d474e] text-gray-800 dark:text-white p-3 rounded-full shadow-lg border border-gray-100 dark:border-gray-700 opacity-0 group-hover/slider:opacity-100 transition-all duration-300 hover:bg-[#ffcd00] hover:text-black hover:scale-110 focus:outline-none">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- قسم الأكثر مبيعاً (Slider) -->
                <!-- MODIFIED: Added id="home-bestsellers-section" and 'hidden' class -->
                <div id="home-bestsellers-section" class="relative group/slider my-12 hidden">
                    <div class="flex justify-between items-center mb-6 px-2">
                        <h2 class="text-2xl sm:text-3xl font-bold text-right flex items-center gap-2">
                            <span class="w-2 h-8 bg-red-500 rounded-full inline-block"></span>
                            الأكثر مبيعاً
                        </h2>
                        <a href="#products" 
                           class="see-all-link text-sm font-bold text-gray-500 hover:text-[#ffcd00] flex items-center gap-1 transition-colors"
                           data-filter-type="bestseller">
                            <span>عرض الكل</span>
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        </a>
                    </div>
                    
                    <div class="relative">
                        <!-- زر اليمين -->
                        <button id="slider-prev-bestsellers" class="absolute -right-3 sm:-right-5 top-1/2 -translate-y-1/2 z-20 bg-white dark:bg-[#3d474e] text-gray-800 dark:text-white p-3 rounded-full shadow-lg border border-gray-100 dark:border-gray-700 opacity-0 group-hover/slider:opacity-100 transition-all duration-300 hover:bg-[#ffcd00] hover:text-black hover:scale-110 focus:outline-none">
                            <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>

                        <!-- حاوية السلايدر -->
                        <!-- ADDED CLASS: slider-container, REMOVED: no-scrollbar -->
                        <div id="home-bestsellers-grid" class="slider-container flex gap-4 overflow-x-auto scroll-smooth pb-8 px-2 snap-x snap-mandatory" dir="rtl">
                            <!-- سيتم ملء المنتجات هنا -->
                        </div>

                        <!-- زر اليسار -->
                        <button id="slider-next-bestsellers" class="absolute -left-3 sm:-left-5 top-1/2 -translate-y-1/2 z-20 bg-white dark:bg-[#3d474e] text-gray-800 dark:text-white p-3 rounded-full shadow-lg border border-gray-100 dark:border-gray-700 opacity-0 group-hover/slider:opacity-100 transition-all duration-300 hover:bg-[#ffcd00] hover:text-black hover:scale-110 focus:outline-none">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modernized Supply & Installation Services Section -->
                <div class="relative bg-white dark:bg-gradient-to-br dark:from-[#222] dark:to-[#1a1a1a] rounded-[2.5rem] shadow-2xl overflow-hidden mt-8 sm:mt-16 isolate border border-gray-100 dark:border-none">
                    <!-- Decorative glows -->
                    <div class="absolute top-0 right-0 -translate-y-1/4 translate-x-1/4 w-96 h-96 bg-[#ffcd00]/10 dark:bg-[#ffcd00]/20 blur-3xl rounded-full -z-10 opacity-70"></div>
                    <div class="absolute bottom-0 left-0 translate-y-1/4 -translate-x-1/4 w-64 h-64 bg-[#ffcd00]/5 dark:bg-[#ffcd00]/10 blur-3xl rounded-full -z-10"></div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-0">
                        <!-- Text Content -->
                        <div class="p-6 sm:p-12 lg:py-16 lg:pr-16 lg:pl-8 flex flex-col justify-center order-2 lg:order-1">
                            <div class="inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-[#ffcd00]/10 border border-[#ffcd00]/20 text-[#ffcd00] text-xs sm:text-sm font-bold w-fit mb-4 sm:mb-6 backdrop-blur-md">
                                <i data-lucide="shield-check" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                                <span>للمشاريع والشركات</span>
                            </div>
                            <h2 class="text-xl sm:text-4xl lg:text-5xl font-extrabold text-gray-900 dark:text-white leading-tight mb-4 sm:mb-6">
                                شريكك الموثوق في
                                <br>
                                <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#ffcd00] to-[#ffda33]">التوريد والتركيب</span>
                            </h2>
                            <p class="text-sm sm:text-lg text-gray-600 dark:text-gray-300 leading-relaxed mb-6 sm:mb-8 max-w-xl">
                                لا نكتفي ببيع المنتجات، بل نقدم حلولاً كهربائية متكاملة. من توريد أجود الخامات بأسعار تنافسية إلى التركيب الاحترافي الآمن، نضمن نجاح مشروعك بكفاءة عالية.
                            </p>

                            <!-- Feature List -->
                            <ul class="space-y-3 sm:space-y-5 mb-6 sm:mb-10">
                                <li class="flex items-center gap-3 sm:gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-[#ffcd00] flex items-center justify-center shadow-lg shadow-[#ffcd00]/20">
                                        <i data-lucide="hard-hat" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-900"></i>
                                    </div>
                                    <span class="text-gray-700 dark:text-gray-100 font-medium text-sm sm:text-lg">فريق فني متخصص ومعتمد</span>
                                </li>
                                <li class="flex items-center gap-3 sm:gap-4">
                                     <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-[#ffcd00] flex items-center justify-center shadow-lg shadow-[#ffcd00]/20">
                                        <i data-lucide="badge-check" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-900"></i>
                                    </div>
                                    <span class="text-gray-700 dark:text-gray-100 font-medium text-sm sm:text-lg">ضمان شامل على جودة التركيب</span>
                                </li>
                                <li class="flex items-center gap-3 sm:gap-4">
                                     <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-[#ffcd00] flex items-center justify-center shadow-lg shadow-[#ffcd00]/20">
                                        <i data-lucide="coins" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-900"></i>
                                    </div>
                                    <span class="text-gray-700 dark:text-gray-100 font-medium text-sm sm:text-lg">أسعار خاصة لتوريدات الجملة والمشاريع</span>
                                </li>
                            </ul>

                            <div class="flex flex-wrap gap-3 sm:gap-4">
                                 <a href="https://wa.me/201146641942" target="_blank" class="flex-1 sm:flex-none justify-center inline-flex items-center gap-2 sm:gap-3 px-6 py-3 sm:px-8 sm:py-4 bg-gray-900 hover:bg-gray-800 text-white dark:bg-white/5 dark:text-white font-bold text-sm sm:text-lg rounded-xl sm:rounded-2xl dark:hover:bg-white/10 transition-all border border-transparent dark:border-white/10 backdrop-blur-sm shadow-lg dark:shadow-none">
                                    <i data-lucide="message-circle" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                    <span>استشارة فنية</span>
                                </a>
                            </div>
                        </div>

                        <!-- Image Side -->
                        <div class="relative min-h-[180px] sm:min-h-[300px] lg:min-h-full order-1 lg:order-2">
                            <div class="absolute inset-0 lg:ml-8 rounded-[2.5rem] overflow-hidden">
                                <img src="https://images.unsplash.com/photo-1621905251189-08b45d6a269e?q=80&w=2069&auto=format&fit=crop"
                                     alt="فني كهرباء محترف أثناء العمل"
                                     class="w-full h-full object-cover transform transition-transform duration-700 hover:scale-105"
                                     loading="lazy"
                                     onerror="this.src='https://placehold.co/800x1000/2c2f38/ffcd00?text=خدمات+احترافية'">
                                <!-- Gradient overlay for better text integration on small screens if needed -->
                                <div class="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent lg:bg-gradient-to-r lg:from-white lg:via-transparent lg:to-transparent dark:from-gray-900 dark:lg:from-gray-900 opacity-80 lg:opacity-100"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم إحصائيات الثقة (جديد) -->
                <div class="mt-8 sm:mt-16 relative bg-white dark:bg-[#0a0a0a] py-6 sm:py-16 px-3 sm:px-6 rounded-2xl sm:rounded-[2.5rem] overflow-hidden shadow-2xl border border-gray-200 dark:border-white/5">
                    <!-- Decorative Background Glow -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[200px] h-[200px] sm:w-[500px] sm:h-[500px] bg-[#ffcd00]/10 blur-[50px] sm:blur-[100px] rounded-full pointer-events-none"></div>
                    
                    <div class="relative z-10">
                        <div class="text-center mb-6 sm:mb-12">
                            <h2 class="text-base sm:text-4xl font-black text-gray-900 dark:text-white tracking-tight">
                                أكثر من 10,000 عميل يثقون بخدماتنا
                            </h2>
                        </div>

                        <div class="grid grid-cols-3 gap-2 sm:gap-8 md:gap-12 text-center divide-x divide-x-reverse divide-gray-100 dark:divide-white/5 sm:divide-none">
                            
                            <!-- Stat 1 -->
                            <div class="group flex flex-col items-center justify-center">
                                <!-- Added id="happy-customer-stat" to sync with live counter -->
                                <!-- REMOVED: '...' placeholder -->
                                <div id="happy-customer-stat" class="text-xl sm:text-5xl font-black text-[#ffcd00] mb-1 sm:mb-2 font-mono tracking-tighter group-hover:scale-110 transition-transform duration-300" dir="ltr">
                                    0
                                </div>
                                <div class="text-gray-600 dark:text-gray-300 text-[10px] sm:text-lg font-medium leading-tight">
                                    عميل سعيد
                                </div>
                            </div>

                            <!-- Stat 2 -->
                            <div class="group flex flex-col items-center justify-center sm:border-x sm:border-gray-200 sm:dark:border-white/10 sm:px-8">
                                <div class="text-xl sm:text-5xl font-black text-[#ffcd00] mb-1 sm:mb-2 font-mono tracking-tighter group-hover:scale-110 transition-transform duration-300" dir="ltr">
                                    20 +
                                </div>
                                <div class="text-gray-600 dark:text-gray-300 text-[10px] sm:text-lg font-medium leading-tight">
                                    عاماً خبرة
                                </div>
                            </div>

                            <!-- Stat 3 -->
                            <div class="group flex flex-col items-center justify-center">
                                <!-- Changed 184+ to 36+ -->
                                <div class="text-xl sm:text-5xl font-black text-[#ffcd00] mb-1 sm:mb-2 font-mono tracking-tighter group-hover:scale-110 transition-transform duration-300" dir="ltr">
                                    36 +
                                </div>
                                <div class="text-gray-600 dark:text-gray-300 text-[10px] sm:text-lg font-medium leading-tight">
                                    مؤسسة وثقت بنا
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- قسم آراء العملاء الجديد -->
                <div class="mt-8 sm:mt-16">
                    <h2 class="text-lg sm:text-3xl font-bold text-center mb-4 sm:mb-8 text-gray-900 dark:text-white">
                        ماذا يقول عملاؤنا عنا
                    </h2>
                    
                    <div class="testimonials-scroll-container py-2 sm:py-4">
                        <div class="testimonials-scroll-track space-x-2 space-x-reverse sm:space-x-4" id="testimonials-track">
                            <!-- سيتم ملء هذا القسم بواسطة JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- قسم الأسئلة الشائعة (FAQ) الجديد -->
                <div class="mt-24 max-w-4xl mx-auto px-4 sm:px-6">
                    <div class="text-center mb-10">
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[#ffcd00]/10 text-[#ffcd00] text-xs font-bold mb-4 border border-[#ffcd00]/20">
                            <i data-lucide="help-circle" class="w-4 h-4"></i>
                            <span>الدعم والمساعدة</span>
                        </div>
                        <h2 class="text-3xl sm:text-4xl font-black text-gray-900 dark:text-white mb-4">
                            أسئلة يتكرر طرحها
                        </h2>
                        <p class="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                            جمعنا لك أهم الاستفسارات للإجابة على تساؤلاتك بسرعة.
                        </p>
                    </div>

                    <div class="space-y-4" id="faq-accordion">
                        
                        <!-- Question 1 -->
                        <div class="faq-item group bg-white dark:bg-[#2c2f38] rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:border-[#ffcd00]/50 hover:shadow-md" data-open="true">
                            <button class="faq-header w-full flex items-center justify-between p-5 text-right focus:outline-none transition-colors duration-300">
                                <span class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-[#ffcd00] transition-colors">هل المنتجات أصلية ومضمونة؟</span>
                                <span class="bg-gray-100 dark:bg-white/5 p-2 rounded-full group-hover:bg-[#ffcd00]/10 transition-colors">
                                    <i data-lucide="chevron-down" class="faq-icon w-5 h-5 text-gray-500 transition-transform duration-300"></i>
                                </span>
                            </button>
                            <div class="faq-content">
                                <div class="faq-inner px-5 pb-5 text-gray-600 dark:text-gray-300 leading-relaxed border-t border-transparent">
                                    نعم، جميع منتجاتنا أصلية 100% وتأتي مع ضمان الوكيل الرسمي. نحن نحرص بشدة على توفير أفضل العلامات التجارية الموثوقة في السوق المصري (مثل السويدي، فينوس، شنايدر، وغيرها) لضمان الجودة والأمان لك ولعائلتك.
                                </div>
                            </div>
                        </div>

                        <!-- Question 2 -->
                        <div class="faq-item group bg-white dark:bg-[#2c2f38] rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:border-[#ffcd00]/50 hover:shadow-md" data-open="false">
                            <button class="faq-header w-full flex items-center justify-between p-5 text-right focus:outline-none transition-colors duration-300">
                                <span class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-[#ffcd00] transition-colors">هل يوجد خدمة توصيل للمنازل؟</span>
                                <span class="bg-gray-100 dark:bg-white/5 p-2 rounded-full group-hover:bg-[#ffcd00]/10 transition-colors">
                                    <i data-lucide="chevron-down" class="faq-icon w-5 h-5 text-gray-500 transition-transform duration-300"></i>
                                </span>
                            </button>
                            <div class="faq-content">
                                <div class="faq-inner px-5 pb-5 text-gray-600 dark:text-gray-300 leading-relaxed border-t border-transparent">
                                    بالتأكيد! نوفر خدمة شحن وتوصيل سريع لجميع مناطق القاهرة والجيزة، ولدينا إمكانية الشحن للمحافظات للطلبات الكبيرة. يمكنك إتمام طلبك عبر الموقع وسيتم التواصل معك لتأكيد ميعاد التسليم المناسب.
                                </div>
                            </div>
                        </div>

                        <!-- Question 3 -->
                        <div class="faq-item group bg-white dark:bg-[#2c2f38] rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:border-[#ffcd00]/50 hover:shadow-md" data-open="false">
                            <button class="faq-header w-full flex items-center justify-between p-5 text-right focus:outline-none transition-colors duration-300">
                                <span class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-[#ffcd00] transition-colors">هل يمكنني استرجاع أو استبدال المنتج؟</span>
                                <span class="bg-gray-100 dark:bg-white/5 p-2 rounded-full group-hover:bg-[#ffcd00]/10 transition-colors">
                                    <i data-lucide="chevron-down" class="faq-icon w-5 h-5 text-gray-500 transition-transform duration-300"></i>
                                </span>
                            </button>
                            <div class="faq-content">
                                <div class="faq-inner px-5 pb-5 text-gray-600 dark:text-gray-300 leading-relaxed border-t border-transparent">
                                    نعم، نطبق سياسة حماية المستهلك بالكامل. يحق لك استرجاع أو استبدال المنتج خلال 14 يومًا من تاريخ الشراء، بشرط أن يكون المنتج بحالته الأصلية، في عبوته الكرتونية السليمة، ولم يتم استخدامه أو تركيبه، مع ضرورة وجود فاتورة الشراء.
                                </div>
                            </div>
                        </div>

                        <!-- Question 4 -->
                        <div class="faq-item group bg-white dark:bg-[#2c2f38] rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:border-[#ffcd00]/50 hover:shadow-md" data-open="false">
                            <button class="faq-header w-full flex items-center justify-between p-5 text-right focus:outline-none transition-colors duration-300">
                                <span class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-[#ffcd00] transition-colors">هل تقدمون خدمات التركيب؟</span>
                                <span class="bg-gray-100 dark:bg-white/5 p-2 rounded-full group-hover:bg-[#ffcd00]/10 transition-colors">
                                    <i data-lucide="chevron-down" class="faq-icon w-5 h-5 text-gray-500 transition-transform duration-300"></i>
                                </span>
                            </button>
                            <div class="faq-content">
                                <div class="faq-inner px-5 pb-5 text-gray-600 dark:text-gray-300 leading-relaxed border-t border-transparent">
                                    نعم، تميزنا لا يقتصر على البيع فقط. لدينا فريق فني محترف ومتخصص لتركيب جميع الأدوات الكهربائية، النجف، الدش المركزي، والأنظمة الأمنية. نضمن لك تركيباً آمناً وبأعلى معايير الجودة وبأسعار تنافسية.
                                </div>
                            </div>
                        </div>

                        <!-- Question 5 -->
                        <div class="faq-item group bg-white dark:bg-[#2c2f38] rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:border-[#ffcd00]/50 hover:shadow-md" data-open="false">
                            <button class="faq-header w-full flex items-center justify-between p-5 text-right focus:outline-none transition-colors duration-300">
                                <span class="text-lg font-bold text-gray-900 dark:text-white group-hover:text-[#ffcd00] transition-colors">ما هي طرق الدفع المتاحة؟</span>
                                <span class="bg-gray-100 dark:bg-white/5 p-2 rounded-full group-hover:bg-[#ffcd00]/10 transition-colors">
                                    <i data-lucide="chevron-down" class="faq-icon w-5 h-5 text-gray-500 transition-transform duration-300"></i>
                                </span>
                            </button>
                            <div class="faq-content">
                                <div class="faq-inner px-5 pb-5 text-gray-600 dark:text-gray-300 leading-relaxed border-t border-transparent">
                                    نوفر طرق دفع متعددة لراحتكم: الدفع نقدًا عند الاستلام، الدفع عبر المحافظ الإلكترونية (فودافون كاش)، أو عبر تطبيق انستا باي (InstaPay). (تنويه: خدمة الدفع بالفيزا متوقفة مؤقتاً وسيتم إعادتها قريباً).
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            
            </section>
            
            
            <!-- NEW: Dedicated Offers Page -->
            <section id="page-offers" class="page-section pt-0 pb-12">
                <!-- Modern Hero Header for Offers -->
                <div class="relative bg-gradient-to-r from-red-600 to-rose-800 dark:from-red-900 dark:to-rose-950 rounded-b-[2.5rem] shadow-2xl mb-12 overflow-hidden isolate">
                    <!-- Decorative patterns -->
                    <div class="absolute top-0 right-0 -translate-y-1/2 translate-x-1/4 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-0 left-0 translate-y-1/2 -translate-x-1/4 w-64 h-64 bg-yellow-400/20 rounded-full blur-3xl"></div>
                    
                    <div class="relative z-10 px-6 py-12 sm:py-16 text-center">
                        <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-white text-xs font-bold mb-6 shadow-sm">
                            <i data-lucide="flame" class="w-4 h-4 fill-orange-500 text-orange-500 animate-pulse"></i>
                            <span>خصومات لفترة محدودة</span>
                        </div>
                        <h1 class="text-4xl sm:text-5xl md:text-6xl font-black text-white mb-4 tracking-tight drop-shadow-sm">
                            عروض <span class="text-[#ffcd00]">مكة</span> الحصرية
                        </h1>
                        <p class="text-lg text-red-100 max-w-2xl mx-auto font-medium">
                            اغتنم الفرصة وتسوق أفضل المنتجات بأسعار لا تقبل المنافسة. الجودة التي تثق بها، الآن بسعر أقل.
                        </p>

                        <!-- Enhanced Timer -->
                        <div id="average-offer-timer" class="hidden mt-10 flex flex-wrap justify-center gap-4 sm:gap-6">
                            <!-- Days -->
                            <div class="flex flex-col items-center bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 min-w-[90px] sm:min-w-[110px]">
                                <span id="offer-timer-days" class="text-3xl sm:text-4xl font-black text-white font-mono">00</span>
                                <span class="text-xs sm:text-sm text-red-200 font-medium mt-1">يوم</span>
                            </div>
                            <!-- Separator -->
                            <div class="text-3xl sm:text-4xl font-black text-white/30 self-center pb-4">:</div>
                            <!-- Hours -->
                            <div class="flex flex-col items-center bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 min-w-[90px] sm:min-w-[110px]">
                                <span id="offer-timer-hours" class="text-3xl sm:text-4xl font-black text-white font-mono">00</span>
                                <span class="text-xs sm:text-sm text-red-200 font-medium mt-1">ساعة</span>
                            </div>
                            <!-- Separator -->
                            <div class="text-3xl sm:text-4xl font-black text-white/30 self-center pb-4">:</div>
                            <!-- Minutes -->
                            <div class="flex flex-col items-center bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-4 min-w-[90px] sm:min-w-[110px]">
                                <span id="offer-timer-minutes" class="text-3xl sm:text-4xl font-black text-white font-mono">00</span>
                                <span class="text-xs sm:text-sm text-red-200 font-medium mt-1">دقيقة</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
                    <div id="offers-page-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6">
                        <!-- Offers will be loaded here -->
                    </div>
                    <div id="no-offers-message" class="hidden flex flex-col items-center justify-center py-20 text-center">
                        <div class="w-24 h-24 bg-gray-100 dark:bg-white/5 rounded-full flex items-center justify-center mb-6">
                            <i data-lucide="tag" class="w-10 h-10 text-gray-400"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">لا توجد عروض حالياً</h2>
                        <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">
                            تابعنا باستمرار! نقوم بتحديث العروض بشكل دوري لتوفير أفضل الأسعار لك.
                        </p>
                    </div>
                </div>
            </section>

            <section id="page-products" class="page-section pt-8">
                <div class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-4">
                    <h1 class="text-3xl sm:text-4xl font-bold">جميع المنتجات</h1>
                    <button id="show-add-product-modal-btn" type="button" class="hidden items-center justify-center gap-2 h-10 px-6 bg-[#ffcd00] text-gray-900 font-bold text-sm rounded-xl hover:bg-[#ffda33] transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                        <span>إضافة منتج جديد</span>
                    </button>
                </div>
                
                <div class="flex flex-col lg:flex-row gap-4 lg:gap-8 items-start">
                    <!-- Sidebar Filters -->
                    <!-- MODIFIED: Changed p-6 to p-3 lg:p-6, and space-y-6 to grid layout on mobile -->
                    <aside class="w-full lg:w-72 flex-shrink-0 bg-white dark:bg-[#2c2f38] p-3 lg:p-6 rounded-xl lg:rounded-2xl shadow-lg border border-gray-100 dark:border-white/5 static lg:sticky lg:top-24 transition-all z-10">
                        
                        <!-- Grid Layout for Mobile: grid-cols-2, Gap reduced -->
                        <div class="grid grid-cols-2 lg:grid-cols-1 gap-2 lg:gap-6">
                            
                            <!-- Header: Full width on mobile -->
                            <div class="col-span-2 lg:col-span-1 flex items-center gap-2 pb-2 lg:pb-4 border-b border-gray-100 dark:border-gray-700">
                                <i data-lucide="filter" class="w-4 h-4 lg:w-5 lg:h-5 text-[#ffcd00]"></i>
                                <h3 class="font-bold text-base lg:text-lg">تصفية وبحث</h3>
                            </div>

                            <!-- Search: Full width on mobile -->
                            <div class="col-span-2 lg:col-span-1 space-y-1 lg:space-y-2">
                                <label class="text-[10px] lg:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">بحث</label>
                                <div class="relative">
                                    <!-- Reduced height h-9 on mobile -->
                                    <input type="text" id="product-search-input" placeholder="اسم المنتج، الماركة..." class="w-full h-9 lg:h-11 pl-8 lg:pl-10 pr-3 lg:pr-4 rounded-lg lg:rounded-xl bg-gray-50 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-xs lg:text-sm transition-all">
                                    <i data-lucide="search" class="w-3.5 h-3.5 lg:w-4 lg:h-4 absolute left-2.5 lg:left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>

                            <!-- Sort: Half width on mobile -->
                            <div class="col-span-1 lg:col-span-1 space-y-1 lg:space-y-2">
                                <label class="text-[10px] lg:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">ترتيب حسب</label>
                                <div class="relative">
                                    <select id="product-sort-filter" class="w-full h-9 lg:h-11 pl-8 lg:pl-10 pr-3 lg:pr-4 rounded-lg lg:rounded-xl bg-gray-50 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-xs lg:text-sm appearance-none cursor-pointer transition-all">
                                        <option value="default">الأحدث</option>
                                        <option value="price-asc">السعر: الأقل</option>
                                        <option value="price-desc">السعر: الأعلى</option>
                                    </select>
                                    <i data-lucide="arrow-up-down" class="w-3.5 h-3.5 lg:w-4 lg:h-4 absolute left-2.5 lg:left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Category Filter: Half width on mobile -->
                            <div class="col-span-1 lg:col-span-1 space-y-1 lg:space-y-2">
                                <label class="text-[10px] lg:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">القسم</label>
                                <div class="relative">
                                    <select id="product-category-filter" class="w-full h-9 lg:h-11 pl-8 lg:pl-10 pr-3 lg:pr-4 rounded-lg lg:rounded-xl bg-gray-50 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-xs lg:text-sm appearance-none cursor-pointer transition-all">
                                        <option value="all">الكل</option>
                                        <option value="Lighting">إضاءة</option>
                                        <option value="Cables">كابلات</option>
                                        <option value="Switches">مفاتيح</option>
                                        <option value="Parts">قطع غيار</option>
                                        <option value="Paints">دهانات</option>
                                        <option value="Ironmongery">حدايد</option>
                                        <option value="Showers">الدش</option>
                                        <option value="Electronics">الكترونيات</option>
                                        <option value="OpticalPanels">لوحات</option>
                                        <option value="BuildingMaterials">مواد البناء</option>
                                    </select>
                                    <i data-lucide="layers" class="w-3.5 h-3.5 lg:w-4 lg:h-4 absolute left-2.5 lg:left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Brand Filter: Half width on mobile -->
                            <div class="col-span-1 lg:col-span-1 space-y-1 lg:space-y-2">
                                <label class="text-[10px] lg:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">الماركة</label>
                                <div class="relative">
                                    <select id="product-brand-filter" class="w-full h-9 lg:h-11 pl-8 lg:pl-10 pr-3 lg:pr-4 rounded-lg lg:rounded-xl bg-gray-50 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-xs lg:text-sm appearance-none cursor-pointer transition-all">
                                        <option value="all">الكل</option>
                                        <!-- Brands will be populated by JS -->
                                    </select>
                                    <i data-lucide="tag" class="w-3.5 h-3.5 lg:w-4 lg:h-4 absolute left-2.5 lg:left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- Price Range Filter: Half width on mobile (Stacked inputs to fit) -->
                            <div class="col-span-1 lg:col-span-1 space-y-1 lg:space-y-2">
                                <label class="text-[10px] lg:text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">السعر (ج.م)</label>
                                <!-- Modified to flex-col on small screens if needed, but flex-row fits better with smaller inputs -->
                                <div class="flex items-center gap-1 lg:gap-2" dir="ltr"> 
                                    <div class="relative w-full">
                                        <input type="number" id="product-min-price" placeholder="Min" min="0" class="w-full h-9 lg:h-11 px-1 lg:px-3 rounded-lg lg:rounded-xl bg-gray-50 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-[10px] lg:text-sm transition-all text-center">
                                    </div>
                                    <span class="text-gray-400 font-bold text-xs">-</span>
                                    <div class="relative w-full">
                                        <input type="number" id="product-max-price" placeholder="Max" min="0" class="w-full h-9 lg:h-11 px-1 lg:px-3 rounded-lg lg:rounded-xl bg-gray-50 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-[10px] lg:text-sm transition-all text-center">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </aside>

                    <!-- Products Grid Container -->
                    <div class="flex-1 w-full">
                        <div id="products-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 sm:gap-4">
                            <!-- Products will be populated here -->
                        </div>
                        <div id="no-products-message" class="hidden flex flex-col items-center justify-center py-20 text-center bg-white dark:bg-[#2c2f38] rounded-3xl border border-dashed border-gray-200 dark:border-gray-700">
                            <div class="w-20 h-20 bg-gray-50 dark:bg-white/5 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="search-x" class="w-10 h-10 text-gray-400"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">لم يتم العثور على منتجات</h2>
                            <p class="text-gray-500 dark:text-gray-400 max-w-xs mx-auto">حاول تعديل خيارات البحث أو الفلترة للعثور على ما تبحث عنه.</p>
                        </div>
                    </div>
                </div>
            </section>
            

            <section id="page-details" class="page-section">
                
                <!-- Modern Breadcrumb & Back Button -->
                <div class="max-w-7xl mx-auto mb-6 flex items-center justify-between px-4 sm:px-0">
                    <a href="#products" class="group inline-flex items-center gap-2 text-sm font-bold text-gray-500 hover:text-[#ffcd00] transition-colors" data-page="products">
                        <div class="w-8 h-8 rounded-full bg-white dark:bg-[#2c2f38] flex items-center justify-center shadow-sm group-hover:shadow-md transition-all border border-gray-200 dark:border-gray-700">
                            <i data-lucide="arrow-right" class="w-4 h-4 transition-transform group-hover:-translate-x-1"></i>
                        </div>
                        <span>العودة للمنتجات</span>
                    </a>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mx-auto max-w-7xl">

                    <!-- Right Column: Gallery (7 cols) -->
                    <div class="lg:col-span-7 space-y-6">
                        <div class="bg-white dark:bg-[#2c2f38] rounded-[2.5rem] shadow-xl overflow-hidden border border-gray-100 dark:border-white/5 relative group p-2">
                            
                            <!-- Main Image Area -->
                            <div class="relative rounded-[2rem] overflow-hidden bg-gray-50 dark:bg-[#222] aspect-square sm:aspect-[4/3]">
                                <img id="main-product-image" 
                                     src="https://placehold.co/600x600/ffffff/999999?text=Loading..." 
                                     onerror="this.src='https://placehold.co/600x600/ffffff/999999?text=No+Image'"
                                     alt="صورة المنتج الرئيسية" 
                                     class="w-full h-full object-contain p-4 transition-transform duration-500 group-hover:scale-105">

                                <!-- Navigation Buttons -->
                                <button id="gallery-prev-btn" class="absolute top-1/2 right-4 -translate-y-1/2 p-3 bg-white/80 dark:bg-black/50 backdrop-blur-md text-gray-900 dark:text-white rounded-full shadow-lg hover:bg-[#ffcd00] hover:text-gray-900 transition-all opacity-0 group-hover:opacity-100 translate-x-4 group-hover:translate-x-0">
                                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                                </button>
                                <button id="gallery-next-btn" class="absolute top-1/2 left-4 -translate-y-1/2 p-3 bg-white/80 dark:bg-black/50 backdrop-blur-md text-gray-900 dark:text-white rounded-full shadow-lg hover:bg-[#ffcd00] hover:text-gray-900 transition-all opacity-0 group-hover:opacity-100 -translate-x-4 group-hover:translate-x-0">
                                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                </button>
                                
                                <!-- Zoom/Expand Badge -->
                                <div class="absolute bottom-4 left-4 p-2 bg-black/50 backdrop-blur-sm rounded-lg text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                    <i data-lucide="maximize-2" class="w-5 h-5"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Thumbnails (Horizontal Scroll) -->
                        <div class="flex gap-3 overflow-x-auto pb-2 px-1 scrollbar-hide snap-x" id="details-thumbnail-container">
                            <!-- Thumbnails injected by JS -->
                        </div>

                        <!-- DESKTOP ONLY: AI Suggestions (Compact) - Under gallery -->
                        <div class="mt-8 border-t border-gray-200 dark:border-white/10 pt-6 hidden lg:block">
                            <div class="flex items-center gap-2 mb-4 px-1">
                                <div class="p-1.5 bg-[#ffcd00]/10 rounded-lg text-[#ffcd00]">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                </div>
                                <h2 class="text-base sm:text-lg font-bold text-gray-800 dark:text-gray-200">قد يعجبك أيضاً</h2>
                            </div>
                            
                            <div id="ai-suggestions-loading-desktop" class="hidden loading-dots justify-center py-4">
                                <div class="loading-dot w-1 h-1"></div><div class="loading-dot w-1 h-1"></div><div class="loading-dot w-1 h-1"></div>
                            </div>
                            
                            <!-- Unified Grid for Suggestions - Adjusted columns for the column width -->
                            <div id="ai-suggestions-grid-desktop" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                        </div>
                    </div>

                    <!-- Left Column: Info & Actions (5 cols) -->
                    <div class="lg:col-span-5 flex flex-col gap-6">
                        
                        <div class="bg-white dark:bg-[#2c2f38] rounded-[2rem] shadow-xl p-6 sm:p-8 border border-gray-100 dark:border-white/5 relative overflow-hidden">
                            <!-- Decorative Background Blob -->
                            <div class="absolute top-0 left-0 w-64 h-64 bg-[#ffcd00]/5 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>

                            <!-- Brand & Category Tags -->
                            <div class="flex flex-wrap items-center gap-3 mb-4 relative z-10">
                                <span id="details-product-company" class="hidden px-3 py-1 text-xs font-bold uppercase tracking-wider text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-white/10 rounded-lg"></span>
                                <span id="details-product-category" class="hidden px-3 py-1 text-xs font-bold text-[#997a00] dark:text-[#ffcd00] bg-[#ffcd00]/10 border border-[#ffcd00]/20 rounded-lg"></span>
                            </div>
                            
                            <!-- Title -->
                            <h1 id="details-product-name" class="text-3xl sm:text-4xl lg:text-5xl font-black mb-4 text-gray-900 dark:text-white leading-tight relative z-10">جاري التحميل...</h1>
                            
                            <!-- Rating -->
                            <div id="details-star-rating" class="flex items-center gap-1 text-[#ffcd00] text-lg mb-6"></div>
                            
                            <!-- Price Block -->
                            <div id="details-product-price" class="mb-8 p-4 rounded-2xl bg-gray-50 dark:bg-[#222] border border-gray-100 dark:border-white/5">
                                <!-- Price injected by JS -->
                            </div>

                            <!-- Key Features Grid (New) -->
                            <div id="details-key-features" class="grid grid-cols-2 gap-3 mb-8">
                                <!-- Features injected by JS -->
                            </div>
            
                            <!-- Color Options -->
                            <div id="details-color-options" class="mb-8 hidden">
                                <h3 class="text-sm font-bold mb-3 text-gray-900 dark:text-white flex items-center gap-2">
                                    <i data-lucide="palette" class="w-4 h-4 text-gray-400"></i>
                                    اختر اللون
                                </h3>
                                <div id="color-swatches-container" class="flex flex-wrap gap-3"></div>
                            </div>

                            <!-- Description (Short) -->
                            <div class="prose dark:prose-invert max-w-none mb-8">
                                <h3 class="text-sm font-bold mb-2 text-gray-900 dark:text-white">وصف مختصر</h3>
                                <p id="details-product-description" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed line-clamp-4 hover:line-clamp-none transition-all cursor-pointer">
                                    جاري تحميل الوصف...
                                </p>
                            </div>
            
                            <!-- Actions -->
                            <div id="details-add-to-cart-wrapper" class="space-y-4 pt-6 border-t border-gray-100 dark:border-white/10 product-card-wrapper"
                                 data-product-id=""
                                 data-product-name=""
                                 data-product-price=""
                                 data-product-image="">
                                <!-- Buttons injected by JS -->
                            </div>
                        </div>

                        <!-- Technical Specs & Reviews (Collapsible/Tabs) -->
                        <div class="bg-white dark:bg-[#2c2f38] rounded-[2rem] shadow-xl overflow-hidden border border-gray-100 dark:border-white/5">
                            <div class="flex border-b border-gray-200 dark:border-gray-700">
                                <button class="tab-btn active-tab flex-1 py-4 text-center font-bold text-gray-900 dark:text-white border-b-2 border-[#ffcd00] transition-colors hover:bg-gray-50 dark:hover:bg-white/5" data-tab="specs">
                                    المواصفات الفنية
                                </button>
                                <button class="tab-btn flex-1 py-4 text-center font-bold text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors hover:bg-gray-50 dark:hover:bg-white/5" data-tab="reviews">
                                    المراجعات (3)
                                </button>
                            </div>
                            
                            <div class="p-6 sm:p-8">
                                <!-- Specs Content -->
                                <div id="tab-content-specs" class="tab-content space-y-4">
                                    <ul id="specs-list-container" class="space-y-0 divide-y divide-gray-100 dark:divide-gray-700">
                                      <!-- Specs List -->
                                    </ul>
                                </div>
                            
                                <!-- Reviews Content -->
                                <div id="tab-content-reviews" class="tab-content hidden space-y-6">
                                    <!-- Reviews Static for now -->
                                    <div class="flex items-start gap-4">
                                        <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-lg font-bold">أ</div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-gray-900 dark:text-white">أحمد محمود</h4>
                                                <span class="text-xs text-gray-500">منذ أسبوع</span>
                                            </div>
                                            <div class="text-[#ffcd00] text-xs mb-2">★★★★☆</div>
                                            <p class="text-gray-600 dark:text-gray-300 text-sm">منتج ممتاز وجودة عالية.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-4">
                                        <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-lg font-bold">ف</div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-gray-900 dark:text-white">فاطمة علي</h4>
                                                <span class="text-xs text-gray-500">منذ شهر</span>
                                            </div>
                                            <div class="text-[#ffcd00] text-xs mb-2">★★★★★</div>
                                            <p class="text-gray-600 dark:text-gray-300 text-sm">أنصح به بشدة، التوصيل سريع.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              
                <!-- Old AI Suggestions Location Removed from here -->

            </section>
            
            <section id="page-about" class="page-section space-y-12 pt-8">
                <div class="relative bg-white dark:bg-[#2c2f38] rounded-xl shadow-lg overflow-hidden p-8 md:p-12 text-center">
                    <h1 class="text-4xl font-bold mb-4 text-[#ffcd00]">عن متجر مكة</h1>
                    <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
                        خبرة تمتد لأكثر من 20 عامًا في قلب المقطم، نقدم كل ما هو جديد في عالم الديكور الحديث والإضاءة.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="award" class="w-10 h-10 text-[#ffcd00] flex-shrink-0"></i>
                        <div>
                            <h3 class="text-lg font-semibold">خبرة موثوقة</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">أكثر من 20 عامًا في السوق.</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="shield-check" class="w-10 h-10 text-[#ffcd00] flex-shrink-0"></i>
                        <div>
                            <h3 class="text-lg font-semibold">جودة مضمونة</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">أفضل الماركات المضمونة.</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="truck" class="w-10 h-10 text-[#ffcd00] flex-shrink-0"></i>
                        <div>
                            <h3 class="text-lg font-semibold">توريد وتركيب</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">خدمات احترافية للمشاريع.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            <h2 class="text-3xl font-bold mb-4">قصتنا</h2>
                            <p class="text-base sm:text-lg text-gray-600 dark:text-gray-300 leading-relaxed">
                                "متجر مكة للأدوات الكهربائية هو وجهتك الأولى لكل احتياجاتك الكهربائية، نقدم لك منتجات عالية الجودة بأسعار منافسة. بخبرتنا الممتدة لسنوات في المجال، نوفر لك أفضل الأدوات والماركات المضمونة، لأن الثقة بالنسبة لنا ليست خيارًا، بل هي أساس عملنا."
                            </p>
                            <p class="text-base sm:text-lg text-gray-600 dark:text-gray-300 leading-relaxed">
                                نحن لا نبيع منتجات فحسب، بل نقدم حلولاً متكاملة تشمل التوريد والتركيب للمشاريع السكنية والتجارية، بفريق فني متخصص يضمن لك الأمان والجودة.
                            </p>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-4 lg:hidden">صور من المتجر</h2> <!-- Show title on mobile -->
                            <div class="grid grid-cols-2 gap-4">
                                <img src="https://i.postimg.cc/NfqhM3Th/photo-2025-10-28-14-04-33.jpg" onerror="this.src='https://placehold.co/600x400/555555/ffffff?text=المتجر+من+الداخل+1'" alt="المتجر من الداخل 1" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <img src="https://i.postimg.cc/bNjM8Qck/photo-2025-10-28-14-05-51.jpg" onerror="this.src='https://placehold.co/600x400/555555/ffffff?text=المتجر+من+الداخل+2'" alt="المتجر من الداخل 2" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <img src="https://wl-img-prd.s3-accelerate.amazonaws.com/940aa6b6-b49b-492b-8b88-a6680cb25b6c-h.jpeg" onerror="this.src='https://placehold.co/600x400/555555/ffffff?text=فريق+العمل'" alt="فريق العمل" class="w-full h-48 object-cover rounded-lg shadow-md col-span-2">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="page-blog" class="page-section pt-8">
                
                <!-- Modern Blog Hero -->
                <div class="relative rounded-[2.5rem] overflow-hidden bg-[#1a1a1a] text-white mb-12 shadow-2xl isolate">
                    <!-- Background Pattern -->
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <div class="absolute top-0 right-0 w-64 h-64 bg-[#ffcd00] rounded-full mix-blend-overlay filter blur-[80px] opacity-20 animate-pulse"></div>
                    
                    <div class="relative z-10 px-8 py-16 sm:px-12 text-center">
                        <div class="inline-flex items-center justify-center p-3 rounded-2xl bg-[#ffcd00]/10 border border-[#ffcd00]/20 mb-6 backdrop-blur-sm">
                            <i data-lucide="book-open" class="w-8 h-8 text-[#ffcd00]"></i>
                        </div>
                        <h1 class="text-4xl sm:text-6xl font-black mb-6 tracking-tight">
                            المدونة <span class="text-[#ffcd00]">المعرفية</span>
                        </h1>
                        <p class="text-gray-300 text-lg sm:text-xl max-w-2xl mx-auto leading-relaxed font-medium">
                            اكتشف أحدث النصائح في عالم الكهرباء، أفكار الديكور المبتكرة، وحلول الإضاءة الذكية. دليلك الشامل لبيت عصري وآمن.
                        </p>
                        
                        <!-- Admin Add Button (Moved Here) -->
                        <div class="mt-8 flex justify-center">
                            <button id="show-add-article-modal-btn" type="button" class="hidden group relative items-center gap-3 px-8 py-4 bg-[#ffcd00] text-gray-900 font-bold text-lg rounded-xl hover:bg-[#ffda33] transition-all duration-300 hover:-translate-y-1 shadow-[0_10px_20px_-10px_rgba(255,205,0,0.5)]">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                <span>إضافة مقالة جديدة</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Articles Grid -->
                <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Cards will be injected here via JS -->
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-center">
                        <div class="loading-dots">
                            <div class="loading-dot bg-gray-400"></div>
                            <div class="loading-dot bg-gray-400"></div>
                            <div class="loading-dot bg-gray-400"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="page-contact" class="page-section space-y-12 pt-8">
                
                <h1 class="text-3xl sm:text-4xl font-bold text-center mb-4">تواصل معنا</h1>
                <p class="text-xl text-gray-600 dark:text-gray-300 text-center max-w-2xl mx-auto">
                    نحن هنا لمساعدتك. سواء كان لديك سؤال عن منتج، أو تحتاج خدمة تركيب، فريقنا جاهز للرد.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg text-center transform transition-all duration-300 hover:-translate-y-1">
                        <i data-lucide="map-pin" class="w-12 h-12 text-[#ffcd00] mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">عنواننا</h3>
                        <p class="text-gray-600 dark:text-gray-300">
                            المقطم، شارع المدينة المنورة، متفرع من شارع 9، أمام مدرسة الراعي الصالح، قطعة 7987.
                        </p>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg text-center transform transition-all duration-300 hover:-translate-y-1">
                        <i data-lucide="phone" class="w-12 h-12 text-[#ffcd00] mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">اتصل بنا</h3>
                        <div class="text-gray-600 dark:text-gray-300" dir="ltr">
                            <a href="tel:0225071272" class="block hover:text-[#ffda33] transition-colors">0225071272 (هاتف المتجر)</a>
                            <a href="https://wa.me/201146641942" class="block hover:text-[#ffda33] transition-colors">01146641942 (واتساب)</a>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg text-center transform transition-all duration-300 hover:-translate-y-1">
                        <i data-lucide="clock" class="w-12 h-12 text-[#ffcd00] mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">ساعات العمل</h3>
                        <p class="text-gray-600 dark:text-gray-300">
                            السبت - الخميس
                            <br>
                            9:00 صباحاً - 11:00 مساءً
                        </p>
                    </div>
                </div>
                

                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg max-w-6xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <form id="contact-form" class="space-y-6">
                            <h3 class="text-2xl font-semibold mb-3">أرسل لنا رسالة</h3>
                            <div>
                                <label for="name" class="block text-sm font-medium mb-1">الاسم</label>
                                <input type="text" id="name" name="name" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="اسمك بالكامل">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium mb-1">رقم الهاتف</label>
                                <input type="tel" id="phone" name="phone" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="01xxxxxxxxx">
                            </div>
                            <div>
                                <label for="message" class="block text-sm font-medium mb-1">الرسالة</label>
                                <textarea id="message" name="message" rows="5" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="كيف يمكننا مساعدتك؟"></textarea>
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#ffda33] transition-colors">
                                إرسال الرسالة
                            </button>
                            <div id="form-success-message" class="hidden text-green-500 font-medium text-center">
                                تم إرسال رسالتك بنجاح!
                            </div>
                        </form>
                        
                        <div class="space-y-6">
                             <h3 class="text-2xl font-semibold mb-3">موقعنا على الخريطة</h3>
                            <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-md h-full min-h-[400px]">
                                <iframe 
                                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d55276.0159441113!2d31.27210741164801!3d30.00350917260086!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x1458380b09995129%3A0x6a05d34f0c476f0!2sMokattam%2C%2C%20Cairo%20Governorate%2C%20Egypt!5e0!3m2!1sen!2sus!4v1678886500000!5m2!1sen!2sus" 
                                    width="100%" 
                                    height="100%" 
                                    style="border:0;" 
                                    allowfullscreen="" 
                                    loading="lazy" 
                                    referrerpolicy="no-referrer-when-downgrade">
                                </iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="page-blog-post" class="page-section pt-0">
                <!-- استخدام هوامش سلبية لإلغاء هوامش الـ Main وجعل القسم يملأ الشاشة -->
                <div class="-mx-4 sm:-mx-6 lg:-mx-8 bg-white dark:bg-[#1a1a1a] min-h-screen">
                    
                    <!-- Full Width Hero Header -->
                    <div class="relative w-full h-[50vh] min-h-[400px]">
                        <img class="w-full h-full object-cover" 
                             id="blog-post-image"
                             src="https://placehold.co/1920x600/202124/ffcd00?text=جاري+التحميل" 
                             onerror="this.src='https://placehold.co/1920x600/202124/ffcd00?text=Image+Not+Found'" 
                             alt="صورة المقالة">
                        
                        <!-- Gradient Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-[#1a1a1a] via-[#1a1a1a]/60 to-transparent"></div>
                        
                        <!-- Floating Header Content -->
                        <div class="absolute bottom-0 right-0 w-full p-6 sm:p-10 lg:p-16">
                            <div class="max-w-7xl mx-auto w-full">
                                <a href="#blog" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-[#ffcd00] text-gray-900 font-bold hover:bg-[#ffda33] transition-transform hover:-translate-y-1 mb-6 shadow-lg shadow-black/20" data-page="blog">
                                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                                    <span>العودة للمدونة</span>
                                </a>
                                <h1 id="blog-post-title" class="text-3xl sm:text-5xl lg:text-6xl font-black text-white leading-tight drop-shadow-2xl">
                                    جاري التحميل...
                                </h1>
                            </div>
                        </div>
                    </div>

                    <!-- Content Body -->
                    <div class="px-6 sm:px-10 lg:px-16 py-12">
                        <div class="max-w-7xl mx-auto">
                            <div id="blog-post-content-wrapper" class="prose prose-lg sm:prose-xl dark:prose-invert max-w-none text-gray-800 dark:text-gray-200 leading-loose">
                                <p>جاري تحميل المحتوى...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
            
            <section id="page-blog-2" class="page-section hidden">
            </section>
            
            <section id="page-blog-3" class="page-section hidden">
            </section>
            
            <section id="page-blog-4" class="page-section hidden">
            </section>

            
            <section id="page-cart" class="page-section pt-8">
                
                <div class="flex items-center gap-3 mb-8">
                    <i data-lucide="shopping-cart" class="w-8 h-8 sm:w-10 sm:h-10 text-[#ffcd00]"></i>
                    <h1 class="text-3xl sm:text-4xl font-bold">سلة مشترياتك</h1>
                </div>
                
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg">
                    <div id="cart-items-container" class="space-y-6">
                        
                    </div>

                    <div id="cart-empty-message" class="text-center py-12 hidden">
                        <i data-lucide="shopping-cart" class="w-16 h-16 mx-auto text-gray-400"></i>
                        <h2 class="text-2xl font-semibold mt-4">سلّتك فارغة</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-2">يبدو أنك لم تقم بإضافة أي منتجات لسلتك بعد.</p>
                        <a href="#products" class="nav-link mt-6 inline-flex items-center gap-2 px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-lg hover:bg-[#ffda33]" data-page="products">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            <span>ابدأ التسوق</span>
                        </a>
                    </div>

                    <div id="cart-summary" class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6 hidden">
                        <div class="flex justify-end">
                            <div class="w-full md:w-1/3">
                                <div class="flex justify-between text-lg font-medium">
                                    <span>المجموع الفرعي:</span>
                                    <span id="cart-subtotal">0.00 EGP</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-2">
                                    <span>الشحن:</span>
                                    <span>يُحسب عند الدفع</span>
                                </div>
                                <div class="flex justify-between text-2xl font-bold mt-4">
                                    <span>الإجمالي:</span>
                                    <span id="cart-total">0.00 EGP</span>
                                </div>
                                <button id="whatsapp-checkout-btn" class="flex items-center justify-center gap-2 w-full px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-400 transition-colors mt-6">
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    <span>إتمام الطلب (عبر واتساب)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- NEW: Favorites Page Section -->
            <section id="page-favorites" class="page-section pt-8">
                <div class="flex items-center gap-3 mb-8">
                    <i data-lucide="heart" class="w-8 h-8 sm:w-10 sm:h-10 text-red-500"></i>
                    <h1 class="text-3xl sm:text-4xl font-bold">المفضلة</h1>
                </div>
                
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg min-h-[300px]">
                    <div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4 hidden">
                        <!-- Favorites will be populated here later -->
                    </div>
                    
                    <div id="no-favorites-message" class="text-center py-12">
                        <i data-lucide="heart-off" class="w-16 h-16 mx-auto text-gray-400"></i>
                        <h2 class="text-2xl font-semibold mt-4">قائمة المفضلة فارغة</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-2">لم تقم بإضافة أي منتجات للمفضلة بعد.</p>
                        <a href="#products" class="nav-link mt-6 inline-flex items-center gap-2 px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-lg hover:bg-[#ffda33]" data-page="products">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            <span>تصفح المنتجات</span>
                        </a>
                    </div>
                </div>
            </section>

          
            <section id="page-admin" class="page-section pt-8">
                <h1 class="text-3xl sm:text-4xl font-bold mb-8">لوحة التحكم</h1>
                
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="admin-settings-form" class="space-y-6">
                        
                        <!-- 0. Branding Settings (NEW) -->
                        <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                <i data-lucide="image" class="w-5 h-5 text-[#ffcd00]"></i>
                                إعدادات الهوية (الشعار)
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">رابط صورة الشعار (Logo URL)</label>
                                    <input type="url" id="admin-logo-url" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://...">
                                    <p class="text-xs text-gray-500 mt-1">اتركه فارغاً لاستخدام الشعار الافتراضي (أيقونة مكة).</p>
                                </div>
                                
                                <!-- New Logo Size Control -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">حجم الشعار (ارتفاع)</label>
                                    <div class="flex items-center gap-4">
                                        <input type="range" id="admin-logo-size" min="40" max="200" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-[#ffcd00]">
                                        <span id="admin-logo-size-display" class="text-sm font-bold w-16 text-center bg-white dark:bg-[#3d474e] px-2 py-1 rounded border border-gray-200 dark:border-gray-600">80px</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 1. Top Notification Bar Settings -->
                        <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                <i data-lucide="minus" class="w-5 h-5 text-[#ffcd00]"></i>
                                إعدادات الشريط العلوي (الشحن)
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">النص الرئيسي</label>
                                    <input type="text" id="admin-topbar-text" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="مثال: شحن مجاني للطلبات فوق">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">النص المميز (المبلغ)</label>
                                    <input type="text" id="admin-topbar-highlight" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="مثال: 5000 جنيه">
                                </div>
                                <div class="flex items-center gap-2 pt-2">
                                    <input type="checkbox" id="admin-topbar-visible" class="h-5 w-5 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded">
                                    <label for="admin-topbar-visible" class="text-sm font-medium">إظهار الشريط العلوي</label>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Hero Section Settings -->
                        <div class="bg-gray-50 dark:bg-white/5 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                <i data-lucide="layout-template" class="w-5 h-5 text-[#ffcd00]"></i>
                                إعدادات الواجهة الرئيسية (Hero)
                            </h2>
                            
                            <!-- NEW: Visibility Controls -->
                            <div class="mb-6 p-4 bg-white dark:bg-[#3d474e] rounded-lg border border-gray-200 dark:border-gray-600">
                                <label class="block text-sm font-bold mb-3 text-gray-900 dark:text-white">التحكم في العرض</label>
                                <div class="flex flex-col gap-4">
                                    <!-- Visibility Checkboxes -->
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="admin-hero-vis-mobile" class="h-5 w-5 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded cursor-pointer">
                                            <label for="admin-hero-vis-mobile" class="mr-3 text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">إظهار البانر على الهاتف (Mobile)</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="admin-hero-vis-desktop" class="h-5 w-5 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded cursor-pointer">
                                            <label for="admin-hero-vis-desktop" class="mr-3 text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer">إظهار البانر على الكمبيوتر (Desktop)</label>
                                        </div>
                                    </div>

                                    <hr class="border-gray-200 dark:border-gray-500">

                                    <!-- Height Sliders (Mobile & Desktop) -->
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">ارتفاع البانر (الهاتف)</label>
                                        <div class="flex items-center gap-4">
                                            <input type="range" id="admin-hero-height-mobile" min="200" max="600" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-[#ffcd00]">
                                            <span id="admin-hero-height-mobile-display" class="text-sm font-bold w-20 text-center bg-gray-100 dark:bg-[#2c2f38] px-2 py-1 rounded border border-gray-200 dark:border-gray-600">400px</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">ارتفاع البانر (الكمبيوتر)</label>
                                        <div class="flex items-center gap-4">
                                            <input type="range" id="admin-hero-height-desktop" min="300" max="900" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 accent-[#ffcd00]">
                                            <span id="admin-hero-height-desktop-display" class="text-sm font-bold w-20 text-center bg-gray-100 dark:bg-[#2c2f38] px-2 py-1 rounded border border-gray-200 dark:border-gray-600">500px</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">نوع الخلفية</label>
                                    <select id="admin-hero-type" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                                        <option value="image">صورة</option>
                                        <option value="video">فيديو</option>
                                    </select>
                                </div>

                                <div id="admin-image-url-container">
                                    <label class="block text-sm font-medium mb-1">رابط الصورة</label>
                                    <input type="url" id="admin-image-url" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://...">
                                </div>

                                <div id="admin-video-url-container" class="hidden">
                                    <label class="block text-sm font-medium mb-1">رابط الفيديو (MP4)</label>
                                    <input type="url" id="admin-video-url" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://...">
                                </div>

                                <hr class="border-gray-200 dark:border-gray-600 my-4">

                                <div>
                                    <label class="block text-sm font-medium mb-1">نص الشارة (Badge)</label>
                                    <input type="text" id="admin-hero-badge" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="مثال: الخيار الأول للمحترفين">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">العنوان الرئيسي</label>
                                    <input type="text" id="admin-hero-title" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="مثال: متجر مكة">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">العنوان الفرعي (الملون)</label>
                                    <input type="text" id="admin-hero-subtitle" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="مثال: عالم الكهرباء الحديثة">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الوصف</label>
                                    <textarea id="admin-hero-desc" rows="3" class="w-full px-4 py-2 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="وصف مختصر..."></textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="save-admin-settings-btn" class="w-full px-6 py-4 bg-[#ffcd00] text-gray-900 font-bold text-lg rounded-xl shadow-lg hover:bg-[#ffda33] transition-transform hover:-translate-y-1">
                            حفظ جميع الإعدادات
                        </button>
                    </form>

                    <!-- NEW: Sitemap Generator Section -->
                    <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="map" class="w-5 h-5 text-[#ffcd00]"></i>
                            أدوات مشرف الموقع (SEO)
                        </h2>
                        <div class="bg-gray-50 dark:bg-white/5 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                                يمكنك توليد خريطة الموقع (Sitemap.xml) التي تحتوي على روابط جميع المنتجات والمقالات الحالية لتقديمها لمحركات البحث.
                            </p>
                            <button type="button" id="generate-sitemap-btn" class="flex items-center justify-center gap-2 w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                <i data-lucide="file-code" class="w-5 h-5"></i>
                                <span>توليد خريطة الموقع (XML)</span>
                            </button>
                            
                            <div id="sitemap-result-container" class="hidden mt-6">
                                <label class="block text-sm font-bold mb-2 text-gray-900 dark:text-white">كود الخريطة (انسخ هذا المحتوى واحفظه في ملف sitemap.xml):</label>
                                <div class="relative">
                                    <textarea id="sitemap-output" rows="10" readonly class="w-full px-4 py-3 rounded-lg bg-gray-900 text-green-400 font-mono text-xs sm:text-sm border border-gray-700 focus:ring-2 focus:ring-blue-500 dir-ltr" style="direction: ltr;"></textarea>
                                    <button id="copy-sitemap-btn" class="absolute top-2 right-2 p-2 bg-white/10 hover:bg-white/20 text-white rounded-md transition-colors" title="نسخ الكود">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END NEW SECTION -->

                </div>
            </section>
           
            
            <!-- NEW: Terms of Use Page Section -->
            <section id="page-terms" class="page-section pt-8">
                <!-- Modern Header -->
                <div class="flex items-center gap-3 mb-8">
                    <i data-lucide="shield" class="w-8 h-8 sm:w-10 sm:h-10 text-[#ffcd00]"></i>
                    <h1 class="text-3xl sm:text-4xl font-bold">شروط الاستخدام وسياسة الخصوصية</h1>
                </div>

                <!-- Content Body -->
                <div class="text-gray-700 dark:text-gray-300 leading-relaxed space-y-6">
                    <!-- Constrain the text width for readability -->
                    <div class="prose prose-lg dark:prose-invert max-w-4xl text-right text-gray-700 dark:text-gray-300 leading-relaxed space-y-6">
                        <h2>مرحباً بك في متجر مكة</h2>
                        <p>باستخدامك لهذا الموقع، فإنك توافق على الالتزام بالشروط والأحكام التالية. يرجى قراءتها بعناية.</p>
                        
                        <h3>1. استخدام الموقع</h3>
                        <p>يجب استخدام هذا الموقع لأغراض مشروعة فقط. يُمنع استخدامه في أي نشاط قد يشكل انتهاكًا للقوانين المحلية أو الدولية.</p>
                        
                        <h3>2. المنتجات والأسعار</h3>
                        <p>نحن نسعى جاهدين لضمان دقة معلومات المنتجات والأسعار، ولكن قد تحدث أخطاء. نحتفظ بالحق في تصحيح أي أخطاء وتحديث المعلومات في أي وقت دون إشعار مسبق. جميع الأسعار بالجنيه المصري.</p>
                        
                        <h3>3. الطلبات</h3>
                        <p>تعتمد عملية إتمام الطلب على توفر المنتجات. حاليًا، يتم إتمام الطلبات وتأكيدها عبر التواصل المباشر (مثل واتساب) بعد إرسال الفاتورة المبدئية من الموقع.</p>

                        <h3>4. سياسة الخصوصية</h3>
                        <p>نحن نحترم خصوصيتك. المعلومات التي نجمعها (مثل عند استخدام "تسجيل الدخول بحساب جوجل") تُستخدم فقط لإدارة حسابك وتسهيل عملية الطلب. نحن لا نشارك بياناتك الشخصية مع أطراف ثالثة دون موافقتك.</p>

                        <h3>5. المساعد الذكي (AI)</h3>
                        <p>المساعد الذكي متوفر لتقديم معلومات عن المنتجات ونصائح عامة. المعلومات المقدمة من المساعد الذكي هي لأغراض إرشادية وقد لا تكون دقيقة بنسبة 100%. للحصول على تأكيد نهائي بخصوص المواصفات أو الأسعار، يرجى التواصل مع فريقنا مباشرة.</p>
                        
                        <h3>6. حقوق الملكية الفكرية</h3>
                        <p>جميع المحتويات على هذا الموقع، بما في ذلك النصوص، الرسومات، الشعارات، والصور، هي ملك لـ "متجر مكة" ومحمية بموجب قوانين حقوق النشر.</p>

                        <h3>7. طرق الدفع</h3>
                        <p>نحن نقبل حاليًا طرق الدفع التالية:</p>
                        
                        <!-- NEW: Modern Payment Methods Section -->
                        <div class="not-prose my-8 grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                            <!-- Cash -->
                            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-gray-200 dark:border-gray-700 min-h-[120px]">
                                <i data-lucide="wallet" class="w-10 h-10 text-green-600 dark:text-green-400 mb-2"></i>
                                <span class="text-sm font-semibold text-gray-800 dark:text-white">نقدي</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">عند الاستلام</span>
                            </div>
                            <!-- Vodafone Cash -->
                            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-gray-200 dark:border-gray-700 min-h-[120px]">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/a/a6/Vodafone_Cash_logo.svg" alt="Vodafone Cash" class="w-auto h-10 mb-2" onerror="this.style.display='none'">
                                <span class="text-sm font-semibold text-gray-800 dark:text-white">فودافون كاش</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">Vodafone Cash</span>
                            </div>
                            <!-- InstaPay -->
                            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-gray-200 dark:border-gray-700 min-h-[120px]">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/InstaPay_logo.svg/512px-InstaPay_logo.svg.png" alt="InstaPay" class="w-9 h-9 mb-2 rounded" onerror="this.style.display='none'">
                                <span class="text-sm font-semibold text-gray-800 dark:text-white">انستا باي</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">InstaPay</span>
                            </div>
                            <!-- Visa (Disabled) -->
                            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl flex flex-col items-center justify-center text-center border border-gray-200 dark:border-gray-700 min-h-[120px] opacity-60">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="w-auto h-7 mb-2" onerror="this.style.display='none'">
                                <span class="text-sm font-semibold text-gray-800 dark:text-white">فيزا</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">متوقفة مؤقتاً</span>
                            </div>
                        </div>
                        <!-- END: Modern Payment Methods Section -->


                        <h3>8. سياسة الإسترجاع وحماية المستهلك</h3>
                        <p>نحن نلتزم بقانون حماية المستهلك المصري. يحق للعملاء استرجاع المنتجات خلال 14 يومًا من تاريخ الشراء، بشرط أن يكون المنتج بحالته الأصلية ولم يتم استخدامه.</p>
                        <p>في حالة وجود أي شكوى أو للاستفسار عن حقوقك كمستهلك، يمكنك التواصل مباشرة مع جهاز حماية المستهلك:</p>
                        <ul>
                            <li><strong>الخط الساخن:</strong> 19588</li>
                            <li><strong>البريد الإلكتروني:</strong> info@cpa.gov.eg</li>
                            <li><strong>واتساب:</strong> 01577779999 - 01000000329</li>
                            <li><strong>العنوان:</strong> ش التسعين - التجمع الخامس - القاهرة</li>
                            <li><strong>أرقام التليفون:</strong> 33055796 - 33055795 - 33055768 - 33055797 - 33055762 - 33055765</li>
                            <li><strong>فاكس:</strong> 33055753</li>
                        </ul>
                    </div>
                </div>
            </section>
            
        </main>

        <footer class="bg-white dark:bg-[#2c2f38] border-t border-gray-200 dark:border-gray-700 mt-12">
            
            <div class="px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col lg:flex-row justify-between gap-10">
                    <div class="lg:w-2/5 text-center lg:text-right">
                        <a href="#home" class="nav-link inline-block" data-page="home">
                            <span class="text-2xl sm:text-3xl font-bold text-[#ffcd00]">متجر مكة</span>
                        </a>
                        <p class="mt-4 text-sm text-gray-600 dark:text-gray-300 max-w-sm mx-auto lg:mx-0">
                            متجر مكة: كل ما هو جديد في عالم الديكور الحديث والإضاءة. أكثر من 20 عامًا من الخبرة.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 lg:w-3/5">
                        <div class="text-center sm:text-right">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">معلومات</h3>
                            <ul class="space-y-3 text-sm">
                                <li>
                                    <a href="#terms" data-page="terms" class="nav-link inline-flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-[#ffcd00]">
                                        <i data-lucide="shield" class="w-4 h-4 text-[#ffcd00] flex-shrink-0"></i>
                                        <span>شروط الاستخدام</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" id="open-help-modal-btn" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-[#ffcd00]">
                                        <i data-lucide="help-circle" class="w-4 h-4 text-[#ffcd00] flex-shrink-0"></i>
                                        <span>مساعدة</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="text-center sm:text-right">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">اتصل بنا</h3>
                            <ul class="space-y-3 text-sm text-gray-600 dark:text-gray-300">
                                <li class="flex items-start gap-3 justify-center sm:justify-start">
                                    <i data-lucide="phone" class="w-4 h-4 text-[#ffcd00] flex-shrink-0 mt-1"></i>
                                    <a href="tel:0225071272" class="hover:text-[#ffda33]" dir="ltr">0225071272 (المتجر)</a>
                                </li>
                                <li class="flex items-start gap-3 justify-center sm:justify-start">
                                    <i data-lucide="smartphone" class="w-4 h-4 text-[#ffcd00] flex-shrink-0 mt-1"></i>
                                    <a href="https://wa.me/201146641942" class="hover:text-[#ffda33]" dir="ltr">01146641942 (واتساب)</a>
                                </li>
                                <li class="flex items-start gap-3 justify-center sm:justify-start">
                                    <i data-lucide="mail" class="w-4 h-4 text-[#ffcd00] flex-shrink-0 mt-1"></i>
                                    <a href="mailto:macaelctrec@gmail.com" class="hover:text-[#ffda33]">macaelctrec@gmail.com</a>
                                </li>
                            </ul>
                        </div>
                    
                    </div>
                </div>
                
                
                <div class="border-t border-gray-200 dark:border-gray-700 mt-8 pt-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center sm:text-right">
                            &copy; 2025 متجر مكة للأدوات الكهربائية. جميع الحقوق محفوظة.
                        </p>

                        <!-- Visitor Counter Removed from Footer -->

                        <div dir="ltr" class="text-center sm:text-left">
                            <div>
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Developed By</span>
                                <span class="block text-sm font-semibold text-gray-900 dark:text-white">Badr Ibrahim &amp; Mostafa Mahmoud</span>
                            </div>
                            <div class="flex items-center justify-center sm:justify-start gap-2 mt-2">
                                <a href="tel:01069913150" 
                                   class="group p-2 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full transition-all duration-300 hover:bg-[#ffcd00] hover:text-gray-900 hover:scale-110 hover:shadow-md"
                                   title="Call 01069913150">
                                    <i data-lucide="phone" class="w-4 h-4 transition-transform group-hover:rotate-12"></i>
                                    <span class="sr-only">Call</span> 
                                </a>
                                <a href="https://badre.site/" target="_blank" rel="noopener noreferrer" 
                                   class="group p-2 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full transition-all duration-300 hover:bg-[#ffcd00] hover:text-gray-900 hover:scale-110 hover:shadow-md"
                                   title="Visit Website">
                                    <i data-lucide="globe" class="w-4 h-4 transition-transform group-hover:rotate-12"></i>
                                    <span class="sr-only">Website</span> 
                                </a>
                                <a href="https://www.behance.net/bdremohameed" target="_blank" rel="noopener noreferrer" 
                                   class="group p-2 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full transition-all duration-300 hover:bg-[#1769ff] hover:text-white hover:scale-110 hover:shadow-md"
                                   title="Behance">
                                    <!-- Updated to a simple "B" icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 transition-transform group-hover:rotate-12">
                                        <path d="M3.5,20V4H10C10,4 10.56,4.1 11.33,4.4C12.1,4.7 12.76,5.16 13.33,5.79C13.89,6.42 14.17,7.17 14.17,8.04C14.17,8.81 13.92,9.53 13.42,10.19C12.92,10.85 12.15,11.38 11.13,11.77C12.36,12.09 13.33,12.69 14.04,13.56C14.75,14.43 15.1,15.44 15.1,16.58C15.1,17.67 14.78,18.58 14.15,19.31C13.5,20.04 12.7,20.56 11.73,20.88C10.76,21.19 9.89,21.33 9.13,21.33H3.5M8.35,11.21H9.65C10.41,11.21 11,11.03 11.42,10.67C11.83,10.3 12.04,9.8 12.04,9.17C12.04,8.61 11.88,8.15 11.54,7.81C11.2,7.47 10.73,7.31 10.13,7.31H8.35V11.21M8.35,18.33H10C10.68,18.33 11.24,18.15 11.65,17.77C12.06,17.39 12.27,16.88 12.27,16.21C12.27,15.5 12,14.96 11.56,14.56C11.1,14.17 10.5,13.96 9.71,13.96H8.35V18.33Z" />
                                    </svg>
                                    <span class="sr-only">Behance</span>
                                </a>
                                <a href="https://www.linkedin.com/in/bdremohameed/" target="_blank" rel="noopener noreferrer" 
                                   class="group p-2 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full transition-all duration-300 hover:bg-[#0a66c2] hover:text-white hover:scale-110 hover:shadow-md"
                                   title="LinkedIn">
                                    <i data-lucide="linkedin" class="w-4 h-4 transition-transform group-hover:rotate-12"></i>
                                    <span class="sr-only">LinkedIn</span> 
                                </a>
                                <a href="https://github.com/bdremohameed" target="_blank" rel="noopener noreferrer" 
                                   class="group p-2 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full transition-all duration-300 hover:bg-[#333] hover:text-white hover:scale-110 hover:shadow-md"
                                   title="GitHub">
                                    <i data-lucide="github" class="w-4 h-4 transition-transform group-hover:rotate-12"></i>
                                    <span class="sr-only">GitHub</span> 
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        
        <!-- Scroll to top button -->
        <button id="scroll-to-top-btn" class="fixed bottom-24 right-6 z-40 bg-[#ffcd00] text-gray-900 p-3 sm:p-4 rounded-full shadow-lg transform transition-all duration-300 opacity-0 translate-y-10 pointer-events-none hover:scale-110" aria-label="العودة للأعلى">
            <i data-lucide="arrow-up" class="w-6 h-6 sm:w-8 sm:h-8"></i>
        </button>

        <a href="https://wa.me/201146641942" target="_blank" rel="noopener noreferrer" 
           class="whatsapp-fab fixed bottom-6 right-6 z-40 bg-green-500 text-white p-3 sm:p-4 rounded-full shadow-lg transform transition-transform hover:scale-110">
            <span class="sr-only">تواصل معنا عبر واتساب</span>
            <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M12.04 20.13C10.59 20.13 9.17 19.74 7.96 19L7.6 18.78L4.47 19.65L5.37 16.62L5.13 16.26C4.33 14.98 3.86 13.48 3.86 11.91C3.86 7.39 7.54 3.71 12.04 3.71C16.54 3.71 20.22 7.39 20.22 11.91C20.22 16.43 16.54 20.13 12.04 20.13M17.47 14.3C17.18 14.16 15.91 13.54 15.65 13.45C15.4 13.35 15.21 13.3 15.03 13.59C14.84 13.88 14.31 14.5 14.17 14.64C14.02 14.79 13.88 14.84 13.59 14.7C13.3 14.55 12.42 14.26 11.39 13.3C10.59 12.55 10.05 11.64 9.85 11.35C9.66 11.06 9.76 10.95 9.88 10.83C9.99 10.71 10.13 10.53 10.27 10.38C10.42 10.24 10.47 10.12 10.61 9.88C10.76 9.63 10.66 9.42 10.57 9.22C10.47 9.03 9.93 7.76 9.73 7.27C9.54 6.78 9.34 6.83 9.19 6.82C9.05 6.81 8.86 6.81 8.67 6.81C8.49 6.81 8.19 6.91 7.94 7.15C7.69 7.4 7.11 7.93 7.11 9.1C7.11 10.27 7.97 11.39 8.11 11.53C8.26 11.68 9.93 14.19 12.39 15.2C13.01 15.48 13.51 15.62 13.9 15.74C14.51 15.9 15.03 15.86 15.43 15.81C15.89 15.75 16.96 15.14 17.21 14.85C17.46 14.56 17.46 14.36 17.41 14.3Z"></path></svg>
        </a>
        
    </div>

    
    <!-- Modal لإضافة/تعديل المنتج -->
    <div id="add-product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm p-4" style="animation: fadeIn 0.3s ease-out;">
        <div class="w-full max-w-3xl bg-white dark:bg-[#2c2f38] rounded-xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">إضافة منتج جديد</h2>
                <button id="close-add-product-modal-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="add-product-form" class="p-6 sm:p-8 space-y-6 overflow-y-auto bg-gray-50/50 dark:bg-[#2c2f38]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="productName" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">اسم المنتج</label>
                        <input type="text" id="productName" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productCategory" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">القسم</label>
                        <select id="productCategory" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                            <option value="Lighting">إضاءة</option>
                            <option value="Cables">كابلات</option>
                            <option value="Switches">مفاتيح</option>
                            <option value="Parts">قطع غيار</option>
                            <option value="Paints">دهانات</option>
                            <option value="Ironmongery">حدايد</option>
                            <option value="Showers">الدش</option>
                            <option value="Electronics">الكترونيات</option>
                            <option value="OpticalPanels">لوحات</option>
                            <option value="BuildingMaterials">مواد البناء</option>
                            <option value="Other">أخرى</option>
                        </select>
                    </div>
                </div>

                <!-- MODIFIED: Split Main Image into 3 Inputs -->
                <div class="space-y-4">
                    <div class="bg-gray-100 dark:bg-[#3d474e] p-4 rounded-xl border border-gray-200 dark:border-gray-600">
                        <label class="block text-sm font-bold mb-3 text-gray-900 dark:text-white border-b border-gray-300 dark:border-gray-500 pb-2">
                            تكوين صورة الغلاف الرئيسية <span class="text-red-500">*</span>
                        </label>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end" dir="ltr">
                            
                            <!-- 1. Base URL (Fixed) -->
                            <div class="sm:col-span-5">
                                <label for="imgBaseUrl" class="block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400 text-right">الرابط الأساسي (ثابت)</label>
                                <input type="text" id="imgBaseUrl" class="w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-[#2c2f38] border border-gray-300 dark:border-gray-500 focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white" placeholder="https://i.postimg.cc/" dir="ltr">
                            </div>

                            <!-- 2. Image Name -->
                            <div class="sm:col-span-5">
                                <label for="imgName" class="block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400 text-right">اسم الصورة / الكود</label>
                                <input type="text" id="imgName" required class="w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-[#2c2f38] border border-gray-300 dark:border-gray-500 focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white" placeholder="Ex: AbCdEf/image" dir="ltr">
                            </div>

                            <!-- 3. Extension -->
                            <div class="sm:col-span-2">
                                <label for="imgExtension" class="block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400 text-right">الصيغة</label>
                                <select id="imgExtension" class="w-full px-1 py-2 text-sm rounded-lg bg-white dark:bg-[#2c2f38] border border-gray-300 dark:border-gray-500 focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white" dir="ltr">
                                    <option value=".jpg">.jpg</option>
                                    <option value=".png">.png</option>
                                    <option value=".jpeg">.jpeg</option>
                                    <option value=".webp">.webp</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 text-right">سيتم دمج الخانات تلقائياً: الرابط + الاسم + الصيغة</p>
                    </div>
                    
                    <div>
                        <label for="productGalleryImages" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">صور المعرض الإضافية (روابط كاملة مفصولة بفاصلة)</label>
                        <textarea id="productGalleryImages" rows="2" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white" placeholder="https://...image2.jpg, https://...image3.png"></textarea>
                    </div>
                </div>
                <!-- END MODIFIED -->
                
                <div>
                    <label for="productDescription" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الوصف</label>
                    <textarea id="productDescription" rows="4" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="productPrice" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">السعر الحالي (EGP)</label>
                        <input type="number" id="productPrice" step="0.01" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div class="flex items-center pt-8">
                        <input type="checkbox" id="isOnSale" class="h-5 w-5 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded">
                        <label for="isOnSale" class="mr-3 text-base font-medium text-gray-900 dark:text-white">تفعيل عرض خصم؟</label>
                    </div>
                </div>

                <div id="original-price-container" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/30">
                    <div>
                        <label for="originalPrice" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">السعر الأصلي (قبل الخصم)</label>
                        <input type="number" id="originalPrice" step="0.01" class="w-full px-4 py-3 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="saleEndDate" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">تاريخ انتهاء العرض (اختياري)</label>
                        <input type="datetime-local" id="saleEndDate" class="w-full px-4 py-3 rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                        <p class="text-xs text-gray-500 mt-1">اتركه فارغاً ليكون العرض دائماً.</p>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-6 p-4 bg-gray-50 dark:bg-white/5 rounded-xl">
                    <div class="flex items-center">
                        <input type="checkbox" id="isBestSeller" class="h-5 w-5 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded">
                        <label for="isBestSeller" class="mr-3 text-sm font-medium text-gray-900 dark:text-white">منتج الأكثر مبيعاً (مميز)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="isAvailable" checked class="h-5 w-5 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded">
                        <label for="isAvailable" class="mr-3 text-sm font-medium text-gray-900 dark:text-white">متوفر بالمخزون</label>
                    </div>
                </div>

                <hr class="border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">مواصفات إضافية (اختياري)</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                    <div>
                        <label for="productCompany" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الشركة</label>
                        <input type="text" id="productCompany" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productVolts" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الجهد (Volts)</label>
                        <input type="text" id="productVolts" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productLength" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الطول (Meters)</label>
                        <input type="text" id="productLength" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productWarranty" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الضمان</label>
                        <input type="text" id="productWarranty" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productMadeIn" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">صنع في</label>
                        <input type="text" id="productMadeIn" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productModel" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">رقم الموديل</label>
                        <input type="text" id="productModel" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productLumens" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">اللومن (Lumens)</label>
                        <input type="text" id="productLumens" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productLifespan" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">العمر الإفتراضي</label>
                        <input type="text" id="productLifespan" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productCurrent" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">شدة السحب (Ampere)</label>
                        <input type="text" id="productCurrent" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productWatt" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الواط (Watt)</label>
                        <input type="text" id="productWatt" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productSizes" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">المقاسات المتاحة</label>
                        <input type="text" id="productSizes" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white" placeholder="مثال: S, M, L أو 100سم, 200سم">
                    </div>
                    <div>
                        <label for="productWeight" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الوزن (kg/g)</label>
                        <input type="text" id="productWeight" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="productSize" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">الأبعاد (cm)</label>
                        <input type="text" id="productSize" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-gray-900 dark:text-white" placeholder="مثال: 10x20x5">
                    </div>
                </div>

                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-900 dark:text-white">خيارات الألوان (تخصيص)</label>
                        <button type="button" id="add-color-variant-btn" class="text-xs flex items-center gap-1 px-2 py-1 bg-[#ffcd00]/20 text-[#ffcd00] hover:bg-[#ffcd00]/30 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3 h-3"></i> إضافة لون
                        </button>
                    </div>
                    <div id="color-variants-container" class="space-y-3">
                        <!-- Color rows will be added here by JS -->
                    </div>
                     <p class="text-xs text-gray-500 mt-2">اضغط على اللون لاختياره، ويمكنك إضافة رابط صورة تظهر عند اختيار العميل لهذا اللون.</p>
                </div>

            </form>
            <div class="flex justify-end items-center gap-4 p-6 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 bg-white dark:bg-[#2c2f38]">
                <button type="button" id="cancel-add-product-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                    إلغاء
                </button>
                <button type="submit" id="modal-submit-btn" form="add-product-form" class="px-6 py-2 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#ffda33]">
                    حفظ المنتج
                </button>
            </div>
        </div>
    </div>


    <!-- Modal لإضافة/تعديل المقالة (New Article Modal) - ADDED HERE -->
    <div id="add-article-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm p-4" style="animation: fadeIn 0.3s ease-out;">
        <div class="w-full max-w-4xl bg-white dark:bg-[#2c2f38] rounded-xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <h2 id="article-modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">إضافة مقالة جديدة</h2>
                <button id="close-add-article-modal-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 rounded-full transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="add-article-form" class="p-6 space-y-6 overflow-y-auto bg-gray-50/50 dark:bg-[#2c2f38]">
                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="articleTitle" class="block text-sm font-bold mb-2 text-gray-900 dark:text-white">عنوان المقالة</label>
                        <input type="text" id="articleTitle" required class="w-full px-4 py-3 rounded-xl bg-white dark:bg-[#3d474e] border border-gray-200 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-2 focus:ring-[#ffcd00]/20 transition-all text-gray-900 dark:text-white" placeholder="عنوان جذاب...">
                    </div>
                    <div>
                        <label for="articleImageUrl" class="block text-sm font-bold mb-2 text-gray-900 dark:text-white">صورة الغلاف (رابط)</label>
                        <input type="url" id="articleImageUrl" required class="w-full px-4 py-3 rounded-xl bg-white dark:bg-[#3d474e] border border-gray-200 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-2 focus:ring-[#ffcd00]/20 transition-all text-gray-900 dark:text-white" placeholder="https://...">
                    </div>
                </div>

                <hr class="border-gray-200 dark:border-gray-700">

                <!-- Dynamic Content Builder -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-lg font-bold text-gray-900 dark:text-white">محتوى المقالة</label>
                        <div class="flex gap-2">
                            <button type="button" id="add-paragraph-btn" class="flex items-center gap-2 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors text-sm font-bold">
                                <i data-lucide="align-left" class="w-4 h-4"></i>
                                <span>+ فقرة نصية</span>
                            </button>
                            <button type="button" id="add-gallery-btn" class="flex items-center gap-2 px-3 py-1.5 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors text-sm font-bold">
                                <i data-lucide="image" class="w-4 h-4"></i>
                                <span>+ معرض صور</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="article-paragraphs-container" class="space-y-4 min-h-[100px]">
                        <!-- Dynamic blocks will be added here via JS -->
                        <div class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl">
                            ابدأ بإضافة محتوى للمقالة من الأزرار أعلاه
                        </div>
                    </div>
                </div>
            </form>

            <div class="flex justify-end items-center gap-4 p-6 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 bg-white dark:bg-[#2c2f38]">
                <button type="button" id="cancel-add-article-btn" class="px-6 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    إلغاء
                </button>
                <button type="submit" id="article-modal-submit-btn" form="add-article-form" class="px-8 py-2.5 bg-[#ffcd00] text-gray-900 font-bold rounded-xl shadow-lg hover:bg-[#ffda33] hover:shadow-xl hover:-translate-y-0.5 transition-all">
                    نشر المقالة
                </button>
            </div>
        </div>
    </div>


    <!-- New Order Details Modal -->
    <div id="order-details-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm p-4" style="animation: fadeIn 0.3s ease-out;">
        <div class="w-full max-w-md bg-white dark:bg-[#2c2f38] rounded-xl shadow-2xl overflow-hidden m-4 flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="truck" class="w-5 h-5 text-[#ffcd00]"></i>
                    بيانات التوصيل
                </h2>
                <button id="close-order-modal-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="order-details-form" class="p-5 space-y-4 overflow-y-auto max-h-[70vh]">
                <div>
                    <label for="order-customer-name" class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">
                        الاسم بالكامل <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="order-customer-name" required 
                               class="w-full pl-4 pr-10 py-3 rounded-lg bg-gray-50 dark:bg-[#3d474e] border border-gray-200 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-2 focus:ring-[#ffcd00]/20 transition-all"
                               placeholder="">
                        <i data-lucide="user" class="w-5 h-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div>
                    <label for="order-customer-phone" class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">
                        رقم هاتف للتواصل <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input type="tel" id="order-customer-phone" required
                               class="w-full pl-4 pr-10 py-3 rounded-lg bg-gray-50 dark:bg-[#3d474e] border border-gray-200 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-2 focus:ring-[#ffcd00]/20 transition-all"
                               placeholder="" dir="ltr" style="text-align: right;">
                         <i data-lucide="phone" class="w-5 h-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <div>
                    <label for="order-customer-address" class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">
                        العنوان بالتفصيل <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <textarea id="order-customer-address" required rows="3" 
                                  class="w-full pl-4 pr-10 py-3 rounded-lg bg-gray-50 dark:bg-[#3d474e] border border-gray-200 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-2 focus:ring-[#ffcd00]/20 transition-all resize-none"
                                  placeholder=""></textarea>
                        <i data-lucide="map-pin" class="w-5 h-5 absolute right-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                 <div>
                    <label for="order-notes" class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-gray-300">
                        ملاحظات إضافية (اختياري)
                    </label>
                    <div class="relative">
                        <textarea id="order-notes" rows="2" 
                                  class="w-full pl-4 pr-10 py-3 rounded-lg bg-gray-50 dark:bg-[#3d474e] border border-gray-200 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-2 focus:ring-[#ffcd00]/20 transition-all resize-none"
                                  placeholder=""></textarea>
                        <i data-lucide="file-text" class="w-5 h-5 absolute right-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" id="cancel-order-btn" class="flex-1 py-3.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        إلغاء
                    </button>
                    <button type="submit" class="flex-[2] py-3.5 bg-[#25D366] hover:bg-[#128C7E] text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                        <span>تأكيد وإرسال للواتساب</span>
                        <i data-lucide="send-horizontal" class="w-5 h-5 transform -scale-x-100"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="gemini-help-modal" class="ai-modal-backdrop modal hidden fixed inset-0 z-50 flex items-end justify-end p-0 sm:p-4 bg-black/50 transition-opacity duration-300" data-state="closed">
        
        <div id="gemini-help-panel" class="w-full max-w-full sm:max-w-md max-h-[90vh] sm:max-h-[700px] flex flex-col transition-all duration-300 ease-out opacity-0 translate-y-6 rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden border bg-white/95 dark:bg-[#202124]/95 backdrop-blur-xl border-gray-200 dark:border-gray-700">
            
            <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <span class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full items-center justify-center bg-gradient-to-br from-[#ffcd00] to-[#ffb700]">
                        <i data-lucide="sparkles" class="w-6 h-6 text-gray-900"></i>
                    </span>
                    <div>
                        <h2 class="text-base font-semibold">المساعد الذكي</h2>
                        <p class="text-xs text-gray-500 dark:text-gray-400">اسألني عن المنتجات أو اطلب نصيحة</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button id="clear-chat-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="بدء محادثة جديدة">
                        <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
                    </button>
                    <button id="close-help-modal-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="إغلاق">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div id="chat-history" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col bg-white dark:bg-[#202124]">
                <div class="model-message self-start">
                    أهلاً بك في متجر مكة! كيف يمكنني مساعدتك اليوم؟
                </div>
                
                <div id="loading-indicator" class="hidden loading-dots self-start">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
         

            <form id="help-form" class="flex-shrink-0 p-4 border-t border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-[#202124]/70">
                <div class="relative flex items-center">
                    <input type="text" id="help-input" placeholder="ابحث عن منتج أو اطلب نصيحة..." class="w-full px-4 py-3 pr-12 rounded-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:border-[#ffcd00] focus:ring-[#ffcd00] transition-colors" style="padding-left: 52px;">
                    <button type="submit" class="absolute left-2 right-auto p-2.5 bg-[#ffcd00] text-gray-900 rounded-full hover:bg-[#ffda33] transition-colors shadow-sm disabled:opacity-50" style="left: 8px;">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            signOut,
            setPersistence,
            browserSessionPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query,
            Timestamp,
            deleteDoc, 
            doc,        
            updateDoc,
            setDoc,
            getDoc,
            increment  // Added increment here
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        
        const firebaseConfig = {
          apiKey: "AIzaSyBfslkMwWAmFXLPJ_aJZgSA7-59AhoOdUY",
          authDomain: "macaelctrec-f7795.firebaseapp.com",
          projectId: "macaelctrec-f7795",
          storageBucket: "macaelctrec-f7795.firebasestorage.app",
          messagingSenderId: "915102271751",
          appId: "1:915102271751:web:38cf552556f3cc5be15da2",
          measurementId: "G-231CS0RBZD"
        };

        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 
        const provider = new GoogleAuthProvider();
 
        setPersistence(auth, browserSessionPersistence);

        
        let allProducts = [];
        let allArticles = []; 
        let modalListenerAttached = false; 
        let articleModalListenerAttached = false; 
        let currentIsAdmin = false; 
        let preFilterType = 'all'; 
        let defaultProductsCheckDone = false; 
        // --- NEW: Flag to track initial load ---
        let isInitialLoadComplete = false;

        let aiChatHistory = [];
        const defaultSuggestions = [
            "ما هي أفضل العروض؟",
            "أبحث عن إضاءة ليد",
            "ما هي المنتجات الأكثر مبيعاً؟",
            "أحتاج مساعدة في اختيار كابل"
        ];
        
        let currentGalleryImages = [];
        let currentGalleryIndex = 0;
        // --- NEW: Track selected color on details page ---
        let currentSelectedColor = null;
        // -------------------------------------------------

        // --- NEW: Global Search Listener ---
        const globalSearchInput = document.getElementById('global-search-input');
        const productSearchInput = document.getElementById('product-search-input');
        const openHelpLink = document.getElementById('open-help-modal-link');
        
        // --- NEW: Hide Loader Function ---
        function hideGlobalLoader() {
            if (isInitialLoadComplete) return;
            
            const loader = document.getElementById('global-loader');
            const app = document.getElementById('app');
            const body = document.body;

            if (loader && app) {
                // Fade out loader
                loader.style.opacity = '0';
                // Fade in app
                app.style.opacity = '1';
                
                // Allow scrolling again
                body.classList.remove('overflow-hidden');

                // Remove loader from DOM after transition
                setTimeout(() => {
                    loader.style.display = 'none';
                    isInitialLoadComplete = true;
                }, 700);
            }
        }
        // --------------------------------

        if (globalSearchInput) {
            globalSearchInput.addEventListener('input', (e) => {
                const value = e.target.value;
                if (productSearchInput) productSearchInput.value = value; // Sync values
                
                // Trigger search logic if on products page
                if (document.getElementById('page-products').classList.contains('active')) {
                    preFilterType = 'all';
                    renderAllProductViews();
                } else if (value.length > 2) {
                    // Auto-redirect to products if searching
                    window.location.hash = '#products';
                    // Allow time for routing to switch before rendering
                    setTimeout(() => {
                        preFilterType = 'all';
                        renderAllProductViews();
                    }, 50);
                }
            });
            
            // Sync back from product page search to header search
            if (productSearchInput) {
                productSearchInput.addEventListener('input', (e) => {
                    globalSearchInput.value = e.target.value;
                });
            }
        }

        if (openHelpLink) {
            openHelpLink.addEventListener('click', (e) => {
                e.preventDefault();
                const helpModal = document.getElementById('gemini-help-modal');
                if (helpModal) {
                    helpModal.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        helpModal.dataset.state = 'open';
                    });
                }
            });
        }
        // -----------------------------------

        // --- NEW: Helper to check if offer is active ---
        function isOfferActive(product) {
            if (!product.isOnSale) return false;
            if (!product.saleEndDate) return true; // No end date = always active if on sale
            
            const now = new Date();
            // Handle both Firestore Timestamp and regular Date objects (just in case)
            const endDate = product.saleEndDate.toDate ? product.saleEndDate.toDate() : new Date(product.saleEndDate);
            return now < endDate;
        }

        function getRemainingTime(product) {
            if (!product.saleEndDate) return null;
            const now = new Date();
            const endDate = product.saleEndDate.toDate ? product.saleEndDate.toDate() : new Date(product.saleEndDate);
            const diff = endDate - now;

            if (diff <= 0) return null;

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days} يوم`;
            } else {
                return `${hours} ساعة`;
            }
        }
        // -----------------------------------------------

        // --- NEW: Function to add a color variant row in the modal ---
        function addColorVariantRow(color = '#000000', name = '', imageUrl = '') {
            const container = document.getElementById('color-variants-container');
            if (!container) return;

            const row = document.createElement('div');
            row.className = 'color-variant-row flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-gray-50 dark:bg-white/5 p-3 rounded-lg relative';
            
            row.innerHTML = `
                <div class="flex items-center gap-2 flex-shrink-0">
                    <input type="color" class="color-input h-10 w-10 p-1 rounded cursor-pointer bg-transparent" value="${color}">
                    <input type="text" class="color-name-input w-24 px-3 py-2 text-sm rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="اسم اللون" value="${name}">
                </div>
                <input type="url" class="color-image-input flex-grow w-full sm:w-auto px-3 py-2 text-sm rounded-lg bg-white dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="رابط صورة لهذا اللون (اختياري)" value="${imageUrl}">
                <button type="button" class="remove-color-btn p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/20 rounded-full flex-shrink-0">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            `;

            row.querySelector('.remove-color-btn').addEventListener('click', () => {
                row.remove();
            });

            container.appendChild(row);
            lucide.createIcons();
        }
        // ------------------------------------------------------------

        // بيانات آراء العملاء (33 عميل) - تم تحديثها لتشمل تنوع الخدمات
        const testimonialsData = [
            { name: "محمد أحمد", rating: 5, text: "اشتريت من عندهم دهانات جوتن، الألوان طلعت زي الكتالوج بالظبط، وفريقهم ساعدني اختار الدرجات المناسبة." },
            { name: "سارة علي", rating: 5, text: "خدمة تركيب الدش عندهم ممتازة، الفني جه في ميعاده وظبط الإشارة بسرعة واحترافية." },
            { name: "خالد حسن", rating: 5, text: "أسعار العدد الكهربائية (شنيور وصاروخ) عندهم أقل من السوق، والمنتجات أصلية بضمان." },
            { name: "منى إبراهيم", rating: 5, text: "جبت كل مفاتيح الكهرباء والبرايز لشقتي الجديدة من عندهم، تشكيلة كبيرة وموديلات شيك جداً." },
            { name: "يوسف محمود", rating: 5, text: "احتجت حدايد ومسامير لشغل في البيت، لقيت كل المقاسات اللي عايزها وبأسعار كويسة." },
            { name: "رانيا كمال", rating: 5, text: "الموقع سهل جداً في الطلب، طلبت لمبات ليد ووصلتني تاني يوم، تغليف ممتاز." },
            { name: "عمر فاروق", rating: 5, text: "فريق التركيبات الكهربائية عندهم فاهم شغله كويس، أسسوا لي كهرباء المحل بضمير." },
            { name: "ليلى عبد الرحمن", rating: 5, text: "متجر متكامل فعلاً، جبت الدهانات وأدوات النقاشة والكهرباء من مكان واحد ووفرت وقت ومجهود." },
            { name: "أحمد مصطفى", rating: 5, text: "اشتريت طبق دش 100 سم وعدسة، جودتهم عالية والإشارة قوية جداً." },
            { name: "هبة سعيد", rating: 5, text: "خدمة العملاء محترمة جداً، ردوا على كل استفساراتي بخصوص أنواع سلك السويدي الأصلي." },
            { name: "كريم عادل", rating: 5, text: "أسعار جملة فعلاً مش كلام، اشتريت كمية لمشروع صغير والفرق كان واضح." },
            { name: "نورهان جمال", rating: 5, text: "كنت محتاجة أغير لون أوضة الأطفال، نصحوني بنوع دهان قابل للغسيل وطلع تحفة." },
            { name: "حسام الدين", rating: 5, text: "اشتريت شنيور بوش أصلي من عندهم، شغال معايا زي الفل بقاله سنة." },
            { name: "مريم يوسف", rating: 5, text: "ركبوا لي كاميرات مراقبة في العمارة، شغل نظيف وسريع وسعرهم معقول جداً." },
            { name: "تامر نبيل", rating: 5, text: "كل لوازم الحدايد اللي دورت عليها بره وملقتهاش، لقيتها عندهم بسهولة." },
            { name: "دعاء حسن", rating: 5, text: "اللمبات الليد اللي اشتريتها من عندهم موفرة جداً في الكهرباء وإضاءتها قوية." },
            { name: "وائل سمير", rating: 5, text: "تعامل راقي ومصداقية في المواعيد، طلبت فني لتركيب نجف وجه في الميعاد بالظبط." },
            { name: "شروق محمد", rating: 5, text: "جبت من عندهم مشترك كهرباء أصلي يستحمل الأحمال العالية، ممتاز وأنصح بيه." },
            { name: "أسامة فتحي", rating: 5, text: "لو بتدور على عدة يدوية تعيش معاك، ده أنسب مكان، خامات محترمة جداً." },
            { name: "يارا السيد", rating: 5, text: "ساعدوني في اختيار أطباق الدش المناسبة للشبكة المركزية في العمارة." },
            { name: "محمود عبد الله", rating: 5, text: "دهانات سكيب اللي عندهم أصلية وتاريخ إنتاجها جديد، والنتيجة على الحيطة روعة." },
            { name: "إيمان فوزي", rating: 5, text: "المكان الوحيد في المقطم اللي أثق أشتري منه كابلات وأنا مطمنة إنها مش مضروبة." },
            { name: "زياد طارق", rating: 5, text: "خدمة ما بعد البيع ممتازة، كان في مشكلة بسيطة في جهاز ورجعته وبدلوه فوراً." },
            { name: "نادية كمال", rating: 5, text: "تشكيلة الأوكر والمقابض (الحدايد) عندهم شيك جداً وتناسب كل الأذواق." },
            { name: "هشام طلعت", rating: 5, text: "فني الدش اللي بعتوه محترف جداً، ظبط قنوات النايل سات والعرب سات في وقت قياسي." },
            { name: "أميرة سعيد", rating: 5, text: "اشتريت صاروخ ومجموعة أسطوانات قطع، أسعارهم ممتازة مقارنة بالمحلات التانية." },
            { name: "رامي وجدي", rating: 5, text: "طلبت طلبية دهانات كبيرة للموقع ووصلت في ميعادها بدون أي تأخير." },
            { name: "سلوى محمود", rating: 5, text: "إضاءات الليد بروفايل اللي ركبوها في الريسبشن غيرت شكل المكان تماماً." },
            { name: "أشرف زكي", rating: 5, text: "مؤسسة محترمة، عندهم ضمير في شغل التركيبات وبيستخدموا خامات أصلية." },
            { name: "غادة عادل", rating: 5, text: "كل إكسسوارات الدش من سلك ووصلات lnb موجودة عندهم بجودة عالية." },
            { name: "ماجد سامي", rating: 5, text: "اشتريت طقم مفكات وبنس، خامتهم ممتازة وبيستحملوا الشغل التقيل." },
            { name: "نهى كريم", rating: 5, text: "الألوان اللي خلطوها لي على الكمبيوتر طلعت بالظبط زي ما كنت عايزاها." },
            { name: "عماد الدين", rating: 5, text: "مكان واحد بيوفر عليك لف كتير، كهرباء، دهانات، حدايد، ودش.. شكراً ليكم." }
        ];

        function renderTestimonials() {
            const track = document.getElementById('testimonials-track');
            if (!track) return;

            let testimonialsHTML = '';
            testimonialsData.forEach(t => {
                testimonialsHTML += `
                    <div class="inline-block w-56 sm:w-80 p-3 sm:p-6 mx-1 sm:mx-2 bg-white dark:bg-[#2c2f38] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 whitespace-normal align-top">
                        <div class="flex items-center mb-2 sm:mb-4">
                            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center text-xs sm:text-lg font-bold text-gray-600 dark:text-gray-300 ml-2 sm:ml-3">
                                ${t.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="text-xs sm:text-base font-semibold text-gray-900 dark:text-white">${t.name}</h4>
                                <div class="text-[#ffcd00] text-[10px] sm:text-sm">★★★★★</div>
                            </div>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300 text-[10px] sm:text-sm leading-relaxed">
                            "${t.text}"
                        </p>
                    </div>
                `;
            });

            // تكرار المحتوى لضمان حركة سلسة ومستمرة (Infinite Loop)
            track.innerHTML = testimonialsHTML + testimonialsHTML; 
        }

        
        function generateShortId(length = 5) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        
        function showToast(message) {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }


        function updateGalleryView(index) {
            const mainImgEl = document.getElementById('main-product-image');
            const thumbnailContainer = document.getElementById('details-thumbnail-container');

            if (!mainImgEl || !thumbnailContainer || currentGalleryImages.length === 0) return;


            currentGalleryIndex = (index + currentGalleryImages.length) % currentGalleryImages.length;

            const newImageUrl = currentGalleryImages[currentGalleryIndex];
            

            mainImgEl.src = newImageUrl;

            const thumbnails = thumbnailContainer.querySelectorAll('img');
            thumbnails.forEach((img, i) => {
                img.classList.toggle('border-[#ffcd00]', i === currentGalleryIndex);
                img.classList.toggle('border-transparent', i !== currentGalleryIndex);
            });
        }

        
        const loginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('google-logout-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const loginBtnMobile = document.getElementById('google-login-btn-mobile');
        const logoutBtnMobile = document.getElementById('google-logout-btn-mobile');
        const userInfoMobile = document.getElementById('user-info-mobile');
        const userAvatarMobile = document.getElementById('user-avatar-mobile');
        const userNameMobile = document.getElementById('user-name-mobile');
        
        
        
        const signInWithGoogle = (e) => {
            e.preventDefault();
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    const email = user.email;

                    if (email === "macaelctrec@gmail.com") {
                        console.log('User signed in:', user.displayName);
                        showToast(`!أهلاً بك، ${user.displayName}`);
                    } else {
                        console.warn(`Unauthorized email attempt: ${email}`);
                        signOut(auth);
                        showToast('عذراً، هذا الحساب غير مصرح له بتسجيل الدخول.');
                    }

                }).catch((error) => {
                    console.error('Google Sign-In Error:', error.message);
                    showToast('فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.');
                });
        };
 
        
        const signOutGoogle = (e) => {
            e.preventDefault(); 
            signOut(auth).then(() => {
                console.log('User signed out.');
                showToast('You have been logged out.');
            }).catch((error) => {
                console.error('Sign Out Error:', error);
            });
        };
 
        
        if(loginBtn) loginBtn.addEventListener('click', signInWithGoogle);
        if(logoutBtnMobile) logoutBtnMobile.addEventListener('click', signOutGoogle);
        if(loginBtnMobile) loginBtnMobile.addEventListener('click', signInWithGoogle);
        if(logoutBtnMobile) logoutBtnMobile.addEventListener('click', signOutGoogle);
 

        const userAvatarBtn = document.getElementById('user-avatar-btn');
        const userDropdownMenu = document.getElementById('user-dropdown-menu');

        if (userAvatarBtn && userDropdownMenu) {
            userAvatarBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const state = userDropdownMenu.dataset.state === 'open' ? 'closed' : 'open';
                userDropdownMenu.dataset.state = state;
            });


            window.addEventListener('click', (e) => {
                if (userDropdownMenu.dataset.state === 'open') {
                    if (!userAvatarBtn.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                        userDropdownMenu.dataset.state = 'closed';
                    }
                }
            });
        }

 
        
        onAuthStateChanged(auth, (user) => {
            const isAdmin = user && user.email === "macaelctrec@gmail.com";
            currentIsAdmin = isAdmin; 
            

            const dropdownAdminLink = document.getElementById('dropdown-admin-link'); // +++ ADJUSTED THIS +++
 
            if (user) { 
                const photo = user.photoURL || 'https://placehold.co/32x32/eeeeee/777777?text=User';
                
                
                if(userInfo) userInfo.classList.remove('hidden');
                if(userInfo) userInfo.classList.add('flex');
                if(userAvatar) userAvatar.src = photo;
                
               
                // MODIFIED: Hide login button completely when logged in
                if(loginBtn) {
                    loginBtn.classList.add('hidden');
                    loginBtn.classList.remove('inline-flex');
                }
        

             
                if(userInfoMobile) userInfoMobile.classList.remove('hidden');
                if(userInfoMobile) userInfoMobile.classList.add('flex');
                if(userAvatarMobile) userAvatarMobile.src = photo;
                if(userNameMobile) userNameMobile.textContent = user.displayName;
                if(loginBtnMobile) loginBtnMobile.style.display = 'none';
 
               
                const dropdownLogout = document.getElementById('google-logout-btn-dropdown');
                if (dropdownLogout) {
                    if (!dropdownLogout.dataset.listenerAttached) {
                        dropdownLogout.addEventListener('click', signOutGoogle);
                        dropdownLogout.dataset.listenerAttached = 'true';
                    }
                }
                
                const dropdownAdmin = document.getElementById('dropdown-admin-link');
                if (dropdownAdmin) {
                    if (!dropdownAdmin.dataset.listenerAttached) {
                        dropdownAdmin.addEventListener('click', (e) => {
                            
                            userDropdownMenu.dataset.state = 'closed'; 
                        });
                        dropdownAdmin.dataset.listenerAttached = 'true';
                    }
                }
 
            } else { 
                
                if(userInfo) userInfo.classList.add('hidden');
                if(userInfo) userInfo.classList.remove('flex');
                if(userAvatar) userAvatar.src = '';


                // MODIFIED: Show login button when logged out
                if(loginBtn) {
                    loginBtn.classList.remove('hidden');
                    loginBtn.classList.add('inline-flex');
                }



                if(userInfoMobile) userInfoMobile.classList.add('hidden');
                if(userInfoMobile) userInfoMobile.classList.remove('flex');
                if(userAvatarMobile) userAvatarMobile.src = '';
                if(userNameMobile) userNameMobile.textContent = '';
                if(loginBtnMobile) loginBtnMobile.style.display = 'block';
            }

            
            const addProductBtn = document.getElementById('show-add-product-modal-btn');
            const addArticleBtn = document.getElementById('show-add-article-modal-btn'); // +++++ NEW +++++
            
            // --- NEW: Setup Color Variant Button Listener ---
            const addColorBtn = document.getElementById('add-color-variant-btn');
            if (addColorBtn && !addColorBtn.dataset.listenerAttached) {
                addColorBtn.addEventListener('click', () => addColorVariantRow());
                addColorBtn.dataset.listenerAttached = 'true';
            }
            // ------------------------------------------------

            if (isAdmin) {
                if(addProductBtn) {
                    addProductBtn.classList.remove('hidden');
                    addProductBtn.classList.add('inline-flex'); 

                    // FIX: Use simple dataset check instead of replaceChild to ensure stability
                    if (!addProductBtn.dataset.listenerAttached) {
                        addProductBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            console.log("Adding Product Clicked");
                            
                            const modalEl = document.getElementById('add-product-modal');
                            if (modalEl) {
                                resetModalToAddMode(); 
                                modalEl.classList.remove('hidden');
                                modalEl.style.display = 'flex';
                            } else {
                                console.error("Modal not found");
                            }
                        });
                        addProductBtn.dataset.listenerAttached = 'true';
                    }
                }


                if(addArticleBtn) {
                    addArticleBtn.classList.remove('hidden');
                    addArticleBtn.classList.add('inline-flex');

                    if (!articleModalListenerAttached) {
                        const articleModal = document.getElementById('add-article-modal');
                        if (articleModal) {
                            addArticleBtn.addEventListener('click', () => {
                                resetArticleModalToAddMode(); 
                                articleModal.classList.remove('hidden');
                            });
                            articleModalListenerAttached = true;
                        }
                    }
                }

  
                if(dropdownAdminLink) dropdownAdminLink.classList.remove('hidden'); // +++ ADJUSTED THIS +++
 
 
            } else {
                if(addProductBtn) {
                    addProductBtn.classList.add('hidden');
                    addProductBtn.classList.remove('inline-flex');
                }
                modalListenerAttached = false; 


                if(addArticleBtn) {
                    addArticleBtn.classList.add('hidden');
                    addArticleBtn.classList.remove('inline-flex');
                }
                articleModalListenerAttached = false;

               
                if(dropdownAdminLink) dropdownAdminLink.classList.add('hidden'); // +++ ADJUSTED THIS +++
 
            }
            
            renderAllProductViews(); 
            renderArticles(); 
            
            
            
            
            loadProducts(); 
            loadArticles(); 
            loadSiteConfig(); 
            renderTestimonials(); // استدعاء دالة عرض آراء العملاء
        });

            let cart = []; 
            const cartCountBadge = document.getElementById('cart-count-badge');
            const mobileCartCountBadge = document.getElementById('mobile-cart-count-badge');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            const cartSummary = document.getElementById('cart-summary');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const cartTotalEl = document.getElementById('cart-total');

            function addToCart(product, quantity = 1) {
                if (!product.id || !product.name || !product.price || !product.image) {
                    console.error('Invalid product data:', product);
                    return;
                }

                // --- MODIFIED: Create Unique Cart Item ID (handling color variants) ---
                product.cartItemId = product.selectedColor 
                    ? `${product.id}-${product.selectedColor.hex.replace('#', '')}` 
                    : product.id;

                const existingProduct = cart.find(item => item.cartItemId === product.cartItemId);
                if (existingProduct) {
                    existingProduct.quantity += quantity;
                } else {
                    cart.push({ ...product, quantity: quantity });
                }
                // ---------------------------------------------------------------------

                updateCartView();
                
                const toastMessage = quantity > 1 
                    ? `تمت إضافة ${quantity} x "${product.name}" إلى السلة!`
                    : `تمت إضافة "${product.name}" إلى السلة!`;
                showToast(toastMessage);
            }

            function updateCartView() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

                if (totalItems > 0) {
                    if (cartCountBadge) {
                        cartCountBadge.textContent = totalItems;
                        cartCountBadge.classList.remove('hidden');
                    }
                    if (mobileCartCountBadge) {
                        mobileCartCountBadge.textContent = totalItems;
                        mobileCartCountBadge.classList.remove('hidden');
                    }
                } else {
                    if (cartCountBadge) cartCountBadge.classList.add('hidden');
                    if (mobileCartCountBadge) mobileCartCountBadge.classList.add('hidden');
                }
                
                if (document.getElementById('page-cart').classList.contains('active')) {
                    renderCartPage();
                }
            }

            function renderCartPage() {
                if (!cartItemsContainer || !cartEmptyMessage || !cartSummary) return;

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '';
                    cartEmptyMessage.classList.remove('hidden');
                    cartSummary.classList.add('hidden');
                } else {
                    cartEmptyMessage.classList.add('hidden');
                    cartSummary.classList.remove('hidden');
                    
                    cartItemsContainer.innerHTML = cart.map(item => `
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 border-b border-gray-200 dark:border-gray-700" data-cart-item-id="${item.cartItemId}">
                            <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover rounded-lg">
                            <div class="flex-grow text-center sm:text-left">
                                <h3 class="text-lg font-semibold">${item.name}</h3>
                                ${item.selectedColor ? `
                                    <div class="flex items-center justify-center sm:justify-start gap-2 mt-1 text-sm text-gray-600 dark:text-gray-400">
                                        <span class="inline-block w-4 h-4 rounded-full border border-gray-300" style="background-color: ${item.selectedColor.hex};"></span>
                                        <span>${item.selectedColor.name || 'لون مخصص'}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center gap-2 sm:gap-4">
                                <input type="number" value="${item.quantity}" min="1" class="cart-item-quantity w-16 px-3 py-2 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" data-cart-item-id="${item.cartItemId}">
                                <p class="text-lg font-bold w-28 text-right">${(parseFloat(item.price) * item.quantity).toFixed(2)} EGP</p>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-400" data-cart-item-id="${item.cartItemId}" title="Remove item">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');

                    const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
                    cartSubtotalEl.textContent = `${subtotal.toFixed(2)} EGP`;
                    cartTotalEl.textContent = `${subtotal.toFixed(2)} EGP`; 

                    addCartItemListeners();
                }
                lucide.createIcons();
            }

            function addCartItemListeners() {
                document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.addEventListener('click', (e) => {
                        // --- MODIFIED to use cart-item-id ---
                        const cartItemId = e.currentTarget.dataset.cartItemId;
                        removeFromCart(cartItemId);
                    });
                });

                document.querySelectorAll('.cart-item-quantity').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    newInput.addEventListener('change', (e) => {
                        // --- MODIFIED to use cart-item-id ---
                        const cartItemId = e.currentTarget.dataset.cartItemId;
                        const newQuantity = parseInt(e.currentTarget.value, 10);
                        updateCartQuantity(cartItemId, newQuantity);
                    });
                });
            }

            function removeFromCart(cartItemId) {
                // --- MODIFIED to filter by cartItemId ---
                cart = cart.filter(item => item.cartItemId !== cartItemId);
                updateCartView();
                renderCartPage();
            }

            function updateCartQuantity(cartItemId, quantity) {
                if (quantity < 1) {
                    removeFromCart(cartItemId);
                    return;
                }
                // --- MODIFIED to find by cartItemId ---
                const product = cart.find(item => item.cartItemId === cartItemId);
                if (product) {
                    product.quantity = quantity;
                }
                updateCartView();
                renderCartPage();
            }

            // Updated generateWhatsAppInvoice to accept customer data
            function generateWhatsAppInvoice(customerData = null) {
                if (cart.length === 0) {
                    showToast("سلّتك فارغة.");
                    return;
                }

                const storePhone = "201146641942";
                const orderId = generateShortId(6).toUpperCase();
                const now = new Date();
                const dateStr = now.toLocaleDateString('ar-EG');
                const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

                let message = `👋 مرحباً متجر مكة، أود تأكيد طلب جديد:\n\n`;
                
                if (customerData) {
                    message += `👤 *بيانات العميل:*\n`;
                    message += `▪ الاسم: ${customerData.name}\n`;
                    message += `▪ الهاتف: ${customerData.phone}\n`;
                    message += `▪ العنوان: ${customerData.address}\n`;
                    if (customerData.notes) {
                        message += `📝 ملاحظات: ${customerData.notes}\n`;
                    }
                    message += `━━━━━━━━━━━━━━\n\n`;
                }

                message += `🧾 *فاتورة طلب مبدئية*\n`;
                message += `🔖 رقم المرجع: #${orderId}\n`;
                message += `📅 التاريخ: ${dateStr} - ${timeStr}\n`;
                message += `━━━━━━━━━━━━━━\n\n`;
                
                message += `📦 *المنتجات المطلوبة:*\n`;
                let subtotal = 0;
                cart.forEach((item, index) => {
                    const itemTotal = parseFloat(item.price) * item.quantity;
                    subtotal += itemTotal;
                    
                    // --- MODIFIED: Include color in invoice ---
                    const colorInfo = item.selectedColor ? ` (لون: ${item.selectedColor.name || 'مخصص'})` : '';
                    message += `${index + 1}️⃣ *${item.name}${colorInfo}*\n`;
                    // ------------------------------------------
                    message += `   ▪ الكمية: ${item.quantity}\n`;
                    message += `   ▪ سعر الوحدة: ${parseFloat(item.price).toFixed(2)} EGP\n`;
                    message += `   ▪ المجموع: ${itemTotal.toFixed(2)} EGP\n`;
                    if (index < cart.length - 1) {
                        message += `   --------------------\n`;
                    }
                });

                message += `\n━━━━━━━━━━━━━━\n`;
                message += `💰 *ملخص الدفع:*\n`;
                message += `▫ المجموع الفرعي: ${subtotal.toFixed(2)} EGP\n`;
                message += `🚚 الشحن: يتم تحديده عند التأكيد\n`;
                message += `📢 *الإجمالي النهائي: ${subtotal.toFixed(2)} EGP*\n`;
                message += `━━━━━━━━━━━━━━\n\n`;
                message += `📍 *يرجى مراجعة الطلب وتأكيده.*\n`;
                message += `شكراً لكم!`;
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://api.whatsapp.com/send?phone=${storePhone}&text=${encodedMessage}`;

                window.open(whatsappUrl, '_blank');
            }

            
            function setupAddToCartButtons() {
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    // FIX: Use strict comparison to avoid issues with 'false' string
                    if (btn.dataset.listenerAttached === 'true') return;
                    btn.dataset.listenerAttached = 'true';

                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const card = e.currentTarget.closest('.product-card-wrapper');
                        if (!card) return;

                        const product = {
                            id: card.dataset.productId,
                            name: card.dataset.productName,
                            price: card.dataset.productPrice,
                            image: card.dataset.productImage
                        };

                        // --- NEW: If on details page, attach selected color ---
                        if (card.id === 'details-add-to-cart-wrapper' && currentSelectedColor) {
                            product.selectedColor = currentSelectedColor;
                        }
                        // -----------------------------------------------------
                        
                        // Check availability before adding to cart (redundant safety check)
                        const isUnavailable = btn.classList.contains('disabled');
                        if (isUnavailable) {
                             showToast("عذراً، هذا المنتج غير متوفر حالياً.");
                             return;
                        }

                        let quantityToAdd = 1;
                        const quantityInput = card.querySelector('#details-quantity-input');
                        if (quantityInput) {
                            quantityToAdd = parseInt(quantityInput.value, 10) || 1;
                            if (quantityToAdd < 1) quantityToAdd = 1;
                        }

                        
                        addToCart(product, quantityToAdd);
                    });
                });
            }
            


            
            const modal = document.getElementById('add-product-modal');
            const modalTitle = document.getElementById('modal-title'); 
            const modalSubmitBtn = document.getElementById('modal-submit-btn'); 
            
            const closeModalBtn = document.getElementById('close-add-product-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-add-product-btn');
            const addProductForm = document.getElementById('add-product-form');
            const isOnSaleCheckbox = document.getElementById('isOnSale');
            const originalPriceContainer = document.getElementById('original-price-container');

            
            
            
            
            function resetModalToAddMode() {
                if(modalTitle) modalTitle.textContent = "إضافة منتج جديد";
                if(modalSubmitBtn) modalSubmitBtn.textContent = "حفظ المنتج";
                if(addProductForm) {
                    addProductForm.reset();
                    delete addProductForm.dataset.editingId; 
                }
                if(originalPriceContainer) originalPriceContainer.classList.add('hidden');
                // Ensure 'Available' is checked by default for new products
                const availCheck = document.getElementById('isAvailable');
                if(availCheck) availCheck.checked = true;
                
                // --- NEW: Restore Base URL from LocalStorage ---
                const savedBaseUrl = localStorage.getItem('admin_img_base_url');
                const baseInput = document.getElementById('imgBaseUrl');
                if (baseInput) {
                    baseInput.value = savedBaseUrl || 'https://i.postimg.cc/';
                }
                // -----------------------------------------------

                // --- NEW: Clear color variants container ---
                const colorContainer = document.getElementById('color-variants-container');
                if (colorContainer) colorContainer.innerHTML = '';
                // -------------------------------------------
            }

            // FIX: Ensure close buttons also reset the inline style
            if(closeModalBtn) closeModalBtn.addEventListener('click', () => {
                resetModalToAddMode(); 
                modal.classList.add('hidden');
                modal.style.display = ''; // Clear inline style
            });
            if(cancelModalBtn) cancelModalBtn.addEventListener('click', () => {
                resetModalToAddMode(); 
                modal.classList.add('hidden');
                modal.style.display = ''; // Clear inline style
            });
            
            if(isOnSaleCheckbox) isOnSaleCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    originalPriceContainer.classList.remove('hidden');
                } else {
                    originalPriceContainer.classList.add('hidden');
                }
            });
                if(addProductForm) addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const editingId = addProductForm.dataset.editingId; 

                // --- MODIFIED: Combine 3 Parts for Main Image ---
                const baseUrl = document.getElementById('imgBaseUrl').value.trim();
                const imgName = document.getElementById('imgName').value.trim();
                const imgExt = document.getElementById('imgExtension').value;
                
                // Save Base URL for next time
                if (baseUrl) {
                    localStorage.setItem('admin_img_base_url', baseUrl);
                }

                const mainImageUrl = (baseUrl && imgName) ? (baseUrl + imgName + imgExt) : '';
                // ------------------------------------------------

                const galleryImagesString = document.getElementById('productGalleryImages').value;
                
                const galleryUrls = galleryImagesString.split(',')       
                                                .map(url => url.trim())   
                                                .filter(url => url && url.length > 0); 
                
                // Construct the full array: [Main Image, ...Gallery Images]
                const finalImageUrls = [];
                if (mainImageUrl) {
                    finalImageUrls.push(mainImageUrl);
                }
                finalImageUrls.push(...galleryUrls);
                // ------------------------------------------------------

                // --- NEW: Collect Color Variants Data ---
                const colorVariants = [];
                document.querySelectorAll('.color-variant-row').forEach(row => {
                    const color = row.querySelector('.color-input').value;
                    const name = row.querySelector('.color-name-input').value.trim();
                    const image = row.querySelector('.color-image-input').value.trim();
                    if (color) {
                        colorVariants.push({ hex: color, name: name, imageUrl: image });
                    }
                });
                // ----------------------------------------

                const productData = { 
                    name: document.getElementById('productName').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    
                    imageUrls: finalImageUrls, // Used the combined array
                    category: document.getElementById('productCategory').value,
                    description: document.getElementById('productDescription').value,
                    isOnSale: document.getElementById('isOnSale').checked,
                    isBestSeller: document.getElementById('isBestSeller').checked,
                    isAvailable: document.getElementById('isAvailable').checked, // <-- NEW FIELD
                    originalPrice: document.getElementById('isOnSale').checked ? parseFloat(document.getElementById('originalPrice').value) : 0,
                    createdAt: Timestamp.now(),
                    // NEW: Sale End Date
                    saleEndDate: document.getElementById('saleEndDate').value ? Timestamp.fromDate(new Date(document.getElementById('saleEndDate').value)) : null,

                    
                    company: document.getElementById('productCompany').value,
                    volts: document.getElementById('productVolts').value,
                    length: document.getElementById('productLength').value,
                    warranty: document.getElementById('productWarranty').value,
                    madeIn: document.getElementById('productMadeIn').value,
                    model: document.getElementById('productModel').value,
                    lumens: document.getElementById('productLumens').value,
                    lifespan: document.getElementById('productLifespan').value,
                    currentIntensity: document.getElementById('productCurrent').value,
                    watt: document.getElementById('productWatt').value,
                    sizes: document.getElementById('productSizes').value,
                    // NEW: Add weight and size
                    weight: document.getElementById('productWeight').value,
                    size: document.getElementById('productSize').value,
                    // Removed old 'colors' string field, replaced with 'colorOptions' array
                    colorOptions: colorVariants 
                };
                try {
                    if (editingId) {
                        
                        const productRef = doc(db, "products", editingId);
                        await updateDoc(productRef, productData);
                        showToast("تم تحديث المنتج بنجاح!");
                    } else {
                        
                        productData.createdAt = Timestamp.now(); 
                        productData.shortId = generateShortId(5); 
                        await addDoc(collection(db, "products"), productData);
                        showToast("تمت إضافة المنتج بنجاح!");
                    }
                    
                    resetModalToAddMode(); 
                    modal.classList.add('hidden'); 
                    modal.style.display = ''; // Clear inline style after save
                    
                } catch (error) {
                    console.error("Error saving document: ", error);
                    showToast("خطأ في حفظ المنتج. راجع الكونسول.");
                }
            });


            const articleModal = document.getElementById('add-article-modal');
            const articleModalTitle = document.getElementById('article-modal-title');
            const articleModalSubmitBtn = document.getElementById('article-modal-submit-btn');
            const closeArticleModalBtn = document.getElementById('close-add-article-modal-btn');
            const cancelArticleModalBtn = document.getElementById('cancel-add-article-btn');
            const addArticleForm = document.getElementById('add-article-form');


            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, function(match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            }


            function createParagraphBlock(title = '', body = '') {
                const container = document.getElementById('article-paragraphs-container');
                if (!container) return;

                const block = document.createElement('div');

                block.className = 'content-block paragraph-block bg-gray-50 dark:bg-[#3d474e] p-3 rounded-lg border border-gray-200 dark:border-gray-600 relative';
                block.dataset.type = 'paragraph'; 
                
                    block.innerHTML = `
                    <button type="button" class="remove-block-btn absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 z-10" title="Remove block">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    <div>
                        <label class="block text-xs font-medium mb-1 flex items-center gap-2">
                            <span class="paragraph-number text-base font-bold text-gray-500 dark:text-gray-400">1.</span>
                            <span>عنوان الفقرة (اختياري)</span>
                        </label>
                        <input type="text" class="paragraph-title w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-gray-800 border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" value="${escapeHTML(title)}">
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs font-medium mb-1">محتوى الفقرة (اكتب كل نقطة في سطر مستقل)</label>
                        <textarea class="paragraph-body w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-gray-800 border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" rows="3">${escapeHTML(body)}</textarea>
                    </div>
                `;


                block.querySelector('.remove-block-btn').addEventListener('click', () => {
                    block.remove();
                    reNumberParagraphBlocks(); 
                });

                container.appendChild(block);
                lucide.createIcons();
            }


            function createGalleryBlock(images = []) {
                const container = document.getElementById('article-paragraphs-container');
                if (!container) return;

                const block = document.createElement('div');
                block.className = 'content-block gallery-block bg-gray-50 dark:bg-[#3d474e] p-3 rounded-lg border border-gray-200 dark:border-gray-600 relative';
                block.dataset.type = 'gallery'; 
                

                const imageUrls = images.join(', ');

                    block.innerHTML = `
                    <button type="button" class="remove-block-btn absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 z-10" title="Remove block">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    <div>
                        <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                            <i data-lucide="image" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                            <span>معرض الصور</span>
                        </label>
                        <textarea class="gallery-urls w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-gray-800 border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" rows="3" placeholder="الصق روابط الصور، مفصولة بفاصلة...">${escapeHTML(imageUrls)}</textarea>
                    </div>
                `;


                block.querySelector('.remove-block-btn').addEventListener('click', () => {
                    block.remove();

                });

                container.appendChild(block);
                lucide.createIcons();
            }


            const addParagraphBtn = document.getElementById('add-paragraph-btn');
            if (addParagraphBtn) {
                addParagraphBtn.addEventListener('click', () => {
                    createParagraphBlock(); 
                    reNumberParagraphBlocks();
                });
            }
            
            const addGalleryBtn = document.getElementById('add-gallery-btn');
            if (addGalleryBtn) {
                addGalleryBtn.addEventListener('click', () => {
                    createGalleryBlock(); 

                });
            }


            function reNumberParagraphBlocks() {
                const container = document.getElementById('article-paragraphs-container');
                if (!container) return;
                
                let paragraphCounter = 1;
                const blocks = container.querySelectorAll('.content-block');
                
                blocks.forEach((block) => {
                    
                    if (block.dataset.type === 'paragraph') {
                        const numSpan = block.querySelector('.paragraph-number');
                        if (numSpan) {
                            numSpan.textContent = `${paragraphCounter}.`;
                        }
                        paragraphCounter++;
                    }
                });
            }

            function resetArticleModalToAddMode() {
                if(articleModalTitle) articleModalTitle.textContent = "إضافة مقالة جديدة";
                if(articleModalSubmitBtn) articleModalSubmitBtn.textContent = "حفظ المقالة";
                if(addArticleForm) {
                    addArticleForm.reset();
                    delete addArticleForm.dataset.editingId;
                }
                
                
                const container = document.getElementById('article-paragraphs-container');
                if (container) {
                    container.innerHTML = '';
                }
                createParagraphBlock();
                reNumberParagraphBlocks();
                
            }

            if(closeArticleModalBtn) closeArticleModalBtn.addEventListener('click', () => {
                resetArticleModalToAddMode();
                if(articleModal) articleModal.classList.add('hidden');
            });
            if(cancelArticleModalBtn) cancelArticleModalBtn.addEventListener('click', () => {
                resetArticleModalToAddMode();
                if(articleModal) articleModal.classList.add('hidden');
            });

            // Terms Modal JavaScript (REMOVED)

            const helpModal = document.getElementById('gemini-help-modal');
            const openHelpBtn = document.getElementById('open-help-modal-btn');
            const closeHelpBtn = document.getElementById('close-help-modal-btn');

            if (openHelpBtn && helpModal) {
                openHelpBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    helpModal.classList.remove('hidden');
                    // Use requestAnimationFrame to ensure the class removal is processed 
                    // before setting data-state, allowing the transition to work.
                    requestAnimationFrame(() => {
                        helpModal.dataset.state = 'open';
                    });
                });
            }

            if (closeHelpBtn && helpModal) {
                closeHelpBtn.addEventListener('click', () => {
                    helpModal.dataset.state = 'closed';
                    // Wait for the transition to finish before hiding
                    setTimeout(() => {
                        helpModal.classList.add('hidden');
                    }, 300);
                });
            }

            const helpForm = document.getElementById('help-form');
            if (helpForm) {
                helpForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('help-input');
                    if (!input || !input.value.trim()) return;

                    const userText = input.value.trim();
                    input.value = ''; // مسح حقل الإدخال
                    
                    const chatHistoryEl = document.getElementById('chat-history');
                    const loadingIndicator = document.getElementById('loading-indicator');
                    
                    // 1. عرض رسالة المستخدم
                    const userMsg = document.createElement('div');
                    userMsg.className = 'user-message';
                    userMsg.textContent = userText;
                    chatHistoryEl.insertBefore(userMsg, loadingIndicator);
                    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

                    // 2. إظهار مؤشر التحميل
                    if (loadingIndicator) {
                        loadingIndicator.classList.remove('hidden');
                        loadingIndicator.classList.add('flex');
                    }
                    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;

                    // 3. تجهيز سياق المنتجات للذكاء الاصطناعي
                    const productsContext = allProducts.map(p => 
                        `- ${p.name} (${p.price} EGP) [${p.isAvailable !== false ? 'متوفر' : 'غير متوفر'}]`
                    ).join('\n');

                    const systemPrompt = `أنت مساعد مبيعات خبير لـ "متجر مكة للأدوات الكهربائية".
هدفنا مساعدة العملاء في العثور على المنتجات المناسبة من قائمتنا الحالية فقط:
${productsContext}

قواعد الرد:
- تحدث بلهجة ودودة ومحترفة (مصرية أو فصحى بسيطة).
- لا تقترح أبداً منتجات غير موجودة في القائمة أعلاه.
- إذا كان المنتج "غير متوفر"، أخبر العميل بذلك واقترح بديلاً مشابهاً "متوفر" إن وجد.
- اجعل ردودك قصيرة، مباشرة، ومفيدة. شجع العميل على الشراء بلطف.`;

                    // إضافة رسالة المستخدم للسجل
                    aiChatHistory.push({ role: "user", parts: [{ text: userText }] });

                    // 4. الاتصال بـ Gemini API
                    try {
                        // تنبيه هام: إذا كنت تستخدم هذا الكود خارج بيئة التطوير الحالية، يجب عليك وضع مفتاح API الخاص بك هنا.
                        // يمكنك الحصول عليه من: https://aistudio.google.com/app/apikey
                        const apiKey = "AIzaSyBPE9qC_o61aeUXq11youK0EH73fhMEmfI"; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                        
                        const payload = {
                            contents: aiChatHistory,
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.text();
                            console.error("AI API Error Details:", response.status, errorData);
                            throw new Error(`HTTP Error: ${response.status} - Check Console for details`);
                        }

                        const data = await response.json();
                        const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (aiResponseText) {
                            // 5. عرض رد المساعد
                            const aiMsg = document.createElement('div');
                            aiMsg.className = 'model-message';
                            // تحويل تنسيق markdown البسيط (تغميق النص) إلى HTML
                            aiMsg.innerHTML = aiResponseText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                            chatHistoryEl.insertBefore(aiMsg, loadingIndicator);
                            
                            // إضافة رد المساعد للسجل للمحادثة التالية
                            aiChatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                        }

                    } catch (error) {
                        console.error("Full AI Chat Error:", error);
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'model-message bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
                        errorMsg.textContent = "عذراً، حدث خطأ فني. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى قريباً.";
                        chatHistoryEl.insertBefore(errorMsg, loadingIndicator);
                        aiChatHistory.pop(); // إزالة آخر رسالة مستخدم لتجنب الأخطاء المتراكمة
                    } finally {
                        // 6. إخفاء مؤشر التحميل
                        if (loadingIndicator) {
                            loadingIndicator.classList.add('hidden');
                            loadingIndicator.classList.remove('flex');
                        }
                        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
                    }
                });
            }

            // تفعيل زر "محادثة جديدة" لمسح السجل
            const clearChatBtn = document.getElementById('clear-chat-btn');
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', () => {
                    aiChatHistory = [];
                    const chatHistoryEl = document.getElementById('chat-history');
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (chatHistoryEl && loadingIndicator) {
                        chatHistoryEl.innerHTML = `
                            <div class="model-message self-start">
                                أهلاً بك مجدداً في متجر مكة! كيف يمكنني مساعدتك في اختيار منتجاتك اليوم؟
                            </div>
                        `;
                        chatHistoryEl.appendChild(loadingIndicator);
                    }
                });
            }

            if(addArticleForm) addArticleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const editingId = addArticleForm.dataset.editingId;

                
                const contentArray = [];
                document.querySelectorAll('#article-paragraphs-container .content-block').forEach(block => {
                    const type = block.dataset.type;
                    
                    if (type === 'paragraph') {
                        const title = block.querySelector('.paragraph-title').value.trim();
                        const body = block.querySelector('.paragraph-body').value.trim();
                        
                        if (title || body) {
                            contentArray.push({ type: 'paragraph', title: title, body: body });
                        }
                    } else if (type === 'gallery') {
                        const urlsText = block.querySelector('.gallery-urls').value;
                        const images = urlsText.split(',')
                                            .map(url => url.trim())
                                            .filter(url => url.length > 0);
                        
                        if (images.length > 0) {
                            contentArray.push({ type: 'gallery', images: images });
                        }
                    }
                });
                

                const articleData = {
                    title: document.getElementById('articleTitle').value,
                    imageUrl: document.getElementById('articleImageUrl').value,
                    
                    content: contentArray,
                };

                try {
                    if (editingId) {
                        
                        const articleRef = doc(db, "articles", editingId);
                        await updateDoc(articleRef, articleData);
                        showToast("تم تحديث المقالة بنجاح!");
                    } else {
                        
                        articleData.createdAt = Timestamp.now();
                        articleData.shortId = generateShortId(5); 
                        await addDoc(collection(db, "articles"), articleData);
                        showToast("تمت إضافة المقالة بنجاح!");
                    }
                    resetArticleModalToAddMode();
                    if(articleModal) articleModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving article: ", error);
                    showToast("خطأ في حفظ المقالة. راجع الكونسول.");
                }
            });
            


            function renderProductCard(product) {
                
                
                const mainImg = (product.imageUrls && product.imageUrls[0]) ? product.imageUrls[0] : (product.imageUrl || 'https://placehold.co/400x400/eeeeee/777777?text=Image+Error');

                // MODIFIED: Use isOfferActive helper
                const offerActive = isOfferActive(product);

                // Badges Logic
                let badgesHTML = '';
                
                // 1. Sale / Offer Badge
                if (product.isAvailable !== false && offerActive) {
                    if (product.originalPrice && product.originalPrice > product.price) {
                        const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                        badgesHTML += `<div class="mb-1 px-2.5 py-1 bg-red-600 text-white text-[10px] font-bold rounded-full shadow-sm w-fit backdrop-blur-sm bg-opacity-90">خصم ${discountPercent}%</div>`;
                    } else {
                        badgesHTML += `<div class="mb-1 px-2.5 py-1 bg-red-600 text-white text-[10px] font-bold rounded-full shadow-sm w-fit backdrop-blur-sm bg-opacity-90">عرض</div>`;
                    }
                }

                // 2. Availability Badge
                // تم التعديل هنا: استخدام object-contain بدلاً من object-cover وإضافة p-2 لعمل هامش داخلي بسيط
                let imageClass = 'h-full w-full object-contain object-center transition-transform duration-700 ease-out group-hover:scale-110 p-2';
                let addToCartBtnState = '';
                let addToCartBtnTitle = 'إضافة للسلة';
                
                if (product.isAvailable === false) {
                    badgesHTML += `<div class="mb-1 px-2.5 py-1 bg-gray-800 text-white text-[10px] font-bold rounded-full shadow-sm w-fit backdrop-blur-sm bg-opacity-90">غير متوفر</div>`;
                    imageClass += ' grayscale opacity-70';
                    addToCartBtnState = 'opacity-50 cursor-not-allowed bg-gray-200 dark:bg-gray-700 text-gray-400 shadow-none pointer-events-none'; 
                    addToCartBtnTitle = 'غير متوفر حالياً';
                } else {
                    addToCartBtnState = 'bg-[#ffcd00] text-gray-900 shadow-lg shadow-[#ffcd00]/30 hover:bg-[#ffda33] hover:scale-110 active:scale-95';
                }

                // 3. Countdown Badge
                let countdownHTML = '';
                const remaining = getRemainingTime(product);
                if (remaining && product.isAvailable !== false && offerActive) {
                    countdownHTML = `
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3 pt-8 flex items-end justify-center pointer-events-none">
                            <div class="px-2 py-0.5 bg-[#ffcd00]/90 backdrop-blur-sm text-gray-900 text-[10px] font-bold rounded-full flex items-center gap-1 shadow-sm">
                                <i data-lucide="timer" class="w-3 h-3"></i>
                                <span>متبقي ${remaining}</span>
                            </div>
                        </div>`;
                }

                // Admin Buttons
                const deleteButtonHTML = currentIsAdmin
                    ? `<button class="delete-product-btn p-2 bg-white/90 text-red-600 rounded-full hover:bg-red-600 hover:text-white shadow-sm transition-colors" title="حذف المنتج" data-product-id="${product.id}">
                           <i data-lucide="trash-2" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                const editButtonHTML = currentIsAdmin
                    ? `<button class="edit-product-btn p-2 bg-white/90 text-blue-600 rounded-full hover:bg-blue-600 hover:text-white shadow-sm transition-colors" title="تعديل المنتج" data-product-id="${product.id}">
                           <i data-lucide="edit-3" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                const adminButtonsHTML = currentIsAdmin
                    ? `<div class="absolute top-2 right-2 z-30 flex flex-col gap-2">
                            ${editButtonHTML}
                            ${deleteButtonHTML}
                       </div>`
                    : '';

                return `
                <div class="product-card-wrapper group relative bg-white dark:bg-[#202124] rounded-[1.5rem] border border-gray-100 dark:border-white/5 overflow-hidden transition-all duration-300 hover:shadow-[0_8px_30px_rgb(0,0,0,0.12)] dark:hover:shadow-[0_8px_30px_rgb(0,0,0,0.3)] hover:-translate-y-1"
                     data-product-id="${product.id}"
                     data-product-name="${product.name}"
                     data-product-price="${product.price}"
                     data-product-image="${mainImg}">
                    
                    <!-- Image Section -->
                    <div class="relative h-48 sm:h-56 overflow-hidden bg-gray-50 dark:bg-white/5">
                        <!-- Badges Container -->
                        <div class="absolute top-3 left-3 z-20 flex flex-col items-start gap-1">
                            ${badgesHTML}
                        </div>
                        
                        ${adminButtonsHTML}

                        <a href="#product/${product.shortId || product.id}" class="product-details-link block h-full w-full" data-product-id="${product.id}">
                            <img class="${imageClass}" 
                                 src="${mainImg}" 
                                 onerror="this.src='https://placehold.co/400x400/eeeeee/777777?text=Image+Error'"
                                 alt="${product.name}"
                                 loading="lazy">
                        </a>
                        
                        ${countdownHTML}
                    </div>

                    <!-- Details Section -->
                    <div class="p-4 sm:p-5 flex flex-col flex-grow relative">
                        
                        <!-- Bestseller Crown (Floating on content edge) -->
                        ${product.isBestSeller ? `
                            <div class="absolute top-[-16px] right-4 w-10 h-10 bg-white dark:bg-[#2c2f38] rounded-full flex items-center justify-center shadow-md border-4 border-gray-50 dark:border-[#202124] z-10" title="الأكثر مبيعاً">
                                <i data-lucide="crown" class="w-5 h-5 text-[#ffcd00] fill-current"></i>
                            </div>
                        ` : ''}

                        <!-- Meta: Company & Rating -->
                        <div class="flex justify-between items-center mb-2">
                             <div class="flex items-center gap-1">
                                ${product.company ? `
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-white/5 px-2 py-0.5 rounded-md truncate max-w-[80px] sm:max-w-[100px]">${product.company}</span>
                                ` : '<span class="h-4"></span>'}
                             </div>
                             <div class="text-[#ffcd00] text-xs flex gap-0.5">
                                 ${generateStarRating()}
                             </div>
                        </div>

                        <!-- Title -->
                        <a href="#product/${product.shortId || product.id}" class="product-details-link block mb-1" data-product-id="${product.id}">
                            <h3 class="text-base sm:text-lg font-bold text-gray-900 dark:text-white leading-relaxed line-clamp-2 group-hover:text-[#ffcd00] transition-colors h-[3.5rem]" title="${product.name}">
                                ${product.name}
                            </h3>
                        </a>

                        <!-- Price and Action -->
                        <div class="mt-auto pt-4 flex items-end justify-between gap-2 border-t border-dashed border-gray-200 dark:border-white/10">
                            
                            <div class="flex flex-col">
                                ${offerActive && product.isAvailable !== false ? 
                                    `<span class="text-xs text-gray-400 line-through mb-0.5 font-medium">${product.originalPrice.toFixed(2)}</span>
                                     <div class="flex items-baseline gap-1">
                                        <span class="text-xl sm:text-2xl font-black text-red-600 dark:text-red-500">${product.price.toFixed(0)}<span class="text-sm align-top">.${(product.price % 1).toFixed(2).substring(2)}</span></span>
                                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400">ج.م</span>
                                     </div>` 
                                    : 
                                    `<span class="text-xs text-transparent select-none mb-0.5">.</span>
                                     <div class="flex items-baseline gap-1">
                                        <span class="text-xl sm:text-2xl font-black text-gray-900 dark:text-white">${product.price.toFixed(0)}<span class="text-sm align-top">.${(product.price % 1).toFixed(2).substring(2)}</span></span>
                                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400">ج.م</span>
                                     </div>`
                                }
                            </div>

                            <button class="add-to-cart-btn h-10 w-10 sm:h-12 sm:w-12 rounded-full flex items-center justify-center transition-all duration-300 ${addToCartBtnState}" title="${addToCartBtnTitle}">
                                ${product.isAvailable !== false ? `<i data-lucide="shopping-cart" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-900 fill-current"></i>` : `<i data-lucide="bell-off" class="w-5 h-5 text-gray-400"></i>`}
                            </button>
                        </div>

                    </div>
                </div>`;
            }

            
            function generateStarRating() {
                
                const rating = Math.floor(Math.random() * 3) + 3;
                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) {
                        starsHTML += '<span>★</span>';
                    } else {
                        starsHTML += '<span class="text-gray-300 dark:text-gray-600">☆</span>';
                    }
                }
                return starsHTML;
            }
            

            function renderAllProductViews() {
                // ... (existing code)
                // We might want to call renderOffersPage here too if data changes, 
                // but showPage handles it on navigation.
                if (document.getElementById('page-offers').classList.contains('active')) {
                    renderOffersPage();
                }

                const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
                const category = document.getElementById('product-category-filter').value;
                const brand = document.getElementById('product-brand-filter').value;
                const sort = document.getElementById('product-sort-filter').value;
                
                // --- NEW: Get Price Range Values ---
                const minPrice = parseFloat(document.getElementById('product-min-price').value) || 0;
                const maxPrice = parseFloat(document.getElementById('product-max-price').value) || Infinity;
                // -----------------------------------

                
                let filteredProducts = allProducts;

                
                if (preFilterType === 'sale') {
                    filteredProducts = allProducts.filter(p => p.isOnSale);
                } else if (preFilterType === 'bestseller') {
                    filteredProducts = allProducts.filter(p => p.isBestSeller);
                }
                

                
                // MODIFIED: Search in name AND company
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.company && p.company.toLowerCase().includes(searchTerm)) // NEW
                );

                if (category !== 'all') {
                    filteredProducts = filteredProducts.filter(p => p.category === category);
                }

                // NEW: Filter by brand
                if (brand !== 'all') {
                    filteredProducts = filteredProducts.filter(p => p.company === brand);
                }
                
                // --- NEW: Filter by Price Range ---
                filteredProducts = filteredProducts.filter(p => p.price >= minPrice && p.price <= maxPrice);
                // ----------------------------------

                
                if (sort === 'price-asc') {
                    filteredProducts.sort((a, b) => a.price - b.price);
                } else if (sort === 'price-desc') {
                    filteredProducts.sort((a, b) => b.price - a.price);
                }

                const offersGrid = document.getElementById('home-offers-grid');
                const bestsellersGrid = document.getElementById('home-bestsellers-grid');
                const productsGrid = document.getElementById('products-grid');
                const noProductsMessage = document.getElementById('no-products-message');
                // NEW: Get the top offers grid element
                const topOffersSection = document.getElementById('current-offers-section');
                const topOffersGrid = document.getElementById('top-offers-grid');
                
                // NEW: Get Home Page Slider Sections to toggle visibility
                const homeOffersSection = document.getElementById('home-offers-section');
                const homeBestsellersSection = document.getElementById('home-bestsellers-section');

                if (!offersGrid || !bestsellersGrid || !productsGrid) return;

                
                offersGrid.innerHTML = '';
                bestsellersGrid.innerHTML = '';
                productsGrid.innerHTML = '';
                if (topOffersGrid) topOffersGrid.innerHTML = ''; // Clear top offers grid

                // Filter out unavailable products from Offers/Bestsellers on Home Page? 
                // Maybe keep them but they will show as unavailable. Let's keep them for now so people see them even if out of stock.
                const offers = allProducts.filter(p => isOfferActive(p)); // MODIFIED: Use isOfferActive
                const bestsellers = allProducts.filter(p => p.isBestSeller).slice(0, 6); 

                // NEW: Populate Top Offers Section
                if (topOffersSection && topOffersGrid) {
                    if (offers.length > 0) {
                        offers.forEach(p => topOffersGrid.innerHTML += renderProductCard(p));
                        // Only show this section on 'home' page
                        if (document.getElementById('page-home').classList.contains('active')) {
                             topOffersSection.classList.remove('hidden');
                        } else {
                             topOffersSection.classList.add('hidden');
                        }
                    } else {
                        topOffersSection.classList.add('hidden');
                    }
                }

                // --- MODIFIED: Handle Home Offers Slider Visibility ---
                if (homeOffersSection) {
                    const limitedOffers = offers.slice(0, 6);
                    if (limitedOffers.length > 0) {
                        limitedOffers.forEach(p => offersGrid.innerHTML += renderProductCard(p));
                        homeOffersSection.classList.remove('hidden');
                    } else {
                        homeOffersSection.classList.add('hidden');
                    }
                }
                
                // --- MODIFIED: Handle Home Bestsellers Slider Visibility ---
                if (homeBestsellersSection) {
                    if (bestsellers.length > 0) {
                        bestsellers.forEach(p => bestsellersGrid.innerHTML += renderProductCard(p));
                        homeBestsellersSection.classList.remove('hidden');
                    } else {
                        homeBestsellersSection.classList.add('hidden');
                    }
                }
                // -----------------------------------------------------
                
                if (filteredProducts.length === 0) {
                    productsGrid.innerHTML = ''; 
                    productsGrid.classList.add('hidden'); 
                    noProductsMessage.classList.remove('hidden');
                } else {
                    noProductsMessage.classList.add('hidden');
                    productsGrid.classList.remove('hidden'); 
                    productsGrid.innerHTML = ''; 
                    filteredProducts.forEach(p => productsGrid.innerHTML += renderProductCard(p));
                }

                
                setupAddToCartButtons();
                setupDeleteProductButtons(); 
                setupEditProductButtons(); 
                // setupProductDetailsLinks(); // No longer needed, router handles this
                
                // --- NEW: Setup Slider Buttons Logic ---
                setupSliderButtons('home-offers-grid', 'slider-prev-offers', 'slider-next-offers');
                setupSliderButtons('home-bestsellers-grid', 'slider-prev-bestsellers', 'slider-next-bestsellers');
                // ---------------------------------------

                lucide.createIcons();
            }

            // --- NEW: Generic Slider Scroll Function with Mouse Drag ---
            function setupSliderButtons(containerId, prevBtnId, nextBtnId) {
                const container = document.getElementById(containerId);
                const prevBtn = document.getElementById(prevBtnId);
                const nextBtn = document.getElementById(nextBtnId);

                if (!container) return; // Exit if container doesn't exist

                // 1. Enable Mouse Dragging (Click and Drag) - mimics touch on desktop
                let isDown = false;
                let startX;
                let scrollLeft;

                container.addEventListener('mousedown', (e) => {
                    isDown = true;
                    container.classList.add('active');
                    // Disable smooth scroll temporarily for direct movement
                    container.style.scrollBehavior = 'auto'; 
                    startX = e.pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                });

                container.addEventListener('mouseleave', () => {
                    isDown = false;
                    container.classList.remove('active');
                    container.style.scrollBehavior = 'smooth';
                });

                container.addEventListener('mouseup', () => {
                    isDown = false;
                    container.classList.remove('active');
                    container.style.scrollBehavior = 'smooth';
                });

                container.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault(); // Stop text selection
                    const x = e.pageX - container.offsetLeft;
                    const walk = (x - startX) * 2; // Scroll speed multiplier
                    container.scrollLeft = scrollLeft - walk;
                });

                // 2. Setup Button Click Listeners (if buttons exist)
                if (prevBtn && nextBtn) {
                    // Remove old listeners if any (by cloning)
                    const newPrev = prevBtn.cloneNode(true);
                    prevBtn.parentNode.replaceChild(newPrev, prevBtn);
                    
                    const newNext = nextBtn.cloneNode(true);
                    nextBtn.parentNode.replaceChild(newNext, nextBtn);

                    // Scroll Amount (approx one card width + gap)
                    const scrollAmount = 300; 

                    newPrev.addEventListener('click', () => {
                        container.scrollBy({ left: 300, behavior: 'smooth' }); 
                    });

                    newNext.addEventListener('click', () => {
                        container.scrollBy({ left: -300, behavior: 'smooth' }); 
                    });
                }
            }
            // -------------------------------------------

            // NEW: Function to render dedicated offers page
            function renderOffersPage() {
                const grid = document.getElementById('offers-page-grid');
                const noOffersMsg = document.getElementById('no-offers-message');
                const avgTimerEl = document.getElementById('average-offer-timer');
                
                // New Timer Elements
                const daysEl = document.getElementById('offer-timer-days');
                const hoursEl = document.getElementById('offer-timer-hours');
                const minutesEl = document.getElementById('offer-timer-minutes');

                if (!grid || !noOffersMsg) return;

                grid.innerHTML = '';
                // Filter ONLY available products that are ON ACTIVE SALE
                const offers = allProducts.filter(p => isOfferActive(p) && p.isAvailable !== false);

                // --- NEW: Calculate Average End Date ---
                if (avgTimerEl && daysEl && hoursEl && minutesEl) {
                    const offersWithEndDate = offers.filter(p => p.saleEndDate);
                    if (offersWithEndDate.length > 0) {
                        const totalMs = offersWithEndDate.reduce((sum, p) => {
                             const endDate = p.saleEndDate.toDate ? p.saleEndDate.toDate() : new Date(p.saleEndDate);
                             return sum + endDate.getTime();
                        }, 0);
                        const avgMs = totalMs / offersWithEndDate.length;
                        const now = new Date().getTime();
                        const diff = avgMs - now;

                        if (diff > 0) {
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            
                            // Update individual boxes
                            daysEl.textContent = String(days).padStart(2, '0');
                            hoursEl.textContent = String(hours).padStart(2, '0');
                            minutesEl.textContent = String(minutes).padStart(2, '0');

                            avgTimerEl.classList.remove('hidden');
                            avgTimerEl.classList.add('flex'); // Ensure flex display
                        } else {
                             avgTimerEl.classList.add('hidden');
                             avgTimerEl.classList.remove('flex');
                        }
                    } else {
                        avgTimerEl.classList.add('hidden');
                        avgTimerEl.classList.remove('flex');
                    }
                }
                // ---------------------------------------

                if (offers.length === 0) {
                    grid.classList.add('hidden');
                    noOffersMsg.classList.remove('hidden');
                } else {
                    noOffersMsg.classList.add('hidden');
                    grid.classList.remove('hidden');
                    offers.forEach(p => {
                        grid.innerHTML += renderProductCard(p);
                    });
                }
                setupAddToCartButtons();
                setupDeleteProductButtons();
                setupEditProductButtons();
                lucide.createIcons();
            }

            function setupDeleteProductButtons() {
                document.querySelectorAll('.delete-product-btn').forEach(btn => {
                    
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const productId = e.currentTarget.dataset.productId;
                        if (!productId) return;

                        
                        
                        console.log("Attempting to delete product:", productId);
                        await deleteProduct(productId);
                    });
                });
            }

            function setupEditProductButtons() {
                document.querySelectorAll('.edit-product-btn').forEach(btn => {
                    
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const productId = e.currentTarget.dataset.productId;
                        if (!productId) return;

                        const product = allProducts.find(p => p.id === productId);
                        if (product) {
                            openEditModal(product);
                        } else {
                            console.error("Product not found for editing:", productId);
                        }
                    });
                });
            }

            
            function openEditModal(product) {
                // FIX: Re-fetch elements here to ensure they are found
                const modalEl = document.getElementById('add-product-modal');
                // ... (rest of elements)
                const formEl = document.getElementById('add-product-form');
                const titleEl = document.getElementById('modal-title');
                const submitBtnEl = document.getElementById('modal-submit-btn');

                if (!modalEl || !formEl || !titleEl || !submitBtnEl) {
                    console.error("Cannot open edit modal: Missing elements.");
                    return;
                }

                
                titleEl.textContent = "تعديل المنتج";
                submitBtnEl.textContent = "تحديث المنتج";
                formEl.dataset.editingId = product.id; 

                // Helper to safely set value
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.value = val;
                    else console.warn(`Element #${id} not found when trying to set value.`);
                };
                
                setVal('productName', product.name || '');
                setVal('productPrice', product.price || 0);
                
                // --- MODIFIED: Split existing Main URL into 3 fields ---
                const allImages = product.imageUrls || (product.imageUrl ? [product.imageUrl] : []);
                const mainUrl = allImages.length > 0 ? allImages[0] : '';

                if (mainUrl) {
                    // Try to extract extension
                    const matchExt = mainUrl.match(/(\.jpg|\.png|\.jpeg|\.webp)$/i);
                    const ext = matchExt ? matchExt[0].toLowerCase() : '.jpg'; // default to jpg if not found or custom
                    
                    // Set extension dropdown
                    const extSelect = document.getElementById('imgExtension');
                    if (extSelect) extSelect.value = ext;

                    // Remove extension from URL
                    let urlWithoutExt = mainUrl;
                    if (matchExt) {
                        urlWithoutExt = mainUrl.substring(0, mainUrl.lastIndexOf(ext));
                    }

                    // Try to split Base URL and Name
                    // We check if the URL starts with the stored Base URL preference
                    const savedBase = localStorage.getItem('admin_img_base_url') || 'https://i.postimg.cc/';
                    
                    if (urlWithoutExt.startsWith(savedBase)) {
                        setVal('imgBaseUrl', savedBase);
                        setVal('imgName', urlWithoutExt.substring(savedBase.length));
                    } else {
                        // Fallback: If it doesn't match stored base, try to guess or just put everything in Name
                        // Let's assume common case: https://domain.com/path/file
                        // We will set Base to the stored one (to keep it consistent) and put the FULL url (minus ext) in Name? 
                        // No, that breaks the concatenation (Base + Name).
                        // Better: Put empty Base and full path in Name.
                        setVal('imgBaseUrl', ''); 
                        setVal('imgName', urlWithoutExt);
                    }
                } else {
                    setVal('imgBaseUrl', localStorage.getItem('admin_img_base_url') || 'https://i.postimg.cc/');
                    setVal('imgName', '');
                }
                
                // Remaining images are Gallery
                const galleryImages = allImages.length > 1 ? allImages.slice(1) : [];
                setVal('productGalleryImages', galleryImages.join(', '));
                // -------------------------------------------------------

                setVal('productCategory', product.category || 'Other');
                setVal('productDescription', product.description || '');
                
                
                const saleCheck = document.getElementById('isOnSale');
                const bestsellerCheck = document.getElementById('isBestSeller');
                const availableCheck = document.getElementById('isAvailable'); // NEW

                if (saleCheck) saleCheck.checked = product.isOnSale || false;
                if (bestsellerCheck) bestsellerCheck.checked = product.isBestSeller || false;
                if (availableCheck) availableCheck.checked = product.isAvailable !== false; 

                
                if (product.isOnSale) {
                    originalPriceContainer.classList.remove('hidden');
                    // Removed invalid classList additions from previous bad fix
                    setVal('originalPrice', product.originalPrice || 0);
                    
                    // NEW: Populate Sale End Date
                    if (product.saleEndDate) {
                        const date = product.saleEndDate.toDate();
                        // Format for datetime-local input: YYYY-MM-DDTHH:mm
                        const formattedDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                         setVal('saleEndDate', formattedDate);
                    } else {
                         setVal('saleEndDate', '');
                    }

                } else {
                    originalPriceContainer.classList.add('hidden');
                     setVal('originalPrice', '');
                     setVal('saleEndDate', '');
                }

                
                setVal('productCompany', product.company || '');
                setVal('productVolts', product.volts || '');
                setVal('productLength', product.length || '');
                setVal('productWarranty', product.warranty || '');
                setVal('productMadeIn', product.madeIn || '');
                setVal('productModel', product.model || '');
                setVal('productLumens', product.lumens || '');
                setVal('productLifespan', product.lifespan || '');
                setVal('productCurrent', product.currentIntensity || '');
                setVal('productWatt', product.watt || '');
                setVal('productSizes', product.sizes || '');
                // NEW: Populate weight and size in edit modal
                setVal('productWeight', product.weight || '');
                setVal('productSize', product.size || '');
                // Removed old productColors population
                
                // --- NEW: Populate Color Variants ---
                const colorContainer = document.getElementById('color-variants-container');
                if (colorContainer) {
                    colorContainer.innerHTML = ''; // Clear existing
                    if (product.colorOptions && Array.isArray(product.colorOptions)) {
                        product.colorOptions.forEach(opt => {
                            addColorVariantRow(opt.hex, opt.name, opt.imageUrl);
                        });
                    }
                }
                // ------------------------------------
                
                modalEl.classList.remove('hidden');
                modalEl.style.display = 'flex'; // Force display for edit as well
            }


            
            function renderArticleCard(article) {
                // Admin Buttons
                const deleteButtonHTML = currentIsAdmin
                    ? `<button class="delete-article-btn p-2 bg-white/90 text-red-600 rounded-full hover:bg-red-600 hover:text-white shadow-sm transition-colors backdrop-blur-sm" title="حذف المقالة" data-article-id="${article.id}">
                           <i data-lucide="trash-2" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                const editButtonHTML = currentIsAdmin
                    ? `<button class="edit-article-btn p-2 bg-white/90 text-blue-600 rounded-full hover:bg-blue-600 hover:text-white shadow-sm transition-colors backdrop-blur-sm" title="تعديل المقالة" data-article-id="${article.id}">
                           <i data-lucide="edit-3" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                const adminButtonsHTML = currentIsAdmin
                    ? `<div class="absolute top-3 left-3 z-30 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            ${editButtonHTML}
                            ${deleteButtonHTML}
                       </div>`
                    : '';
                
                // Preview Text Logic
                let previewText = 'اضغط لقراءة المزيد...';
                if (Array.isArray(article.content) && article.content.length > 0) {
                    const firstBlock = article.content.find(b => b.body);
                    if (firstBlock) {
                        previewText = firstBlock.body.substring(0, 120) + '...';
                    } else if (article.content[0].title) {
                        previewText = article.content[0].title;
                    }
                } else if (typeof article.content === 'string' && article.content) {
                    previewText = (article.content.replace(/<[^>]+>/g, '').substring(0, 120) || 'اضغط لقراءة المزيد') + '...';
                }

                // Date Logic
                let dateStr = '';
                if (article.createdAt) {
                    const date = article.createdAt.toDate ? article.createdAt.toDate() : new Date(article.createdAt);
                    dateStr = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                }

                // Image Fallback
                const imgUrl = article.imageUrl || 'https://placehold.co/600x400/202124/ffcd00?text=Macca+Blog';

                return `
                <article class="group bg-white dark:bg-[#202124] rounded-[2rem] border border-gray-100 dark:border-white/5 overflow-hidden hover:shadow-[0_20px_40px_-5px_rgba(0,0,0,0.1)] dark:hover:shadow-[0_20px_40px_-5px_rgba(0,0,0,0.4)] transition-all duration-500 hover:-translate-y-2 flex flex-col h-full relative isolate">
                    
                    <!-- Image Container -->
                    <div class="relative h-64 overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent z-10 opacity-60 group-hover:opacity-40 transition-opacity duration-500"></div>
                        
                        ${adminButtonsHTML}
                        
                        <a href="#blog/${article.shortId || article.id}" class="article-details-link block h-full w-full" data-article-id="${article.id}">
                            <img class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-110" 
                                 src="${imgUrl}" 
                                 onerror="this.src='https://placehold.co/600x400/202124/ffcd00?text=Image+Error'" 
                                 alt="${article.title}"
                                 loading="lazy">
                        </a>
                        
                        <!-- Category Badge (Mock) -->
                        <span class="absolute top-4 right-4 z-20 px-3 py-1 bg-[#ffcd00]/90 backdrop-blur-md text-gray-900 text-xs font-bold rounded-full shadow-lg border border-white/20">
                            نصائح ومقالات
                        </span>
                    </div>

                    <!-- Content -->
                    <div class="p-6 sm:p-8 flex-grow flex flex-col">
                        
                        <!-- Meta Data -->
                        <div class="flex items-center gap-4 text-xs font-medium text-gray-500 dark:text-gray-400 mb-4">
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-[#ffcd00]"></i>
                                <span>${dateStr || 'حديثاً'}</span>
                            </div>
                            <div class="w-1 h-1 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="user" class="w-3.5 h-3.5 text-[#ffcd00]"></i>
                                <span>فريق مكة</span>
                            </div>
                        </div>

                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-3 leading-snug group-hover:text-[#ffcd00] transition-colors">
                            <a href="#blog/${article.shortId || article.id}" class="article-details-link" data-article-id="${article.id}">
                                ${article.title}
                            </a>
                        </h2>

                        <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-6 line-clamp-3 flex-grow border-l-2 border-gray-100 dark:border-gray-700 pl-4">
                            ${previewText}
                        </p>

                        <div class="mt-auto pt-6 border-t border-gray-100 dark:border-white/5 flex items-center justify-between">
                            <a href="#blog/${article.shortId || article.id}" 
                               class="article-details-link inline-flex items-center gap-2 text-sm font-bold text-gray-900 dark:text-white hover:text-[#ffcd00] dark:hover:text-[#ffcd00] transition-colors group/link" 
                               data-article-id="${article.id}">
                                <span>اقرأ المقال</span>
                                <div class="w-6 h-6 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center group-hover/link:bg-[#ffcd00] group-hover/link:text-gray-900 transition-colors">
                                    <i data-lucide="arrow-left" class="w-3 h-3 transition-transform group-hover/link:-translate-x-0.5"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </article>
                `;
            }

            function renderArticles() {
                const blogGrid = document.getElementById('blog-grid');
                if (!blogGrid) return;

                if (allArticles.length === 0) {
                    blogGrid.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-1 md:col-span-2 lg:col-span-3 text-center">لم يتم العثور على مقالات. تحقق مرة أخرى لاحقاً!</p>';
                    return;
                }

                blogGrid.innerHTML = '';
                allArticles.forEach(article => {
                    blogGrid.innerHTML += renderArticleCard(article);
                });


                setupDeleteArticleButtons();
                setupEditArticleButtons();
                lucide.createIcons();
            }

            function setupArticleDetailsLinks() {
                document.querySelectorAll('.article-details-link').forEach(link => {
                    if (link.dataset.listenerAttached) return;
                    link.dataset.listenerAttached = 'true';
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const articleId = e.currentTarget.dataset.articleId;
                        showPage('blog-post', articleId);
                    });
                });
            }

            function setupDeleteArticleButtons() {
                document.querySelectorAll('.delete-article-btn').forEach(btn => {
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const articleId = e.currentTarget.dataset.articleId;
                        if (!articleId) return;
                        
                        await deleteArticle(articleId);
                    });
                });
            }

            async function deleteArticle(id) {
                try {
                    const articleRef = doc(db, "articles", id);
                    await deleteDoc(articleRef);
                    showToast("تم حذف المقالة بنجاح.");
                } catch (error) {
                    console.error("Error deleting article: ", error);
                    showToast("خطأ: لم نتمكن من حذف المقالة.");
                }
            }

            function setupEditArticleButtons() {
                document.querySelectorAll('.edit-article-btn').forEach(btn => {
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const articleId = e.currentTarget.dataset.articleId;
                        if (!articleId) return;
                        const article = allArticles.find(a => a.id === articleId);
                        if (article) {
                            openEditArticleModal(article);
                        }
                    });
                });
            }

            function openEditArticleModal(article) {
                if (!articleModal || !addArticleForm || !articleModalTitle || !articleModalSubmitBtn) return;

                articleModalTitle.textContent = "تعديل المقالة";
                articleModalSubmitBtn.textContent = "تحديث المقالة";
                addArticleForm.dataset.editingId = article.id;

                document.getElementById('articleTitle').value = article.title || '';
                document.getElementById('articleImageUrl').value = article.imageUrl || '';
                
                
                const container = document.getElementById('article-paragraphs-container');
                if (container) {
                    container.innerHTML = '';
                }
                
                
                if (Array.isArray(article.content) && article.content.length > 0) {
                    article.content.forEach(block => {
                        const type = block.type || 'paragraph';
                        if (type === 'paragraph') {
                            createParagraphBlock(block.title, block.body);
                        } else if (type === 'gallery') {
                            createGalleryBlock(block.images);
                        }
                    });
                } else if (typeof article.content === 'string' && article.content) {
                    
                    
                    createParagraphBlock('', article.content);
                } else {
                    
                    createParagraphBlock();
                }
                reNumberParagraphBlocks();
                
                
                

                articleModal.classList.remove('hidden');
            }

            function renderArticleDetails(articleId) {
                // --- FIX: Corrected logic to search in allArticles ---
                const article = allArticles.find(a => a.shortId === articleId || a.id === articleId);
                
                // --- FIX: Handle loading state for direct links ---
                if (!article) {
                    if (allArticles.length === 0) {
                        // Data hasn't loaded yet, stay on page and show loading
                        const titleEl = document.getElementById('blog-post-title');
                        const contentEl = document.getElementById('blog-post-content-wrapper');
                        
                        if (titleEl) titleEl.textContent = "جاري تحميل المقالة...";
                        if (contentEl) contentEl.innerHTML = '<div class="text-center py-10"><div class="loading-dots mx-auto"><div class="loading-dot bg-gray-400"></div><div class="loading-dot bg-gray-400"></div><div class="loading-dot bg-gray-400"></div></div><p class="mt-4 text-gray-500">يرجى الانتظار قليلاً...</p></div>';
                        return;
                    }
                    // Data loaded but article not found -> Redirect
                    console.warn("Article not found:", articleId);
                    showPage('blog');
                    return;
                }
                // -------------------------------------------------

                const titleEl = document.getElementById('blog-post-title');
                const imageEl = document.getElementById('blog-post-image');
                const contentEl = document.getElementById('blog-post-content-wrapper');

                if (titleEl) titleEl.textContent = article.title;
                if (imageEl) {
                    imageEl.src = article.imageUrl;
                    imageEl.alt = article.title;
                }
                
                
                if (contentEl) {
                    let finalHtml = '';
                    let paragraphCounter = 1;
                    
                    
                    if (Array.isArray(article.content)) {
                        article.content.forEach((block) => {
                            const type = block.type || 'paragraph';

                            if (type === 'paragraph') {
                                if (block.title) {
                                    const safeTitle = escapeHTML(block.title);
                                    
                                    finalHtml += `<h2>${paragraphCounter}. ${safeTitle}</h2>\n`;
                                }
                                
                                if (block.body) {
                                    const lines = block.body.split('\n')
                                                        .map(line => line.trim())
                                                        .filter(line => line.length > 0);
                                    
                                    if (lines.length > 0) {
                                        finalHtml += '<ul>\n';
                                        lines.forEach(line => {
                                            finalHtml += `<li>${escapeHTML(line)}</li>\n`;
                                        });
                                        finalHtml += '</ul>\n';
                                    }
                                }
                                paragraphCounter++;
                            
                            } else if (type === 'gallery' && block.images && block.images.length > 0) {
                                
                                
                                finalHtml += '<div class="not-prose grid grid-cols-2 md:grid-cols-3 gap-2 my-4">\n';
                                block.images.forEach(url => {
                                    finalHtml += `
                                        <div>
                                            <img src="${escapeHTML(url)}" 
                                                 class="w-full h-auto object-cover rounded-md shadow-md aspect-square" 
                                                 onerror="this.src='https://placehold.co/400x400/eeeeee/777777?text=Image+Error'" 
                                                 alt="Gallery Image">
                                        </div>\n`;
                                });
                                finalHtml += '</div>\n';
                                
                            }
                        });
                    } else if (typeof article.content === 'string') {
                        
                        
                        finalHtml = article.content;
                    }
                    
                    contentEl.innerHTML = finalHtml || '<p>لا يوجد محتوى متاح.</p>';
                }
                
            }

            

            
            function setupProductDetailsLinks() {
                document.querySelectorAll('.product-details-link').forEach(btn => {
                    
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const productId = e.currentTarget.dataset.productId;
                        
                        console.log('Details link clicked, Product ID:', productId); 
                        if (!productId) {
                            console.error("Product ID is missing from the button!");
                            return;
                        }
                        
                        showPage('details', productId);
                    });
                });
            }


            
            async function deleteProduct(id) {
                try {
                    const productRef = doc(db, "products", id);
                    await deleteDoc(productRef);
                    showToast("تم حذف المنتج بنجاح.");
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showToast("خطأ: لم نتمكن من حذف المنتج.");
                }
            }

            
            function renderProductDetails(productId) {
                
                console.log('renderProductDetails called for:', productId); 
                const product = allProducts.find(p => p.shortId === productId || p.id === productId);
                
                // --- FIX: Prevent redirecting to products list if data is still loading ---
                if (!product) {
                    if (allProducts.length === 0) {
                        // If product list is empty, it means we are still loading data.
                        // Show a loading state instead of redirecting.
                        document.getElementById('details-product-name').textContent = "جاري تحميل بيانات المنتج...";
                        document.getElementById('details-product-description').textContent = "يرجى الانتظار قليلاً...";
                        // Hide price/actions temporarily
                        if(document.getElementById('details-product-price')) document.getElementById('details-product-price').innerHTML = '';
                        if(document.getElementById('details-add-to-cart-wrapper')) document.getElementById('details-add-to-cart-wrapper').innerHTML = '';
                        return; 
                    }
                    
                    // Only redirect if data is loaded AND product is truly missing
                    console.error("Product not found in allProducts array:", productId);
                    showPage('products'); 
                    return;
                }
                // ------------------------------------------------------------------------

                const placeholder = 'https://placehold.co/600x600/eeeeee/777777?text=No+Image';
                const mainImgEl = document.getElementById('main-product-image');
                const thumbnailContainer = document.getElementById('details-thumbnail-container');

                
                thumbnailContainer.innerHTML = '';

                
                const imageUrls = (product.imageUrls && product.imageUrls.length > 0) 
                                    ? product.imageUrls 
                                    : [product.imageUrl || placeholder];
                
                
                currentGalleryImages = imageUrls;
                currentGalleryIndex = 0;
                currentSelectedColor = null;

                mainImgEl.src = imageUrls[0];

                imageUrls.forEach((url, index) => {
                    const thumbWrapper = document.createElement('div');
                    thumbWrapper.className = `cursor-pointer relative rounded-xl overflow-hidden h-20 w-20 sm:h-24 sm:w-24 flex-shrink-0 border-2 transition-all duration-300 snap-start ${index === 0 ? 'border-[#ffcd00] ring-2 ring-[#ffcd00]/20' : 'border-transparent hover:border-gray-300 dark:hover:border-gray-600'}`;
                    
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Thumbnail ${index + 1}`;
                    img.onerror = function() { this.src = placeholder; };
                    img.className = "w-full h-full object-contain bg-white dark:bg-[#222] p-1";
                    
                    thumbWrapper.onclick = () => {
                        updateGalleryView(index);
                        // Update active state visual
                        Array.from(thumbnailContainer.children).forEach(child => {
                            child.classList.remove('border-[#ffcd00]', 'ring-2', 'ring-[#ffcd00]/20');
                            child.classList.add('border-transparent');
                        });
                        thumbWrapper.classList.remove('border-transparent');
                        thumbWrapper.classList.add('border-[#ffcd00]', 'ring-2', 'ring-[#ffcd00]/20');
                    };
                    
                    thumbWrapper.appendChild(img);
                    thumbnailContainer.appendChild(thumbWrapper);
                });

                // Gallery Navigation Logic (Existing logic preserved, just button IDs matched)
                const prevBtn = document.getElementById('gallery-prev-btn');
                const nextBtn = document.getElementById('gallery-next-btn');
                
                if (prevBtn && nextBtn) {
                    const newPrevBtn = prevBtn.cloneNode(true);
                    prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
                    const newNextBtn = nextBtn.cloneNode(true);
                    nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);

                    newPrevBtn.addEventListener('click', () => updateGalleryView(currentGalleryIndex - 1));
                    newNextBtn.addEventListener('click', () => updateGalleryView(currentGalleryIndex + 1));
                }
                
                // Badges & Info
                const categoryTranslations = {
                    'Lighting': 'إضاءة', 'Cables': 'كابلات', 'Switches': 'مفاتيح',
                    'Paints': 'دهانات', 'Parts': 'قطع غيار', 'Ironmongery': 'حدايد',
                    'Showers': 'الدش', 'Electronics': 'الكترونيات',
                    'OpticalPanels': 'لوحات', 'BuildingMaterials': 'مواد البناء', 'Other': 'أخرى'
                };
                
                const categoryEl = document.getElementById('details-product-category');
                const companyEl = document.getElementById('details-product-company');

                if (categoryEl) {
                    if (product.category) {
                        categoryEl.textContent = categoryTranslations[product.category] || product.category;
                        categoryEl.classList.remove('hidden');
                    } else {
                        categoryEl.classList.add('hidden');
                    }
                }

                if (companyEl) {
                    if (product.company && product.company.trim() !== '') {
                        companyEl.textContent = product.company;
                        companyEl.classList.remove('hidden');
                    } else {
                        companyEl.classList.add('hidden');
                    }
                }

                document.getElementById('details-product-name').textContent = product.name;
                
                const detailsRatingEl = document.getElementById('details-star-rating');
                if (detailsRatingEl) detailsRatingEl.innerHTML = generateStarRating() + '<span class="text-xs text-gray-400 font-medium mr-2">(4.8/5)</span>';

                document.getElementById('details-product-description').textContent = product.description || "لا يوجد وصف متاح لهذا المنتج.";

                // Price Section
                const priceEl = document.getElementById('details-product-price');
                // Removing old classes as they are now in HTML structure
                
                if (isOfferActive(product) && product.originalPrice && product.originalPrice > product.price) {
                    const discountAmount = product.originalPrice - product.price;
                    const discountPercent = Math.round((discountAmount / product.originalPrice) * 100);
                    const remaining = getRemainingTime(product);
                    
                    let timerHtml = remaining ? `
                        <div class="flex items-center gap-2 mt-3 text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/10 px-3 py-1.5 rounded-lg w-fit">
                            <i data-lucide="timer" class="w-4 h-4 animate-pulse"></i>
                            <span class="text-xs font-bold">ينتهي العرض خلال ${remaining}</span>
                        </div>` : '';

                    priceEl.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-3">
                                <span class="text-4xl font-black text-gray-900 dark:text-white">${product.price.toFixed(0)}<span class="text-lg align-top text-gray-500">.00</span> <span class="text-base font-medium text-gray-500">ج.م</span></span>
                                <span class="px-2.5 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs font-bold rounded-full">خصم ${discountPercent}%</span>
                            </div>
                            <span class="text-sm text-gray-400 line-through font-medium">بدلاً من ${product.originalPrice.toFixed(2)} ج.م</span>
                            ${timerHtml}
                        </div>
                    `;
                } else {
                    priceEl.innerHTML = `
                        <div class="flex items-baseline gap-1">
                            <span class="text-4xl font-black text-gray-900 dark:text-white">${product.price.toFixed(0)}<span class="text-lg align-top text-gray-500">.00</span></span>
                            <span class="text-base font-bold text-gray-500">ج.م</span>
                        </div>
                    `;
                }

                // --- NEW: Key Features Grid Logic ---
                const featuresContainer = document.getElementById('details-key-features');
                if (featuresContainer) {
                    featuresContainer.innerHTML = '';
                    const features = [];
                    
                    if (product.warranty) features.push({ icon: 'shield-check', label: 'الضمان', value: product.warranty, color: 'text-green-500' });
                    if (product.madeIn) features.push({ icon: 'globe', label: 'صنع في', value: product.madeIn, color: 'text-blue-500' });
                    if (product.company) features.push({ icon: 'award', label: 'الماركة', value: product.company, color: 'text-purple-500' });
                    if (product.model) features.push({ icon: 'hash', label: 'موديل', value: product.model, color: 'text-gray-500' });
                    
                    // Add generic "Original" badge if nothing else
                    if (features.length === 0) features.push({ icon: 'check-circle', label: 'الجودة', value: 'منتج أصلي 100%', color: 'text-[#ffcd00]' });

                    features.forEach(f => {
                        featuresContainer.innerHTML += `
                            <div class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-white/5 rounded-xl border border-gray-100 dark:border-white/5">
                                <div class="w-10 h-10 rounded-full bg-white dark:bg-[#333] flex items-center justify-center shadow-sm ${f.color}">
                                    <i data-lucide="${f.icon}" class="w-5 h-5"></i>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase">${f.label}</span>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white truncate">${f.value}</span>
                                </div>
                            </div>
                        `;
                    });
                }

                // Color Swatches
                const colorOptionsContainer = document.getElementById('details-color-options');
                const swatchesContainer = document.getElementById('color-swatches-container');
                
                if (colorOptionsContainer && swatchesContainer) {
                    if (product.colorOptions && Array.isArray(product.colorOptions) && product.colorOptions.length > 0) {
                        swatchesContainer.innerHTML = '';
                        product.colorOptions.forEach(opt => {
                            const swatch = document.createElement('button');
                            swatch.title = opt.name || opt.hex;
                            swatch.className = 'w-12 h-12 rounded-full border-2 border-white dark:border-gray-600 hover:scale-110 transition-all shadow-md focus:outline-none focus:ring-2 focus:ring-[#ffcd00] relative overflow-hidden group';
                            swatch.style.backgroundColor = opt.hex;
                            
                            // Checkmark overlay for active state logic could be added here
                            swatch.addEventListener('click', () => {
                                currentSelectedColor = opt;
                                if (opt.imageUrl && opt.imageUrl.trim() !== '') {
                                    const mainImgEl = document.getElementById('main-product-image');
                                    if (mainImgEl) {
                                        mainImgEl.style.opacity = '0.5';
                                        setTimeout(() => {
                                            mainImgEl.src = opt.imageUrl;
                                            mainImgEl.style.opacity = '1';
                                        }, 200);
                                    }
                                }
                                // Visual Feedback
                                Array.from(swatchesContainer.children).forEach(b => {
                                    b.classList.remove('ring-2', 'ring-[#ffcd00]', 'scale-110');
                                    b.style.transform = 'scale(1)';
                                });
                                swatch.classList.add('ring-2', 'ring-[#ffcd00]');
                                swatch.style.transform = 'scale(1.1)';
                            });
                            swatchesContainer.appendChild(swatch);
                        });
                        colorOptionsContainer.classList.remove('hidden');
                    } else {
                        colorOptionsContainer.classList.add('hidden');
                    }
                }

                // Add To Cart Section
                const cartWrapper = document.getElementById('details-add-to-cart-wrapper');
                // Dataset setup...
                cartWrapper.dataset.productId = product.id;
                cartWrapper.dataset.productName = product.name;
                cartWrapper.dataset.productPrice = product.price;
                cartWrapper.dataset.productImage = imageUrls[0]; 

                if (product.isAvailable === false) {
                    cartWrapper.innerHTML = `
                        <div class="p-4 bg-gray-100 dark:bg-white/5 rounded-xl text-center border-2 border-dashed border-gray-300 dark:border-gray-600">
                            <div class="flex flex-col items-center gap-2 text-gray-500">
                                <i data-lucide="alert-circle" class="w-8 h-8"></i>
                                <span class="font-bold">نفذت الكمية مؤقتاً</span>
                            </div>
                        </div>
                        <a id="details-whatsapp-link-unavailable" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-xl hover:opacity-90 transition-all">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                            <span>تنبيه عند التوفر (واتساب)</span>
                        </a>
                    `;
                    const waLink = document.getElementById('details-whatsapp-link-unavailable');
                    if(waLink) waLink.href = `https://wa.me/201146641942?text=${encodeURIComponent('أرغب في معرفة موعد توفر: ' + product.name)}`;
                } else {
                    cartWrapper.innerHTML = `
                        <div class="flex gap-4">
                            <div class="w-32 relative">
                                <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none text-gray-500">
                                    <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                                </div>
                                <input type="number" id="details-quantity-input" value="1" min="1" 
                                       class="w-full pl-10 pr-4 py-4 rounded-xl bg-gray-50 dark:bg-[#333] border-transparent focus:border-[#ffcd00] focus:ring-0 font-bold text-center text-lg"
                                       aria-label="الكمية">
                            </div>
                            <button class="add-to-cart-btn flex-1 bg-[#ffcd00] text-gray-900 font-black text-lg rounded-xl shadow-[0_4px_14px_0_rgba(255,205,0,0.39)] hover:shadow-[0_6px_20px_rgba(255,205,0,0.23)] hover:-translate-y-1 transition-all flex items-center justify-center gap-3">
                                <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                <span>أضف للسلة</span>
                            </button>
                        </div>
                        <a id="details-whatsapp-link" href="#" target="_blank" class="flex items-center justify-center gap-2 w-full py-3 text-sm font-bold text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-xl transition-all border border-transparent hover:border-green-200 dark:hover:border-green-900">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            <span>طلب سريع عبر واتساب</span>
                        </a>
                    `;
                    setupAddToCartButtons();
                    const waLink = document.getElementById('details-whatsapp-link');
                    if(waLink) waLink.href = `https://wa.me/201146641942?text=${encodeURIComponent('أود طلب المنتج: ' + product.name)}`;
                }

                // Specs List
                const specsContainer = document.getElementById('specs-list-container');
                if (specsContainer) {
                    specsContainer.innerHTML = ''; 
                    const specs = [
                        { label: 'الجهد الكهربي', value: product.volts, unit: 'V' },
                        { label: 'القدرة', value: product.watt, unit: 'Watt' },
                        { label: 'شدة الإضاءة', value: product.lumens, unit: 'Lumen' },
                        { label: 'الطول', value: product.length, unit: 'متر' },
                        { label: 'المقاس', value: product.size },
                        { label: 'الوزن', value: product.weight },
                        { label: 'الموديل', value: product.model }
                    ];

                    let hasSpecs = false;
                    specs.forEach(spec => {
                        if (spec.value && String(spec.value).trim() !== '') {
                            hasSpecs = true;
                            specsContainer.innerHTML += `
                                <li class="flex justify-between items-center py-3">
                                    <span class="font-medium text-gray-500 dark:text-gray-400">${spec.label}</span>
                                    <span class="font-bold text-gray-900 dark:text-white" dir="ltr">${spec.value} ${spec.unit || ''}</span>
                                </li>
                            `;
                        }
                    });
                    
                    if (!hasSpecs) {
                        specsContainer.innerHTML = '<li class="py-4 text-center text-gray-400">لا توجد مواصفات تقنية إضافية.</li>';
                    }
                }
                
                // Refresh Icons
                lucide.createIcons();
            }


            async function fetchAiSuggestions(productId) {
                const loadingElDesktop = document.getElementById('ai-suggestions-loading-desktop');
                const gridElDesktop = document.getElementById('ai-suggestions-grid-desktop');
                const loadingElMobile = document.getElementById('ai-suggestions-loading-mobile');
                const gridElMobile = document.getElementById('ai-suggestions-grid-mobile');
                
              
                if (loadingElDesktop) loadingElDesktop.classList.remove('hidden');
                if (gridElDesktop) gridElDesktop.innerHTML = ''; 
                if (loadingElMobile) loadingElMobile.classList.remove('hidden');
                if (gridElMobile) gridElMobile.innerHTML = ''; 

                try {
                    const currentProduct = allProducts.find(p => p.shortId === productId || p.id === productId);
                    if (!currentProduct) {
                   
                        throw new Error("Current product not found for suggestions.");
                    }

                    const currentCategory = currentProduct.category;
                    const maxSuggestions = 4; // Increased slightly for better grid fill
                    let suggestions = [];

        
                    // Filter products: same category, NOT the current product, AND AVAILABLE
                    const categoryProducts = allProducts.filter(p => 
                        p.category === currentCategory && 
                        (p.shortId !== productId && p.id !== productId) &&
                        p.isAvailable !== false // Suggest only available products
                    );

                  
                    let shuffledCategory = [...categoryProducts];
                    for (let i = shuffledCategory.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledCategory[i], shuffledCategory[j]] = [shuffledCategory[j], shuffledCategory[i]];
                    }
                    
                    suggestions = shuffledCategory.slice(0, maxSuggestions);

       
                    if (suggestions.length < maxSuggestions) {
                        const otherProducts = allProducts.filter(p => 
                            p.category !== currentCategory && 
                            (p.shortId !== productId && p.id !== productId) &&
                            p.isAvailable !== false // Suggest only available products
                        );

         
                        let shuffledOthers = [...otherProducts];
                        for (let i = shuffledOthers.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [shuffledOthers[i], shuffledOthers[j]] = [shuffledOthers[j], shuffledOthers[i]];
                        }
                        
                        const needed = maxSuggestions - suggestions.length;
                        suggestions = suggestions.concat(shuffledOthers.slice(0, needed));
                    }
                    
                    
                    let suggestionsHtml = ''; 
                    if (suggestions.length === 0) {
                        
                        suggestionsHtml = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center text-xs">لا توجد منتجات أخرى لاقتراحها.</p>`;
                    } else {
                        
                        suggestions.forEach(product => {
                            if (product) {
                                
                                suggestionsHtml += renderProductCard(product);
                            }
                        });
                    }
                    
                  
                    if (gridElDesktop) gridElDesktop.innerHTML = suggestionsHtml;
                    if (gridElMobile) gridElMobile.innerHTML = suggestionsHtml;
                    
                    
            

                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                 
                    const otherProducts = allProducts.filter(p => p.shortId !== productId && p.id !== productId && p.isAvailable !== false);
                    let shuffled = [...otherProducts];
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                    const randomSuggestions = shuffled.slice(0, 3);
                    
                    let fallbackHtml = '';
                    if (randomSuggestions.length > 0) {
                         randomSuggestions.forEach(product => {
                            if (product) {
                              
                                fallbackHtml += renderProductCard(product);
                            }
                        });
                     
                    } else {
                        fallbackHtml = `<p class="text-red-500 col-span-full text-center text-xs">لا توجد اقتراحات حالياً.</p>`;
                    }
                    
                    if (gridElDesktop) gridElDesktop.innerHTML = fallbackHtml;
                    if (gridElMobile) gridElMobile.innerHTML = fallbackHtml;

                } finally {
                   
                    if (loadingElDesktop) loadingElDesktop.classList.add('hidden');
                    if (loadingElMobile) loadingElMobile.classList.add('hidden');
                    
                   
                    setupAddToCartButtons();
                    setupDeleteProductButtons();
                    setupEditProductButtons();
             
                    lucide.createIcons();
                }
            }

            function loadProducts() {
                const productsRef = collection(db, "products");
                const q = query(productsRef);

                onSnapshot(q, (querySnapshot) => {
                 
                    allProducts = []; 
                    querySnapshot.forEach((doc) => {
                        allProducts.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Products loaded from Firestore:", allProducts.length);
                    
                    populateBrandFilter(); 
                    renderAllProductViews();

                    // --- FIX: Hide loader once products are loaded ---
                    hideGlobalLoader();
                    // -----------------------------------------------

                    // --- FIX: Force show product if URL hash exists after data load ---
                    const hash = window.location.hash;
                    if (hash.startsWith('#product/')) {
                        // Clean the ID (remove encoding, slashes, spaces)
                        const rawId = hash.substring('#product/'.length);
                        const id = decodeURIComponent(rawId).replace(/\/$/, '').trim();
                        
                        console.log("Data loaded. Checking deep link for product:", id);

                        // Check if we actually have this product now
                        const productExists = allProducts.some(p => p.shortId === id || p.id === id);
                        
                        if (productExists) {
                            // Found it! Force render details
                            showPage('details', id);
                        } else {
                            // Loaded data but product ID is invalid -> Go to products list
                            console.warn("Product not found after load:", id);
                            showPage('products');
                        }
                    }
                    // ----------------------------------------------------------------

                }, (error) => {
                    console.error("Error fetching products: ", error);
                    showToast("خطأ أثناء جلب المنتجات.");
                    // Hide loader even on error so user isn't stuck
                    hideGlobalLoader();
                });
            }
            
            // NEW FUNCTION
            function populateBrandFilter() {
                const brandFilter = document.getElementById('product-brand-filter');
                if (!brandFilter) return;

                // 1. Get unique brands
                const brands = [...new Set(
                    allProducts
                        .map(p => p.company)
                        .filter(company => company && company.trim() !== '')
                )];
                brands.sort(); // Sort alphabetically

                // 2. Clear existing options (keep the first default "all")
                while (brandFilter.options.length > 1) {
                    brandFilter.remove(1);
                }

                // 3. Add new options
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandFilter.appendChild(option);
                });
            }
            // END NEW FUNCTION
            
            document.getElementById('product-search-input').addEventListener('input', () => {
                preFilterType = 'all';
                renderAllProductViews();
            });
            
            // --- NEW: Add Event Listeners for Price Inputs ---
            const minPriceInput = document.getElementById('product-min-price');
            const maxPriceInput = document.getElementById('product-max-price');
            
            if (minPriceInput) {
                minPriceInput.addEventListener('input', () => {
                    preFilterType = 'all'; // Reset special filters like "Offers Only" if user customizes price
                    renderAllProductViews();
                });
            }
            
            if (maxPriceInput) {
                maxPriceInput.addEventListener('input', () => {
                    preFilterType = 'all';
                    renderAllProductViews();
                });
            }
            // -------------------------------------------------

            const categoryFilterForPlaceholder = document.getElementById('product-category-filter');
            const brandFilterForPlaceholder = document.getElementById('product-brand-filter'); // NEW
            const searchInputForPlaceholder = document.getElementById('product-search-input');

            function updateSearchPlaceholder() {
                if (!categoryFilterForPlaceholder || !searchInputForPlaceholder || !brandFilterForPlaceholder) return; // NEW check
                
                const selectedCategoryOption = categoryFilterForPlaceholder.options[categoryFilterForPlaceholder.selectedIndex];
                const selectedCategoryText = selectedCategoryOption.value === 'all' ? 'الأقسام' : selectedCategoryOption.text;
                
                const selectedBrandOption = brandFilterForPlaceholder.options[brandFilterForPlaceholder.selectedIndex]; // NEW
                const selectedBrandText = selectedBrandOption.value === 'all' ? 'الماركات' : selectedBrandOption.text; // NEW
                
                let placeholder = "ابحث في ";
                
                if (selectedCategoryOption.value !== 'all' && selectedBrandOption.value !== 'all') {
                    placeholder += `${selectedCategoryText} (ماركة ${selectedBrandText})...`;
                } else if (selectedCategoryOption.value !== 'all') {
                    placeholder += `${selectedCategoryText}...`;
                } else if (selectedBrandOption.value !== 'all') {
                    placeholder += `ماركة ${selectedBrandText}...`;
                } else {
                    placeholder = "ابحث في جميع الأقسام والماركات...";
                }
                
                searchInputForPlaceholder.placeholder = placeholder; // MODIFIED
            }

            if (categoryFilterForPlaceholder) {
                categoryFilterForPlaceholder.addEventListener('change', () => {
                    preFilterType = 'all';
                    updateSearchPlaceholder();
                    renderAllProductViews();
                });
            }
            
            // NEW: Event listener for brand filter
            if (brandFilterForPlaceholder) {
                brandFilterForPlaceholder.addEventListener('change', () => {
                    preFilterType = 'all';
                    updateSearchPlaceholder();
                    renderAllProductViews();
                });
            }
            // END NEW

            document.getElementById('product-sort-filter').addEventListener('change', () => {
                preFilterType = 'all';
                renderAllProductViews();
            });

            function loadArticles() {
                const articlesRef = collection(db, "articles");
                const q = query(articlesRef);

                onSnapshot(q, (querySnapshot) => {
                    allArticles = [];
                    querySnapshot.forEach((doc) => {
                        allArticles.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Articles loaded from Firestore:", allArticles.length);
                    renderArticles();

                    // --- FIX: Force show article if URL hash exists after data load ---
                    const hash = window.location.hash;
                    if (hash.startsWith('#blog/')) {
                        const rawId = hash.substring('#blog/'.length);
                        const id = decodeURIComponent(rawId).replace(/\/$/, '').trim();
                        
                        const articleExists = allArticles.some(a => a.shortId === id || a.id === id);
                        
                        if (articleExists) {
                            showPage('blog-post', id);
                        } else {
                            showPage('blog');
                        }
                    }
                    // ----------------------------------------------------------------

                }, (error) => {
                    console.error("Error fetching articles: ", error);
                    showToast("خطأ أثناء جلب المقالات.");
                });
            }

           
            function loadSiteConfig() {
               
                // 0. Load Branding Config (NEW)
                const brandingConfigRef = doc(db, "config", "branding");
                onSnapshot(brandingConfigRef, (docSnap) => {
                    const logoImg = document.getElementById('site-logo-img');
                    const adminLogoInput = document.getElementById('admin-logo-url');
                    
                    // New Elements for Size
                    const adminLogoSizeInput = document.getElementById('admin-logo-size');
                    const adminLogoSizeDisplay = document.getElementById('admin-logo-size-display');

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const logoUrl = data.logoUrl;
                        const logoSize = data.logoSize || 80; // Default 80px

                        if (logoUrl && logoUrl.trim() !== '') {
                            // Show Custom Image Logo
                            if (logoImg) {
                                logoImg.src = logoUrl;
                                logoImg.classList.remove('hidden');
                                // Apply Dynamic Size
                                logoImg.style.height = `${logoSize}px`;
                                // Ensure standard class doesn't override (inline style wins, but good practice)
                                logoImg.classList.remove('h-20'); 
                            }
                        } else {
                            // Hide Custom Image Logo if no URL
                            if (logoImg) logoImg.classList.add('hidden');
                        }

                        // Populate Admin Input
                        if (adminLogoInput) adminLogoInput.value = logoUrl || '';
                        
                        // Populate Size Controls
                        if (adminLogoSizeInput) adminLogoSizeInput.value = logoSize;
                        if (adminLogoSizeDisplay) adminLogoSizeDisplay.textContent = `${logoSize}px`;
                    }
                });

                // REMOVED: 1. Load Sticky Banner Config logic

                // 2. Load Homepage (Hero) Config
                const homepageConfigRef = doc(db, "config", "homepage");
                onSnapshot(homepageConfigRef, (docSnap) => {
                    // DOM Elements
                    const heroContainer = document.getElementById('hero-section-container'); // NEW
                    const videoEl = document.getElementById('hero-video');
                    const videoSourceEl = document.getElementById('hero-video-source');
                    const imageEl = document.getElementById('hero-bg-image'); 
                    const badgeTextEl = document.getElementById('hero-badge-text');
                    const titleMainEl = document.getElementById('hero-title-main');
                    const titleSubEl = document.getElementById('hero-title-sub');
                    const descEl = document.getElementById('hero-description');

                    // Admin Inputs
                    const adminHeroTypeSelect = document.getElementById('admin-hero-type');
                    const adminVideoUrlInput = document.getElementById('admin-video-url');
                    const adminImageUrlInput = document.getElementById('admin-image-url');
                    const adminBadgeInput = document.getElementById('admin-hero-badge');
                    const adminTitleInput = document.getElementById('admin-hero-title');
                    const adminSubtitleInput = document.getElementById('admin-hero-subtitle');
                    const adminDescInput = document.getElementById('admin-hero-desc');
                    
                    // NEW: Admin Inputs for Visibility & Height (Separate)
                    const adminVisMobile = document.getElementById('admin-hero-vis-mobile');
                    const adminVisDesktop = document.getElementById('admin-hero-vis-desktop');
                    
                    const adminHeightMobileInput = document.getElementById('admin-hero-height-mobile');
                    const adminHeightMobileDisplay = document.getElementById('admin-hero-height-mobile-display');
                    const adminHeightDesktopInput = document.getElementById('admin-hero-height-desktop');
                    const adminHeightDesktopDisplay = document.getElementById('admin-hero-height-desktop-display');

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const heroType = data.heroType || 'image'; 
                        const videoUrl = data.videoUrl;
                        const imageUrl = data.imageUrl;
                        
                        // NEW: Visibility Logic
                        const showMobile = data.visibleMobile !== false; 
                        const showDesktop = data.visibleDesktop !== false; 
                        
                        // NEW: Height Logic (Separate Defaults)
                        const heroHeightMobile = data.heroHeightMobile || 400;
                        const heroHeightDesktop = data.heroHeightDesktop || 500;

                        if (heroContainer) {
                            // Apply Height via Dynamic Style Tag for Responsiveness
                            let dynamicStyle = document.getElementById('hero-dynamic-style');
                            if (!dynamicStyle) {
                                dynamicStyle = document.createElement('style');
                                dynamicStyle.id = 'hero-dynamic-style';
                                document.head.appendChild(dynamicStyle);
                            }
                            
                            // CSS logic: Default is mobile height, change to desktop height on medium screens (md)
                            dynamicStyle.textContent = `
                                #hero-section-container { min-height: ${heroHeightMobile}px !important; }
                                @media (min-width: 768px) {
                                    #hero-section-container { min-height: ${heroHeightDesktop}px !important; }
                                }
                            `;

                            // Reset classes first
                            heroContainer.classList.remove('hidden', 'flex', 'md:hidden', 'md:flex');
                            
                            if (showMobile && showDesktop) {
                                heroContainer.classList.add('flex');
                            } else if (!showMobile && !showDesktop) {
                                heroContainer.classList.add('hidden');
                            } else if (showMobile && !showDesktop) {
                                heroContainer.classList.add('flex', 'md:hidden');
                            } else if (!showMobile && showDesktop) {
                                heroContainer.classList.add('hidden', 'md:flex');
                            }
                        }

                        // Update Admin Inputs
                        if (adminVisMobile) adminVisMobile.checked = showMobile;
                        if (adminVisDesktop) adminVisDesktop.checked = showDesktop;
                        
                        if (adminHeightMobileInput) adminHeightMobileInput.value = heroHeightMobile;
                        if (adminHeightMobileDisplay) adminHeightMobileDisplay.textContent = `${heroHeightMobile}px`;
                        
                        if (adminHeightDesktopInput) adminHeightDesktopInput.value = heroHeightDesktop;
                        if (adminHeightDesktopDisplay) adminHeightDesktopDisplay.textContent = `${heroHeightDesktop}px`;

                        // Update Media
                        if (heroType === 'video' && videoUrl) {
                            if (videoSourceEl) videoSourceEl.src = videoUrl;
                            if (videoEl) {
                                videoEl.load();
                                videoEl.classList.remove('hidden');
                            }
                            if (imageEl) imageEl.classList.add('hidden');
                        } else {
                            if (imageEl) {
                                // Updated Logic: Only show image if URL exists
                                if (imageUrl && imageUrl.trim() !== '') {
                                    imageEl.src = imageUrl;
                                    imageEl.classList.remove('hidden');
                                } else {
                                    imageEl.classList.add('hidden');
                                }
                            }
                            if (videoEl) videoEl.classList.add('hidden');
                        }

                        // Update Text
                        if (badgeTextEl && data.badgeText) badgeTextEl.textContent = data.badgeText;
                        if (titleMainEl && data.titleMain) titleMainEl.textContent = data.titleMain;
                        if (titleSubEl && data.titleSub) titleSubEl.textContent = data.titleSub;
                        if (descEl && data.description) descEl.textContent = data.description;

                        // Update Admin Form
                        if (adminHeroTypeSelect) {
                            adminHeroTypeSelect.value = heroType;
                            adminHeroTypeSelect.dispatchEvent(new Event('change'));
                        }
                        if (adminVideoUrlInput) adminVideoUrlInput.value = videoUrl || '';
                        if (adminImageUrlInput) adminImageUrlInput.value = imageUrl || '';
                        if (adminBadgeInput) adminBadgeInput.value = data.badgeText || '';
                        if (adminTitleInput) adminTitleInput.value = data.titleMain || '';
                        if (adminSubtitleInput) adminSubtitleInput.value = data.titleSub || '';
                        if (adminDescInput) adminDescInput.value = data.description || '';
                    }
                });

                // 3. Load Top Notification Bar Config
                const topbarConfigRef = doc(db, "config", "top_bar");
                onSnapshot(topbarConfigRef, (docSnap) => {
                    const topBarEl = document.getElementById('top-notification-bar');
                    const contentEl = document.getElementById('top-bar-content'); // Container for text
                    const textEl = document.getElementById('top-bar-text');
                    const highlightEl = document.getElementById('top-bar-highlight');
                    
                    const adminText = document.getElementById('admin-topbar-text');
                    const adminHighlight = document.getElementById('admin-topbar-highlight');
                    const adminVisible = document.getElementById('admin-topbar-visible');

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Update Admin Inputs
                        if (adminText) adminText.value = data.text || '';
                        if (adminHighlight) adminHighlight.value = data.highlight || '';
                        if (adminVisible) adminVisible.checked = data.visible !== false;

                        // Logic: Hide content text part if both fields are empty
                        const hasContent = (data.text && data.text.trim() !== '') || (data.highlight && data.highlight.trim() !== '');

                        if (contentEl) {
                            if (hasContent) {
                                contentEl.classList.remove('hidden');
                                if (textEl) textEl.textContent = data.text || "";
                                if (highlightEl) highlightEl.textContent = data.highlight || "";
                            } else {
                                contentEl.classList.add('hidden');
                                if (textEl) textEl.textContent = "";
                                if (highlightEl) highlightEl.textContent = "";
                            }
                        }
                        
                        // Global Visibility Toggle (Existing logic)
                        if (topBarEl) {
                            if (data.visible === false) {
                                topBarEl.classList.add('hidden');
                            } else {
                                topBarEl.classList.remove('hidden');
                            }
                        }
                    } else {
                        // If no config exists yet, hide the text part by default
                        if (contentEl) contentEl.classList.add('hidden');
                    }
                });
            }
      


            const closeMobileMenu = () => {
                const mobileMenu = document.getElementById('mobile-menu');
                const openIcon = document.getElementById('mobile-menu-open-icon');
                const closeIcon = document.getElementById('mobile-menu-close-icon');
                const mobileMenuButton = document.getElementById('mobile-menu-button');

                if (mobileMenu && openIcon && closeIcon && mobileMenuButton) {
                    mobileMenu.classList.add('hidden');
                    openIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                    mobileMenuButton.setAttribute('aria-expanded', 'false');
                }
            };

            const showPage = (pageId, itemId = null) => {
                
                console.log('showPage called with pageId:', pageId, 'and itemId:', itemId); 
                
                
                const allPages = document.querySelectorAll('.page-section');
                allPages.forEach(page => {
                    page.classList.remove('active');
                });
                
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                    if (pageId === 'cart') {
                        renderCartPage();
                    } else if (pageId === 'details' && itemId) {
                        renderProductDetails(itemId);
                        fetchAiSuggestions(itemId); 
                    } else if (pageId === 'blog-post' && itemId) {
                        renderArticleDetails(itemId);
                    } else if (pageId === 'offers') { 
                        renderOffersPage();
                    }
                } else {
                    const homePage = document.getElementById('page-home');
                    if (homePage) {
                        homePage.classList.add('active');
                    }
                }

                // NEW: Handle visibility of the top offers section based on page
                const topOffersSection = document.getElementById('current-offers-section');
                const topOffersGrid = document.getElementById('top-offers-grid'); // NEW reference

                if (topOffersSection) {
                    if (pageId === 'home') {
                         // --- OPTIMIZATION FIX: Don't re-render everything ---
                         // Removed: renderAllProductViews(); 
                         
                         // Just check if we have content to show, otherwise keep hidden
                         if (topOffersGrid && topOffersGrid.children.length > 0) {
                             topOffersSection.classList.remove('hidden');
                         }
                         // ----------------------------------------------------
                    } else {
                        topOffersSection.classList.add('hidden');
                    }
                }
                
                const lightBanner = document.getElementById('special-offer-banner-light');
                const darkBanner = document.getElementById('special-offer-banner-dark');
                
                if (lightBanner && darkBanner) {
                 

                    if (pageId === 'home') {
                        
                        lightBanner.style.transform = 'translateY(0)';
                        darkBanner.style.transform = 'translateY(0)';
                    } else {
                        
                        lightBanner.style.transform = 'translateY(-100%)';
                        darkBanner.style.transform = 'translateY(-100%)';
                    }
                }
           

                window.scrollTo(0, 0);
                closeMobileMenu();
                
                lucide.createIcons();
            };

            try {
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                const openIcon = document.getElementById('mobile-menu-open-icon');
                const closeIcon = document.getElementById('mobile-menu-close-icon');

                if (mobileMenuButton) {
                    mobileMenuButton.addEventListener('click', () => {
                        const isOpen = mobileMenu.classList.toggle('hidden');
                        openIcon.classList.toggle('hidden', !isOpen);
                        closeIcon.classList.toggle('hidden', isOpen);
                        mobileMenuButton.setAttribute('aria-expanded', !isOpen);
                    });
                }
               
                
                
                const allPages = document.querySelectorAll('.page-section');
                const allNavLinks = document.querySelectorAll('.nav-link, .logo-link, [data-category-filter]');
                const allMobileNavLinks = document.querySelectorAll('.mobile-nav-link');

                allNavLinks.forEach(link => {
                    
                    if (link.dataset.navListenerAttached) return; 
                    link.dataset.navListenerAttached = 'true';

                   
                    const categoryFilter = link.dataset.categoryFilter;
                    // NEW: Support for filter-type in nav links
                    const filterType = link.dataset.filterType;

                    if (categoryFilter || filterType) {
                        link.addEventListener('click', (e) => {
                            e.preventDefault(); 
                            const pageId = e.currentTarget.dataset.page;
                            
                            if (categoryFilter) {
                                const categoryDropdown = document.getElementById('product-category-filter');
                                if (categoryDropdown) categoryDropdown.value = categoryFilter;
                                preFilterType = 'all';
                            }
                            
                            if (filterType) {
                                preFilterType = filterType;
                                const categoryDropdown = document.getElementById('product-category-filter');
                                if (categoryDropdown) categoryDropdown.value = 'all';
                            }

                            document.getElementById('product-search-input').value = '';
                            document.getElementById('product-sort-filter').value = 'default';
                            updateSearchPlaceholder(); 
                            renderAllProductViews(); 

                            window.location.hash = `#${pageId}`; 
                        });
                    }
                    
                });
                
                allMobileNavLinks.forEach(link => {
         
                    if (link.dataset.navListenerAttached) return;
                    link.dataset.navListenerAttached = 'true';

                  
                });

                // REMOVED: Scroll event listener for Banner State (checkBannerState)
             
                const adminForm = document.getElementById('admin-settings-form');
                
                // NEW: Admin Slider Real-time Display Update (Logo Size)
                const sizeSlider = document.getElementById('admin-logo-size');
                const sizeDisplay = document.getElementById('admin-logo-size-display');
                if (sizeSlider && sizeDisplay) {
                    sizeSlider.addEventListener('input', (e) => {
                        sizeDisplay.textContent = `${e.target.value}px`;
                    });
                }

                // NEW: Admin Slider Real-time Display Update (Hero Height - Mobile)
                const heroHeightMobileSlider = document.getElementById('admin-hero-height-mobile');
                const heroHeightMobileDisplay = document.getElementById('admin-hero-height-mobile-display');
                if (heroHeightMobileSlider && heroHeightMobileDisplay) {
                    heroHeightMobileSlider.addEventListener('input', (e) => {
                        heroHeightMobileDisplay.textContent = `${e.target.value}px`;
                    });
                }

                // NEW: Admin Slider Real-time Display Update (Hero Height - Desktop)
                const heroHeightDesktopSlider = document.getElementById('admin-hero-height-desktop');
                const heroHeightDesktopDisplay = document.getElementById('admin-hero-height-desktop-display');
                if (heroHeightDesktopSlider && heroHeightDesktopDisplay) {
                    heroHeightDesktopSlider.addEventListener('input', (e) => {
                        heroHeightDesktopDisplay.textContent = `${e.target.value}px`;
                    });
                }

                if (adminForm) {
                    adminForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                      
                        if (!currentIsAdmin) {
                            showToast("ليس لديك صلاحية.");
                            return;
                        }

                        const saveBtn = document.getElementById('save-admin-settings-btn');
                        const originalBtnText = saveBtn.innerHTML;
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '...جاري الحفظ';

                        try {
                            // 0. Save Branding Settings (NEW)
                            const logoUrl = document.getElementById('admin-logo-url').value;
                            const logoSize = document.getElementById('admin-logo-size').value; // Get Size
                            
                            const brandingConfigRef = doc(db, "config", "branding");
                            // Save both URL and Size
                            await setDoc(brandingConfigRef, { logoUrl, logoSize }, { merge: true });

                            // REMOVED: 1. Save Sticky Banner Settings logic

                            // 2. Save Homepage Hero Settings
                            const heroType = document.getElementById('admin-hero-type').value;
                            const videoUrl = document.getElementById('admin-video-url').value;
                            const imageUrl = document.getElementById('admin-image-url').value;
                            const badgeText = document.getElementById('admin-hero-badge').value;
                            const titleMain = document.getElementById('admin-hero-title').value;
                            const titleSub = document.getElementById('admin-hero-subtitle').value;
                            const description = document.getElementById('admin-hero-desc').value;
                            
                            // NEW: Get Visibility & Separate Height Values
                            const visibleMobile = document.getElementById('admin-hero-vis-mobile').checked;
                            const visibleDesktop = document.getElementById('admin-hero-vis-desktop').checked;
                            const heroHeightMobile = document.getElementById('admin-hero-height-mobile').value;
                            const heroHeightDesktop = document.getElementById('admin-hero-height-desktop').value;
                            
                            const homepageConfigRef = doc(db, "config", "homepage");
                            await setDoc(homepageConfigRef, { 
                                heroType, videoUrl, imageUrl, 
                                badgeText, titleMain, titleSub, description,
                                visibleMobile, visibleDesktop, 
                                heroHeightMobile, heroHeightDesktop // Save separate height fields
                            }, { merge: true });

                            // 3. Save Top Notification Bar Settings
                            const topText = document.getElementById('admin-topbar-text').value;
                            const topHighlight = document.getElementById('admin-topbar-highlight').value;
                            const topVisible = document.getElementById('admin-topbar-visible').checked;

                            const topbarConfigRef = doc(db, "config", "top_bar");
                            await setDoc(topbarConfigRef, {
                                text: topText,
                                highlight: topHighlight,
                                visible: topVisible
                            }, { merge: true });

                            showToast("تم حفظ جميع الإعدادات بنجاح!");
                        } catch (error) {
                            console.error("Error saving config: ", error);
                            showToast("خطأ أثناء حفظ الإعدادات.");
                        } finally {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                    });
                }
               
                // --- NEW: Sitemap Generator Logic ---
                const generateSitemapBtn = document.getElementById('generate-sitemap-btn');
                const sitemapResultContainer = document.getElementById('sitemap-result-container');
                const sitemapOutput = document.getElementById('sitemap-output');
                const copySitemapBtn = document.getElementById('copy-sitemap-btn');

                if (generateSitemapBtn) {
                    generateSitemapBtn.addEventListener('click', () => {
                        if (!currentIsAdmin) {
                            showToast("هذه الميزة للمشرفين فقط.");
                            return;
                        }

                        const baseUrl = "https://macca3.shop/"; 
                        const date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                        let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <!-- Static Pages -->
    <url>
        <loc>${baseUrl}</loc>
        <lastmod>${date}</lastmod>
        <changefreq>daily</changefreq>
        <priority>1.0</priority>
    </url>
    <url>
        <loc>${baseUrl}#products</loc>
        <lastmod>${date}</lastmod>
        <changefreq>daily</changefreq>
        <priority>0.9</priority>
    </url>
    <url>
        <loc>${baseUrl}#offers</loc>
        <lastmod>${date}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>
    <url>
        <loc>${baseUrl}#blog</loc>
        <lastmod>${date}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>
    <url>
        <loc>${baseUrl}#contact</loc>
        <lastmod>${date}</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.6</priority>
    </url>`;

                        // Add Products
                        if (allProducts.length > 0) {
                            xmlContent += `\n    <!-- Products (${allProducts.length}) -->`;
                            allProducts.forEach(product => {
                                const pId = product.shortId || product.id;
                                // Use last updated date if available, else current date
                                // Note: Firestore timestamp needs conversion if used
                                xmlContent += `
    <url>
        <loc>${baseUrl}#product/${pId}</loc>
        <lastmod>${date}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>`;
                            });
                        }

                        // Add Articles
                        if (allArticles.length > 0) {
                            xmlContent += `\n    <!-- Articles (${allArticles.length}) -->`;
                            allArticles.forEach(article => {
                                const aId = article.shortId || article.id;
                                xmlContent += `
    <url>
        <loc>${baseUrl}#blog/${aId}</loc>
        <lastmod>${date}</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.7</priority>
    </url>`;
                            });
                        }

                        xmlContent += `\n</urlset>`;

                        sitemapOutput.value = xmlContent;
                        sitemapResultContainer.classList.remove('hidden');
                        showToast("تم توليد خريطة الموقع بنجاح!");
                    });
                }

                if (copySitemapBtn) {
                    copySitemapBtn.addEventListener('click', () => {
                        sitemapOutput.select();
                        document.execCommand('copy'); // Fallback
                        try {
                            navigator.clipboard.writeText(sitemapOutput.value);
                        } catch (err) {}
                        showToast("تم نسخ الكود!");
                    });
                }
                // --- END NEW LOGIC ---
                
                document.querySelectorAll('.see-all-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        preFilterType = e.currentTarget.dataset.filterType;
                        
                        
                        document.getElementById('product-search-input').value = '';
                        document.getElementById('product-category-filter').value = 'all';
                        document.getElementById('product-sort-filter').value = 'default';
                        
                        renderAllProductViews(); // Trigger immediate re-render with new filter
                    
                        window.location.hash = '#products';
                    });
                });

                // --- Order Modal Logic ---
                const orderModal = document.getElementById('order-details-modal');
                const closeOrderModalBtn = document.getElementById('close-order-modal-btn');
                const cancelOrderBtn = document.getElementById('cancel-order-btn');
                const orderForm = document.getElementById('order-details-form');
                const checkoutBtn = document.getElementById('whatsapp-checkout-btn');

                if (checkoutBtn && orderModal) {
                    checkoutBtn.addEventListener('click', () => {
                        if (cart.length === 0) {
                            showToast("سلّتك فارغة.");
                            return;
                        }
                        // Try to pre-fill name if user is logged in
                        const currentUser = auth.currentUser;
                        if (currentUser && currentUser.displayName) {
                            const nameInput = document.getElementById('order-customer-name');
                            if (nameInput && !nameInput.value) {
                                nameInput.value = currentUser.displayName;
                            }
                        }
                        orderModal.classList.remove('hidden');
                    });
                }

                const closeOrderModal = () => {
                     if (orderModal) orderModal.classList.add('hidden');
                };

                if (closeOrderModalBtn) closeOrderModalBtn.addEventListener('click', closeOrderModal);
                if (cancelOrderBtn) cancelOrderBtn.addEventListener('click', closeOrderModal);
                if (orderModal) {
                    orderModal.addEventListener('click', (e) => {
                        if (e.target === orderModal) closeOrderModal();
                    });
                }

                if (orderForm) {
                    orderForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const customerData = {
                            name: document.getElementById('order-customer-name').value.trim(),
                            phone: document.getElementById('order-customer-phone').value.trim(),
                            address: document.getElementById('order-customer-address').value.trim(),
                            notes: document.getElementById('order-notes').value.trim()
                        };
                        
                        closeOrderModal();
                        generateWhatsAppInvoice(customerData);
                    });
                }
                // -------------------------

                const contactForm = document.getElementById('contact-form');
                const successMessage = document.getElementById('form-success-message');
                if(contactForm) {
                    contactForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        if(successMessage) successMessage.classList.remove('hidden');
                        contactForm.reset();
                        setTimeout(() => {
                            if(successMessage) successMessage.classList.add('hidden');
                        }, 3000);
                    });
                }
                
                // Removed direct checkoutBtn listener here, moved to Order Modal Logic above
                
                // lucide.createIcons(); // <-- هذا هو السطر الذي يجب حذفه

                
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;

                        
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active-tab', 'text-[#ffcd00]', 'border-b-2', 'border-[#ffcd00]');
                            btn.classList.add('text-gray-500');
                        });
                        button.classList.add('active-tab', 'text-[#ffcd00]', 'border-b-2', 'border-[#ffcd00]');
                        button.classList.remove('text-gray-500');

                        
                        tabContents.forEach(content => {
                            if (content.id === `tab-content-${tabId}`) {
                                content.classList.remove('hidden');
                            } else {
                                content.classList.add('hidden');
                            }
                        });
                    });
                });

                
                // --- إضافة منطق لإظهار/إخفاء حقول لوحة التحكم ---
                const adminHeroTypeSelect = document.getElementById('admin-hero-type');
                const adminVideoContainer = document.getElementById('admin-video-url-container');
                const adminImageContainer = document.getElementById('admin-image-url-container');

                if (adminHeroTypeSelect && adminVideoContainer && adminImageContainer) {
                    adminHeroTypeSelect.addEventListener('change', () => {
                        if (adminHeroTypeSelect.value === 'video') {
                            adminVideoContainer.classList.remove('hidden');
                            adminImageContainer.classList.add('hidden');
                        } else {
                            adminVideoContainer.classList.add('hidden');
                            adminImageContainer.classList.remove('hidden');
                        }
                    });
                }
                // --- نهاية الإضافة ---


                function handleRouting() {
                    const hash = window.location.hash || '#home';
                    console.log("Routing to:", hash);

                    const allNavLinks = document.querySelectorAll('.nav-link, .logo-link');
                    const allMobileNavLinks = document.querySelectorAll('.mobile-nav-link');

                    let targetPageId = 'home'; // default
                    let targetItemId = null;
                    // MODIFIED: Added 'offers', 'terms', and 'favorites' to simplePages
                    const simplePages = ['home', 'products', 'blog', 'contact', 'cart', 'admin', 'about', 'offers', 'terms', 'favorites'];

                    if (hash.startsWith('#product/')) {
                        targetPageId = 'details';
                        // --- FIX: Robust ID cleaning (decode, remove trailing slash, trim) ---
                        targetItemId = decodeURIComponent(hash.substring('#product/'.length)).replace(/\/$/, '').trim();
                    } else if (hash.startsWith('#blog/')) {
                        targetPageId = 'blog-post';
                        // --- FIX: Robust ID cleaning ---
                        targetItemId = decodeURIComponent(hash.substring('#blog/'.length)).replace(/\/$/, '').trim();
                    } else {
                        const pageName = hash.substring(1);
                        if (simplePages.includes(pageName)) {
                            targetPageId = pageName;
                        } else {
                            targetPageId = 'home'; 
                        }
                    }
                    

                    showPage(targetPageId, targetItemId);

                    allNavLinks.forEach(link => {
                        link.classList.toggle('active', link.dataset.page === targetPageId);
                    });
                    
                    allMobileNavLinks.forEach(link => {
                        link.classList.toggle('active', link.dataset.page === targetPageId);
                    });
                }


                window.addEventListener('hashchange', handleRouting);


                handleRouting();

                // --- Scroll to Top Logic ---
                const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
                if (scrollToTopBtn) {
                    window.addEventListener('scroll', () => {
                        // Show button after scrolling down 300px
                        if (window.scrollY > 300) {
                            scrollToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
                            scrollToTopBtn.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
                        } else {
                            scrollToTopBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
                            scrollToTopBtn.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
                        }
                    }, { passive: true });

                    scrollToTopBtn.addEventListener('click', () => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
                // ---------------------------

                // --- NEW: Mobile Departments Dropdown Logic ---
                const mobileDeptBtn = document.getElementById('mobile-departments-btn');
                const mobileDeptMenu = document.getElementById('mobile-departments-menu');
                const mobileDeptIcon = document.getElementById('mobile-departments-icon');

                if (mobileDeptBtn && mobileDeptMenu) {
                    // Toggle Menu
                    mobileDeptBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isHidden = mobileDeptMenu.classList.contains('hidden');
                        if (isHidden) {
                            mobileDeptMenu.classList.remove('hidden');
                            if(mobileDeptIcon) mobileDeptIcon.style.transform = 'rotate(180deg)';
                        } else {
                            mobileDeptMenu.classList.add('hidden');
                            if(mobileDeptIcon) mobileDeptIcon.style.transform = 'rotate(0deg)';
                        }
                    });

                    // Close when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!mobileDeptBtn.contains(e.target) && !mobileDeptMenu.contains(e.target)) {
                            mobileDeptMenu.classList.add('hidden');
                            if(mobileDeptIcon) mobileDeptIcon.style.transform = 'rotate(0deg)';
                        }
                    });

                    // Close when clicking an item inside
                    const mobileDeptItems = mobileDeptMenu.querySelectorAll('.mobile-dept-item');
                    mobileDeptItems.forEach(item => {
                        item.addEventListener('click', () => {
                            mobileDeptMenu.classList.add('hidden');
                            if(mobileDeptIcon) mobileDeptIcon.style.transform = 'rotate(0deg)';
                        });
                    });
                }
                // ----------------------------------------------

                // --- Visitor Counter Logic ---
                const initVisitorCounter = async () => {
                    const visitorRef = doc(db, "site_stats", "visitor_counter");
                    const countEl = document.getElementById('visitor-count-number');
                    const statCountEl = document.getElementById('happy-customer-stat'); 
                    const headerCounterContainer = document.getElementById('header-visitor-counter'); // NEW

                    // 1. Listen for real-time updates
                    onSnapshot(visitorRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const count = docSnap.data().count || 0;
                            const formattedCount = count.toLocaleString('en-US');
                            
                            // Update Top Bar
                            if (countEl) countEl.textContent = formattedCount;
                            
                            // Update Stats Section (Syncing)
                            if (statCountEl) statCountEl.textContent = formattedCount + " +";
                            
                            // --- NEW: Reveal Header Counter when data is ready ---
                            if (headerCounterContainer) headerCounterContainer.classList.remove('hidden');
                        }
                    }, (error) => {
                        console.log("Visitor counter error (non-critical):", error);
                    });

                    // 2. Increment count only if it's a new unique visitor
                    try {
                        // Check if the user has been flagged as visited in localStorage
                        if (!localStorage.getItem('maccaStoreVisited_v1')) {
                            // New visitor: Increment count in Firestore
                            await setDoc(visitorRef, { count: increment(1) }, { merge: true });
                            
                            // Set a flag in localStorage to mark this device as visited
                            // Using '_v1' allows us to reset this later if needed by changing the key
                            localStorage.setItem('maccaStoreVisited_v1', 'true');
                            console.log("New visitor counted and flagged.");
                        } else {
                            // Returning visitor (flag exists)
                            console.log("Returning visitor. Count not incremented.");
                        }
                    } catch (error) {
                        console.error("Error incrementing visitor count:", error);
                    }
                };
                initVisitorCounter();
                // -----------------------------

                // Force hide loader after 5 seconds if something hangs (Network issues)
                setTimeout(() => {
                    if (!isInitialLoadComplete) {
                        console.warn("Forcing loader hide due to timeout");
                        hideGlobalLoader();
                    }
                }, 5000);

                // --- FAQ Accordion Logic (Updated to Max-Height Method) ---
                const initFAQ = () => {
                    const faqItems = document.querySelectorAll('.faq-item');
                    
                    faqItems.forEach(item => {
                        const header = item.querySelector('.faq-header');
                        const content = item.querySelector('.faq-content');
                        
                        if (!header || !content) return;

                        // 1. تهيئة الحالة الأولية (للسؤال المفتوح افتراضياً)
                        if (item.getAttribute('data-open') === 'true') {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }

                        // Remove any old listeners
                        const newHeader = header.cloneNode(true);
                        header.parentNode.replaceChild(newHeader, header);

                        newHeader.addEventListener('click', () => {
                            const isOpen = item.getAttribute('data-open') === 'true';
                            
                            // 2. تبديل الحالة
                            if (isOpen) {
                                // إغلاق
                                item.setAttribute('data-open', 'false');
                                content.style.maxHeight = null; 
                            } else {
                                // فتح (تحديد الارتفاع بناءً على المحتوى الداخلي)
                                item.setAttribute('data-open', 'true');
                                content.style.maxHeight = content.scrollHeight + "px";
                            }
                        });
                    });
                };
                
                // Call FAQ init
                initFAQ();
                // ---------------------------


            } catch (error) {
                console.error('Error initializing app:', error);
                document.querySelector('main').innerHTML = '<p class="text-center text-red-500">Error loading website content.</p>';
            }
        

    </script>

</body>
</html>