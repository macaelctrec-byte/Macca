<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكة للأدوات الكهربائية بالمقطم | Macca Electric Tools</title>
    <meta name="description" content="مكة للأدوات الكهربائية بالمقطم – كل ما تحتاجه من لمبات، كابلات، مفاتيح، دهانات، وأدوات كهربائية منزلية. شحن سريع وخدمة تركيب احترافية.">
    <meta name="keywords" content="مكة للأدوات الكهربائية, أدوات كهربائية المقطم, محلات كهرباء القاهرة, متجر كهرباء مكة, كابلات وأسلاك, مفاتيح وبرايز, لمبات, دهانات, مستلزمات كهرباء, توريد وتركيب كهرباء">
    <meta name="author" content="مكة للأدوات الكهربائية">
    <meta name="theme-color" content="#ffcd00">
    <meta property="og:title" content="متجر مكة | للإضاءة الحديثة والدهانات">
    <meta property="og:description" content="اكتشف تشكيلتنا الواסعة من الإضاءة الحديثة، الدهانات، والكابلات. خبرة 20 عامًا في المقطم.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://macca3.shop/"> 
    <meta property="og:image" content="https://i.postimg.cc/NfqhM3Th/photo-2025-10-28-14-04-33.jpg"> 
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="متجر مكة | للإضاءة الحديثة والدهانات">
    <meta name="twitter:description" content="خبرة 20 عامًا في الإضاءة الحديثة والدهانات بالمقطم.">
    <meta name="twitter:image" content="https://i.postimg.cc/NfqhM3Th/photo-2025-10-28-14-04-33.jpg">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffcd00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M13 3L7 12h4l-1 8 7-12h-4z'/></svg>" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffcd00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M13 3L7 12h4l-1 8 7-12h-4z'/></svg>">
    <script>
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (e.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <!-- Defer loading of non-critical scripts -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Load fonts non-blockingly -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap"></noscript>
    <style>
        body {
            font-family: 'Cairo', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Removed the misplaced 'zoom: 0.9;' rule and extra brace */

        .dark body {
            background-image: linear-gradient(to bottom, #2f2921, #19171b);
            background-attachment: fixed; 
        }
        .dark .dark\:bg-\[\#192230\] {
            background-color: transparent !important;
        }
        .dark .dark\:bg-\[\#2c2f38\] {
            background-color: #2f2921 !important; 
        }

        .dark .dark\:bg-\[\#2c2f38\]\/90 {
            background-color: rgba(47, 41, 33, 0.9) !important; 
        }
        .dark .dark\:bg-\[\#3d474e\] {
            background-color: #374151 !important; 
        }
        .dark .dark\:bg-\[\#2d2d2d\] {
            background-color: #2d2d2d !important; 
        }
        .sale-ribbon {
            position: absolute;
            top: -1px; 
            right: -1px;
            left: auto;
            width: 75px;
            height: 75px;
            overflow: hidden;
            z-index: 10;
        }
        .sale-ribbon span {
            position: absolute;
            top: 18px;
            right: -18px;
            left: auto;
            width: 100px;
            background: #ef4444; 
            color: white;
            font-size: 0.75rem; 
            font-weight: bold;
            text-align: center;
            padding: 4px 0;
            transform: rotate(45deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .star-rating {
            @apply text-[#ffcd00];
        }
        .card-hover {
            @apply transition-all duration-300 ease-in-out;
        }
        .card-hover:hover {
            @apply transform -translate-y-1 scale-105 shadow-xl;
        }
        .page-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page-section.active {
            display: block;
        }
        
        /* --- NEW DROPDOWN STYLES --- */
        #user-dropdown-menu {
            transition: opacity 0.1s ease-out, transform 0.1s ease-out;
            transform-origin: top right; /* LTR */
        }
        [dir="rtl"] #user-dropdown-menu {
            transform-origin: top left; /* RTL */
        }
        #user-dropdown-menu[data-state="closed"] {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            pointer-events: none;
        }
        #user-dropdown-menu[data-state="open"] {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        /* --- END NEW DROPDOWN STYLES --- */

        .nav-link {
            @apply relative py-2 text-sm font-medium text-gray-600 dark:text-gray-300 transition-colors duration-200;
        }
        
        .nav-link:hover {
            @apply text-[#ffcd00];
        }

        .nav-link::after {
            @apply content-[''] absolute bottom-0 w-0 h-0.5 bg-[#ffcd00] transition-all duration-300;
            right: 0;
            left: auto;
        }

        .nav-link.active {
            @apply text-[#ffcd00];
        }

        .nav-link.active::after {
            @apply w-full;
        }

        .mobile-nav-link.active {
            @apply bg-[#ffcd00] text-gray-900;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        :root {
            color-scheme: dark;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            @apply bg-gray-100 dark:bg-gray-800;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-gray-300 dark:bg-gray-600 rounded-full;
        }
        ::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-400 dark:bg-gray-500;
        }

        .prose {
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .toast-notification {
            @apply fixed bottom-6 left-1/2 -translate-x-1/2 z-50 px-6 py-3 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-semibold rounded-lg shadow-lg;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px) translateX(-50%); }
            25%, 75% { opacity: 1; transform: translateY(0) translateX(-50%); }
        }

        #chat-history {
            scroll-behavior: smooth;
        }
        .chat-message {
            @apply p-3 rounded-xl max-w-xs md:max-w-md break-words;
            animation: slideInUp 0.3s ease-out;
        }
        .user-message {
            @apply bg-blue-600 text-white self-end chat-message rounded-br-lg;
        }
        .model-message {
            @apply bg-gray-100/80 dark:bg-gray-900/50 text-gray-800 dark:text-gray-200 self-start chat-message rounded-bl-lg;
        }
        .loading-dots {
            @apply flex items-center space-x-1 p-3;
        }
        .loading-dot {
            @apply w-2 h-2 bg-gray-400 rounded-full animate-bounce;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.1s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.2s;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-recommendation-container {
            @apply flex gap-3 overflow-x-auto p-2 -mr-2 -ml-2;
            
            -webkit-mask-image: linear-gradient(to left, white 90%, transparent 100%);
            mask-image: linear-gradient(to left, white 90%, transparent 100%);
        }

        .chat-product-card {
            @apply flex-shrink-0 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden border border-gray-200 dark:border-gray-700 transition-transform duration-200 hover:scale-105;
        }
        .chat-product-card img {
            @apply w-full h-24 object-cover;
        }
        .chat-product-card-content {
            @apply p-2;
        }
        .chat-product-card-name {
            @apply text-sm font-semibold text-gray-800 dark:text-white truncate;
        }
        .chat-product-card-price {
            @apply text-xs text-gray-600 dark:text-gray-300;
        }
        .chat-product-card-btn {
            @apply block w-full text-center bg-[#ffcd00] text-gray-900 text-xs font-bold py-1 px-2 rounded-md mt-2 hover:bg-[#ffda33];
        }
        
        /* This container is no longer used */
        /*
        .suggestion-chip-container {
            @apply p-4 border-t border-white/20 dark:border-white/10 bg-white/50 dark:bg-transparent;
        }
        .suggestion-chip-scroll {
            @apply flex gap-2 flex-wrap justify-center;
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        .suggestion-chip-scroll::-webkit-scrollbar {
            display: none; 
        }
        */

        /* This new class styles the suggestions container INSIDE the chat */
        .chat-suggestions-container {
            @apply flex gap-2 flex-wrap justify-start self-start pt-2;
            animation: slideInUp 0.3s ease-out;
        }

        .suggestion-chip {
            /* Made the chips a bit smaller to fit better in the chat */
            @apply px-3 py-1.5 bg-gray-100/80 dark:bg-gray-900/50 text-gray-700 dark:text-gray-200 text-sm font-medium rounded-full cursor-pointer hover:bg-[#ffcd00] hover:text-gray-900 dark:hover:bg-[#ffcd00] dark:hover:text-gray-900 transition-all duration-200 shadow-sm border border-transparent hover:border-[#ffcd00]/50;
        }
        .ai-modal-backdrop[data-state="open"] #gemini-help-panel {
            opacity: 1; transform: translateY(0);
        }
        .ai-modal-backdrop[data-state="closed"] #gemini-help-panel {
            opacity: 0; transform: translateY(24px); /* 24px = translate-y-6 */
        }
        .ai-modal-backdrop[data-state="open"] {
            opacity: 1;
        }
        .ai-modal-backdrop[data-state="closed"] {
            opacity: 0;
        }
        .suggestion-card {
            @apply bg-white dark:bg-[#2c2f38] rounded-xl overflow-hidden shadow-md border border-[#ffcd00]/30 dark:border-[#ffcd00]/50 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 hover:border-[#ffcd00]/80;
        }
        .suggestion-card img {
            @apply w-full h-32 object-cover;
        }
        .suggestion-card-content {
            @apply p-3;
        }
        .suggestion-card-name {
            @apply text-sm font-semibold text-gray-800 dark:text-white truncate mb-1;
        }
        .suggestion-card-price {
            @apply text-sm text-gray-700 dark:text-gray-200;
        }
        .suggestion-card-btn {
            @apply block w-full text-center bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-xs font-semibold py-2 px-3 rounded-md mt-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors;
        }
        .dark .whatsapp-fab {
            background-color: rgba(255, 255, 255, 0.1) !important; 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            color: #ffcd00 !important; 
        }

        .dark .whatsapp-fab:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            color: #ffda33 !important;
        }

        /* --- NEW STYLES FOR COMPACT SUGGESTIONS --- */
        #ai-suggestions-grid .product-card-wrapper {
            @apply shadow-md border-gray-200 dark:border-gray-700;
        }
        #ai-suggestions-grid .product-card-wrapper:hover {
            @apply shadow-lg transform-none scale-100;
        }
        #ai-suggestions-grid img.object-cover {
            @apply h-32 sm:h-40; /* Smaller image */
        }
        #ai-suggestions-grid .p-4 {
            @apply p-3; /* Slightly less padding */
        }
        #ai-suggestions-grid .product-name {
            @apply text-sm; /* Smaller title */
        }
        #ai-suggestions-grid .star-rating {
            @apply mb-1 text-xs; /* Smaller stars, less margin */
        }
        #ai-suggestions-grid .text-lg {
            @apply text-base; /* Smaller price */
        }
        #ai-suggestions-grid .text-sm {
            @apply text-xs;
        }
        #ai-suggestions-grid .flex-1 {
            @apply text-xs px-3 py-1.5; /* Smaller details button */
        }
        #ai-suggestions-grid .add-to-cart-btn {
            @apply p-1.5; /* Smaller add-to-cart button */
        }
        #ai-suggestions-grid .add-to-cart-btn i {
            @apply w-4 h-4;
        }
        #ai-suggestions-grid .sale-ribbon {
            @apply w-16 h-16;
        }
        #ai-suggestions-grid .sale-ribbon span {
            @apply w-20 text-xs top-12 right-[-28px] py-0.5;
        }
        /* --- END NEW STYLES --- */
    </style>
    
</head>
<body class="bg-gray-100 dark:bg-[#192230] text-gray-800 dark:text-gray-200 selection:bg-[#ffcd00] selection:text-gray-900">

    <div id="app" class="min-h-screen flex flex-col">
        
        <header class="sticky top-0 z-50 w-full bg-white/90 dark:bg-[#2c2f38]/90 backdrop-blur-lg shadow-md border-b border-gray-200 dark:border-gray-700/50">
            <nav class="px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    
                    <a href="#home" class="logo-link flex-shrink-0 flex items-center" data-page="home">
                        <div class="flex flex-col">
                            <span class="text-xl sm:text-2xl font-bold text-[#ffcd00] leading-tight">متجر مكة</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400 -mt-1">للإضائة الحديثة والدهانات</span>
                        </div>
                    </a>
                    <div class="hidden sm:mr-6 sm:flex sm:gap-x-6">
                        <a href="#home" class="nav-link" data-page="home">
                            الرئيسية
                        </a>
                        <a href="#products" class="nav-link" data-page="products">
                            المنتجات
                        </a>
                        <a href="#blog" class="nav-link" data-page="blog">
                            المدونة
                        </a>
                        <a href="#contact" class="nav-link" data-page="contact">
                            اتصل بنا
                        </a>
                      
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="#cart" class="nav-link relative p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-page="cart" title="سلة المشتريات">
                           
                            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                            <span id="cart-count-badge" class="absolute top-0 right-0 block w-5 h-5 -mt-1 -mr-1 text-xs font-bold text-center text-gray-900 bg-[#ffcd00] rounded-full hidden">0</span>
                        </a>
                        <button id="google-login-btn" class="mr-1 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 items-center gap-2 hidden sm:inline-flex" title="تسجيل الدخول">
                         
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        
                        
                        <div id="user-info" class="relative mr-1 items-center hidden"> 
                            
                           
                            <button id="user-avatar-btn" type="button" class="p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ffcd00]">
                                <img id="user-avatar" class="w-8 h-8 rounded-full" src="https://placehold.co/32x32" alt="الصورة الرمزية للمستخدم">
                            </button>

                            
                            <div id="user-dropdown-menu" data-state="closed" class="absolute left-0 mt-2 w-48 bg-white dark:bg-[#2c2f38] rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-50"
                                 role="menu" aria-orientation="vertical" aria-labelledby="user-avatar-btn">
                                
                              
                                <a href="#admin" id="dropdown-admin-link" data-page="admin" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                    لوحة التحكم
                                </a>
                                
                                
                                <button id="google-logout-btn-dropdown" class="w-full text-right block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                    تسجيل الخروج
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center sm:hidden">
                            <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-[#ffcd00]" aria-controls="mobile-menu" aria-expanded="false">
                                <span class="sr-only">فتح القائمة الرئيسية</span>
                                <svg id="mobile-menu-open-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                                <svg id="mobile-menu-close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                </div>
            </nav>
            <div class="hidden sm:hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    <a href="#home" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800" data-page="home">الرئيسية</a>
                    <a href="#products" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800" data-page="products">المنتجات</a>
                    <a href="#blog" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800" data-page="blog">المدونة</a>
                    <a href="#contact" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800" data-page="contact">اتصل بنا</a>
                    
                    <a href="#cart" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800" data-page="cart">
                        سلة المشتريات
                        <span id="mobile-cart-count-badge" class="inline-block w-5 h-5 mr-2 text-xs font-bold text-center text-gray-900 bg-[#ffcd00] rounded-full hidden">0</span>
                    </a>
                    <a href="#" id="google-login-btn-mobile" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800">
                        تسجيل الدخول بحساب جوجل
                    </a>
                    <div id="user-info-mobile" class="hidden items-center justify-between px-3 py-2">
                        <div class="flex items-center gap-2">
                            <img id="user-avatar-mobile" class="w-8 h-8 rounded-full" src="https://placehold.co/32x32" alt="الصورة الرمزية للمستخدم">
                            <span id="user-name-mobile" class="text-base font-medium text-gray-700 dark:text-gray-200"></span>
                        </div>
                        <a href="#" id="google-logout-btn-mobile" class="block px-3 py-2 rounded-md text-base font-medium text-red-500 hover:bg-gray-200 dark:hover:bg-gray-800">
                            تسجيل الخروج
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div id="special-offer-banner-light" class="w-full bg-[#294e3a] sticky top-[64px] z-40 h-[100px] transition-transform duration-300 ease-in-out dark:hidden">
            <a href="#products" class="block h-full" title="عرض خاص">
                <img src="https://i.postimg.cc/rmD00KSG/00000.jpg" 
                     alt="عرض خاص - تقسيط 0%" 
                     class="w-full h-full object-cover"
                     onerror="this.src='https://placehold.co/1400x78/294e3a/ffffff?text=Special+Offer+Banner'">
            </a>
        </div>
        <div id="special-offer-banner-dark" class="w-full bg-[#1a2b20] sticky top-[64px] z-40 h-[100px] transition-transform duration-300 ease-in-out hidden dark:block">
            <a href="#products" class="block h-full" title="عرض خاص (وضع داكن)">
                <img src="https://i.postimg.cc/rmD00KSG/00000.jpg" 
                     alt="عرض خاص - الوضع الداكن" 
                     class="w-full h-full object-cover">
            </a>
        </div>

        <main class="px-4 sm:px-6 lg:px-8 pb-8 flex-1">
            
            <section id="page-home" class="page-section space-y-12 pt-8">
                 <div class="relative bg-[#2c2f38] rounded-xl overflow-hidden shadow-2xl" style="min-height: 350px; sm:min-height: 400px;">
                    <!-- الفيديو سيصبح مخفياً افتراضياً -->
                    <video id="hero-video" autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-30 hidden">
                        <source id="hero-video-source" src="https://assets.mixkit.co/videos/preview/mixkit-black-and-white-abstract-fragments-1345-small.mp4" type="video/mp4">
                        
                        Your browser does not support the video tag.
                    </video>
                    <!-- إضافة عنصر الصورة هنا، وسيكون مخفياً أيضاً -->
                    <img id="hero-image" src="" alt="Hero Background" class="absolute inset-0 w-full h-full object-cover opacity-30 hidden">
                    
                    <div class="relative z-10 flex flex-col justify-end items-start h-full text-right p-6 sm:p-8 lg:p-12" style="min-height: 350px; sm:min-height: 400px;">
                        <h1 class="text-2xl sm:text-4xl font-extrabold text-white leading-tight max-w-3xl">
                            متجر مكة
                        </h1>
                        <p class="mt-3 text-sm sm:text-base text-[#ffcd00] max-w-3xl">
                            كل ما هو جديد في عالم الديكور الحديث والإضاءة
                        </p>
                        <p class="mt-3 text-base sm:text-lg text-gray-200">
                            أكثر من 20 عامًا من الخبرة في قلب المقطم
                        </p>
                        
                        
                        <a href="#products" class="nav-link mt-8 inline-flex items-center gap-3 px-6 py-3 sm:px-8 bg-gradient-to-r from-[#ffcd00] to-[#ffb700] text-gray-900 font-bold text-base sm:text-lg rounded-lg shadow-xl hover:shadow-2xl hover:from-[#ffda33] hover:to-[#ffcd00] transform transition-all duration-300 hover:-translate-y-1" data-page="products">
                            <span>تصفح المنتجات</span>
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            
                <div>
                    <h2 class="text-2xl sm:text-3xl font-bold text-right mb-6">أقسامنا الرئيسية</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 sm:gap-6">
                        <a href="#products" 
                           class="nav-link card-hover group block bg-white dark:bg-[#2c2f38] p-6 rounded-2xl shadow-lg text-center transition-all duration-300" 
                           data-page="products" data-category-filter="Lighting">
                            
                            <img src="https://i.postimg.cc/7LYxshZq/51w-Sm-F3x-Kg-L-AC-SY879.jpg" 
                                 alt="لمبات وإضاءة"
                                 class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full object-cover border-4 border-transparent group-hover:border-[#ffcd00] transition-all duration-300 group-hover:scale-110 aspect-square">
                            
                            <h3 class="text-base sm:text-lg font-semibold mt-4 text-gray-800 dark:text-white transition-colors group-hover:text-[#ffcd00]">
                                لمبات وإضاءة
                            </h3>
                        </a>
                        <a href="#products" 
                           class="nav-link card-hover group block bg-white dark:bg-[#2c2f38] p-6 rounded-2xl shadow-lg text-center transition-all duration-300" 
                           data-page="products" data-category-filter="Cables">
                            
                            <img src="https://i.postimg.cc/VNLYGvks/51was-ZSe-Mw-L-AC.jpg" 
                                 alt="كابلات وأسلاك"
                                 class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full object-cover border-4 border-transparent group-hover:border-[#ffcd00] transition-all duration-300 group-hover:scale-110 aspect-square">
                            
                            <h3 class="text-base sm:text-lg font-semibold mt-4 text-gray-800 dark:text-white transition-colors group-hover:text-[#ffcd00]">
                                كابلات وأسلاك
                            </h3>
                        </a>
                        <a href="#products" 
                           class="nav-link card-hover group block bg-white dark:bg-[#2c2f38] p-6 rounded-2xl shadow-lg text-center transition-all duration-300" 
                           data-page="products" data-category-filter="Switches">
                            
                            <img src="https://i.postimg.cc/d0tqH3VV/bbbbb.jpg" 
                                 alt="مفاتيح وبرايز"
                                 class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full object-cover border-4 border-transparent group-hover:border-[#ffcd00] transition-all duration-300 group-hover:scale-110 aspect-square">
                            
                            <h3 class="text-base sm:text-lg font-semibold mt-4 text-gray-800 dark:text-white transition-colors group-hover:text-[#ffcd00]">
                                مفاتيح وبرايز
                            </h3>
                        </a>
                        <a href="#products" 
                           class="nav-link card-hover group block bg-white dark:bg-[#2c2f38] p-6 rounded-2xl shadow-lg text-center transition-all duration-300" 
                           data-page="products" data-category-filter="Paints">
                            
                            <img src="https://i.postimg.cc/HkkKFyXR/464646.jpg" 
                                 alt="دهانات"
                                 class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full object-cover border-4 border-transparent group-hover:border-[#ffcd00] transition-all duration-300 group-hover:scale-110 aspect-square">
                            
                            <h3 class="text-base sm:text-lg font-semibold mt-4 text-gray-800 dark:text-white transition-colors group-hover:text-[#ffcd00]">
                                دهانات
                            </h3>
                        </a>
                        <a href="#products" 
                           class="nav-link card-hover group block bg-white dark:bg-[#2c2f38] p-6 rounded-2xl shadow-lg text-center transition-all duration-300" 
                           data-page="products" data-category-filter="Parts">
                            
                            <img src="https://i.postimg.cc/8CP1Kcz1/pngtree-tool-electric-equipment-png-image-9135330.png" 
                                 alt="قطع غيار كهربائية"
                                 class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full object-cover border-4 border-transparent group-hover:border-[#ffcd00] transition-all duration-300 group-hover:scale-110 aspect-square">
                            
                            <h3 class="text-base sm:text-lg font-semibold mt-4 text-gray-800 dark:text-white transition-colors group-hover:text-[#ffcd00]">
                                قطع غيار كهربائية
                            </h3>
                        </a>
                    </div>
                </div>
            
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-right">العروض الحالية</h2>
                        <a href="#products" 
                           class="see-all-link text-sm font-medium text-[#ffcd00] hover:text-[#ffda33] flex items-center gap-1"
                           data-filter-type="sale">
                            <span>عرض الكل</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </a>
                    </div>
                    
                    <div id="home-offers-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4">
                        
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-right">الأكثر مبيعاً</h2>
                        <a href="#products" 
                           class="see-all-link text-sm font-medium text-[#ffcd00] hover:text-[#ffda33] flex items-center gap-1"
                           data-filter-type="bestseller">
                            <span>عرض الكل</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </a>
                    </div>
                    
                    <div id="home-bestsellers-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4">
                        
                    </div>
                </div>

                <div class="bg-white dark:bg-[#2c2f38] rounded-2xl shadow-xl overflow-hidden p-8 sm:p-12 mt-12">
                    <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-8 text-center md:text-left">

                        <div class="flex justify-center md:justify-start">
                            <div class="p-4 bg-gray-100 dark:bg-[#3d474e] rounded-full text-[#ffcd00]">
                                <i data-lucide="clipboard-check" class="w-16 h-16"></i>
                            </div>
                        </div>

                        <div class="md:col-span-2 space-y-3">
                            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">
                                خدمات التوريد والتركيب الاحترافية
                            </h2>
                            <p class="text-base sm:text-lg text-gray-600 dark:text-gray-300 leading-relaxed">
                                لسنا مجرد متجر، بل شركاء لك في النجاح. نقدم خدمات توريد متكاملة للمشاريع والشركات، مع فريق فني متخصص للتركيب يضمن لك أعلى معايير الجودة والأمان.
                            </p>
                            <a href="#contact" class="nav-link mt-4 inline-flex items-center gap-2 px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-lg hover:bg-[#ffda33] transform transition-all duration-300 hover:-translate-y-0.5" data-page="contact">
                                <span>اطلب خدمتك الآن</span>
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </a>
                        </div>
                    </div>
                </div>
            
            </section>
            
            
            <section id="page-products" class="page-section pt-8">
                <h1 class="text-3xl sm:text-4xl font-bold mb-8">جميع المنتجات</h1>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-8 items-center">
                    
                    
                    <div class="flex-grow w-full flex items-center bg-white dark:bg-[#2d2d2d] rounded-full shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
                        <div class="relative">
                            <i data-lucide="chevron-down" class="w-4 h-4 absolute top-1/2 left-3 -translate-y-1/2 text-gray-400 z-10 pointer-events-none"></i>
                            <select id="product-category-filter" class="w-auto px-4 py-3 pl-10 pr-4 rounded-full bg-gray-50 dark:bg-[#3d474e] border-none focus:border-transparent focus:ring-0 focus:z-10 text-sm font-medium text-gray-700 dark:text-gray-200 appearance-none">
                                <option value="all">جميع الأقسام</option>
                                <option value="Lighting">إضاءة</option>
                                <option value="Cables">كابلات</option>
                                <option value="Switches">مفاتيح</option>
                                <option value="Paints">دهانات</option>
                                <option value="Parts">قطع غيار</option>
                            </select>
                        </div>

                        <div class="relative flex-grow">
                            <input type="text" id="product-search-input" placeholder="ابحث في جميع الأقسام..." class="w-full px-4 py-3 pr-10 pl-4 bg-transparent border-none focus:border-transparent focus:ring-0 focus:z-10 text-gray-900 dark:text-white placeholder:text-gray-400">
                            <span class="absolute right-4 left-auto top-1/2 -translate-y-1/2 text-gray-400">
                                <i data-lucide="search" class="w-5 h-5"></i>
                            </span>
                        </div>
                    </div>

                    
                    <div class="relative w-full sm:w-auto">
                         <i data-lucide="chevron-down" class="w-4 h-4 absolute top-1/2 right-4 left-auto -translate-y-1/2 text-gray-400 z-10 pointer-events-none"></i>
                        <select id="product-sort-filter" class="w-full sm:w-auto px-4 py-3 pl-4 pr-10 rounded-full bg-white dark:bg-[#2d2d2d] border border-gray-200 dark:border-gray-700 focus:border-transparent focus:ring-0 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-lg appearance-none">
                            <option value="default">الترتيب حسب</option>
                            <option value="price-asc">السعر: من الأقل للأعلى</option>
                            <option value="price-desc">السعر: من الأعلى للأقل</option>
                        </select>
                    </div>
                    
                    
                    <button id="show-add-product-modal-btn" type="button" class="hidden items-center justify-center sm:justify-start gap-2 px-4 py-3 bg-[#ffcd00] text-gray-900 font-bold text-sm rounded-full shadow-lg hover:bg-[#ffda33] flex-shrink-0">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        <span>إضافة منتج</span>
                    </button>
                </div>
                
                
                <div id="products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4">
                    
                </div>
                <div id="no-products-message" class="hidden text-center py-12">
                    <i data-lucide="search-x" class="w-16 h-16 mx-auto text-gray-400"></i>
                    <h2 class="text-2xl font-semibold mt-4">لم يتم العثور على منتجات</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">حاول تعديل البحث أو الفلترة.</p>
                </div>
            </section>
            

            <section id="page-details" class="page-section">
                
                <div class="mb-6">
                    <a href="#products" class="nav-link inline-flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium rounded-lg shadow-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-page="products">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        <span>العودة للمنتجات</span>
                    </a>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-8 lg:gap-12 mx-auto max-w-7xl">

                    <div class="md:col-span-3">
                        <div class="bg-white dark:bg-[#2c2f38] rounded-2xl shadow-xl overflow-hidden p-6 sm:p-8">
                            
                          
                            <div class="flex flex-col-reverse md:flex-row-reverse gap-4">

                               
                                <div class="relative group flex-1">
                                    <img id="main-product-image" 
                                         src="https://placehold.co/600x600/ffffff/999999?text=Main+Product+Image" 
                                         onerror="this.src='https://placehold.co/600x600/ffffff/999999?text=صورة+المنتج+الرئيسية'"
                                         alt="صورة المنتج الرئيسية" 
                                         class="w-full h-auto object-cover rounded-lg shadow-md aspect-square">

                                    <button id="gallery-prev-btn" class="absolute top-1/2 right-2 left-auto -translate-y-1/2 z-10 p-2 bg-black/30 text-white rounded-full hover:bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                    </button>

                                    <button id="gallery-next-btn" class="absolute top-1/2 left-2 right-auto -translate-y-1/2 z-10 p-2 bg-black/30 text-white rounded-full hover:bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i data-lucide="chevron-right" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                
                            
                                <div class="flex md:flex-col gap-2 overflow-x-auto md:overflow-y-auto md:max-h-[600px] flex-shrink-0 w-full md:w-20" id="details-thumbnail-container">
                              
                                </div>
                            
                            </div>

                            
                            <div class="mt-12 hidden md:block">
                                <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">قد يعجبك أيضاً</h3>
                                
                                <div id="ai-suggestions-loading-desktop" class="hidden loading-dots justify-center py-8">
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                </div>
                                
                              
                                <div id="ai-suggestions-grid-desktop" class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4">
                                    
                                </div>
                            </div>
                          

                        </div>
                    </div>
                    <div class="md:col-span-2 flex flex-col gap-6">
                        <div class="bg-white dark:bg-[#2c2f38] rounded-2xl shadow-xl p-6 sm:p-8">
                            <span id="details-product-company" class="text-lg font-medium text-gray-500 dark:text-gray-400 mb-1 block hidden"></span>
                            <h1 id="details-product-name" class="text-3xl lg:text-4xl font-extrabold mb-4 text-gray-900 dark:text-white">جاري التحميل...</h1>
                            
                            <div id="details-star-rating" class="star-rating mb-4 text-xl">
                            
                            </div>
                            
                            <div id="details-product-price" class="mb-6">
                               
                            </div>
            
                            <p id="details-product-description" class="text-gray-600 dark:text-gray-300 leading-relaxed mb-8 break-words">
                                جاري تحميل الوصف...
                            </p>
            
                            <div id="details-add-to-cart-wrapper" class="space-y-4 product-card-wrapper"
                                 data-product-id=""
                                 data-product-name=""
                                 data-product-price=""
                                 data-product-image="">
                                
                                <div class="flex items-end gap-3">
                                    <div>
                                        <label for="details-quantity-input" class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">الكمية</label>
                                        <input type="number" id="details-quantity-input" value="1" min="1" 
                                               class="w-24 px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00] text-lg font-bold text-center">
                                    </div>
                                    
                                    <button class="add-to-cart-btn flex-1 flex items-center justify-center gap-3 px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold text-lg rounded-lg shadow-lg hover:bg-[#ffda33] transform transition-all duration-300 hover:-translate-y-0.5">
                                        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                                        <span>إضافة للسلة</span>
                                    </button>
                                </div>
                                <a id="details-whatsapp-link" href="https://wa.me/201146641942" target="_blank" class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-transparent border border-green-500 text-green-500 font-bold text-lg rounded-lg shadow-lg hover:bg-green-500 hover:text-white transform transition-all duration-300">
                                    <i data-lucide="message-circle" class="w-6 h-6"></i>
                                    <span>تواصل عبر واتساب</span>
                                </a>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-[#2c2f38] rounded-2xl shadow-xl overflow-hidden">
                            <div class="flex border-b border-gray-200 dark:border-gray-700">
                                <button class="tab-btn active-tab px-6 py-4 text-lg font-semibold text-[#ffcd00] border-b-2 border-[#ffcd00]" data-tab="specs">
                                    المواصفات
                                </button>
                                <button class="tab-btn px-6 py-4 text-lg font-semibold text-gray-500 hover:text-gray-900 dark:hover:text-white" data-tab="reviews">
                                    المراجعات (3)
                                </button>
                            </div>
                            
                            
                            <div class="p-6 sm:p-8">
                                
                                <div id="tab-content-specs" class="tab-content space-y-3">
                                    <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">تفاصيل المنتج</h3>
                                    <ul id="specs-list-container" class="space-y-3 text-base text-gray-600 dark:text-gray-300 max-w-md">
                                      
                                    </ul>
                                </div>
                            
                            
                            <div id="tab-content-reviews" class="tab-content hidden space-y-6">
                                <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">مراجعات العملاء</h3>
                                <div class="space-y-6">
                                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                                        <div class="flex items-center mb-2">
                                            <span class="font-semibold text-lg text-gray-900 dark:text-white">أحمد محمود</span>
                                            <span class="text-sm text-gray-500 mr-3">منذ أسبوع</span>
                                        </div>
                                        <div class="text-[#ffcd00] text-xl mb-2">★★★★☆</div>
                                        <p class="text-base text-gray-600 dark:text-gray-300 mt-1">منتج ممتاز وجودة عالية، لكن التوصيل تأخر قليلاً.</p>
                                    </div>
                                    <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                                        <div class="flex items-center mb-2">
                                            <span class="font-semibold text-lg text-gray-900 dark:text-white">فاطمة علي</span>
                                            <span class="text-sm text-gray-500 mr-3">منذ شهر</span>
                                        </div>
                                        <div class="text-[#ffcd00] text-xl mb-2">★★★★★</div>
                                        <p class="text-base text-gray-600 dark:text-gray-300 mt-1">رائع! أنصح به بشدة.</p>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              
                

            </section>
            
         
            <div class="mt-12 md:hidden">
                <div class="bg-white dark:bg-[#2c2f38] rounded-2xl shadow-xl overflow-hidden p-6 sm:p-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">قد يعجبك أيضاً</h3>
                    
                    <div id="ai-suggestions-loading-mobile" class="hidden loading-dots justify-center py-8">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                    
                    <div id="ai-suggestions-grid-mobile" class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4">
                        
                    </div>
                </div>
            </div>
            
            <section id="page-about" class="page-section space-y-12 pt-8">
                <div class="relative bg-white dark:bg-[#2c2f38] rounded-xl shadow-lg overflow-hidden p-8 md:p-12 text-center">
                    <h1 class="text-4xl font-bold mb-4 text-[#ffcd00]">عن متجر مكة</h1>
                    <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
                        خبرة تمتد لأكثر من 20 عامًا في قلب المقطم، نقدم كل ما هو جديد في عالم الديكور الحديث والإضاءة.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="award" class="w-10 h-10 text-[#ffcd00] flex-shrink-0"></i>
                        <div>
                            <h3 class="text-lg font-semibold">خبرة موثوقة</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">أكثر من 20 عامًا في السوق.</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="shield-check" class="w-10 h-10 text-[#ffcd00] flex-shrink-0"></i>
                        <div>
                            <h3 class="text-lg font-semibold">جودة مضمونة</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">أفضل الماركات المضمونة.</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg flex items-center gap-4">
                        <i data-lucide="truck" class="w-10 h-10 text-[#ffcd00] flex-shrink-0"></i>
                        <div>
                            <h3 class="text-lg font-semibold">توريد وتركيب</h3>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">خدمات احترافية للمشاريع.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            <h2 class="text-3xl font-bold mb-4">قصتنا</h2>
                            <p class="text-base sm:text-lg text-gray-600 dark:text-gray-300 leading-relaxed">
                                "متجر مكة للأدوات الكهربائية هو وجهتك الأولى لكل احتياجاتك الكهربائية، نقدم لك منتجات عالية الجودة بأسعار منافسة. بخبرتنا الممتدة لسنوات في المجال، نوفر لك أفضل الأدوات والماركات المضمونة، لأن الثقة بالنسبة لنا ليست خيارًا، بل هي أساس عملنا."
                            </p>
                            <p class="text-base sm:text-lg text-gray-600 dark:text-gray-300 leading-relaxed">
                                نحن لا نبيع منتجات فحسب، بل نقدم حلولاً متكاملة تشمل التوريد والتركيب للمشاريع السكنية والتجارية، بفريق فني متخصص يضمن لك الأمان والجودة.
                            </p>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold mb-4 lg:hidden">صور من المتجر</h2> <!-- Show title on mobile -->
                            <div class="grid grid-cols-2 gap-4">
                                <img src="https://i.postimg.cc/NfqhM3Th/photo-2025-10-28-14-04-33.jpg" onerror="this.src='https://placehold.co/600x400/555555/ffffff?text=المتجر+من+الداخل+1'" alt="المتجر من الداخل 1" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <img src="https://i.postimg.cc/bNjM8Qck/photo-2025-10-28-14-05-51.jpg" onerror="this.src='https://placehold.co/600x400/555555/ffffff?text=المتجر+من+الداخل+2'" alt="المتجر من الداخل 2" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <img src="https://wl-img-prd.s3-accelerate.amazonaws.com/940aa6b6-b49b-492b-8b88-a6680cb25b6c-h.jpeg" onerror="this.src='https://placehold.co/600x400/555555/ffffff?text=فريق+العمل'" alt="فريق العمل" class="w-full h-48 object-cover rounded-lg shadow-md col-span-2">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="page-blog" class="page-section pt-8">
                
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl sm:text-4xl font-bold text-center sm:text-right">مدونة ونصائح كهربائية</h1>
                    <button id="show-add-article-modal-btn" type="button" class="hidden items-center justify-center sm:justify-start gap-2 px-4 py-3 bg-[#ffcd00] text-gray-900 font-bold text-sm rounded-lg shadow-lg hover:bg-[#ffda33] flex-shrink-0">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        <span>إضافة مقالة</span>
                    </button>
                </div>

                <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card-hover bg-white dark:bg-[#2c2f38] rounded-xl shadow-lg overflow-hidden">
                        <div class="p-4 animate-pulse">
                            <div class="w-full h-40 bg-gray-200 dark:bg-gray-700 rounded-md"></div>
                            <div class="w-3/4 h-5 bg-gray-200 dark:bg-gray-700 rounded-md mt-3"></div>
                            <div class="w-full h-4 bg-gray-200 dark:bg-gray-700 rounded-md mt-4"></div>
                            <div class="w-1/4 h-4 bg-gray-200 dark:bg-gray-700 rounded-md mt-4"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="page-contact" class="page-section space-y-12 pt-8">
                
                <h1 class="text-3xl sm:text-4xl font-bold text-center mb-4">تواصل معنا</h1>
                <p class="text-xl text-gray-600 dark:text-gray-300 text-center max-w-2xl mx-auto">
                    نحن هنا لمساعدتك. سواء كان لديك سؤال عن منتج، أو تحتاج خدمة تركيب، فريقنا جاهز للرد.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg text-center transform transition-all duration-300 hover:-translate-y-1">
                        <i data-lucide="map-pin" class="w-12 h-12 text-[#ffcd00] mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">عنواننا</h3>
                        <p class="text-gray-600 dark:text-gray-300">
                            المقطم، شارع المدينة المنورة، متفرع من شارع 9، أمام مدرسة الراعي الصالح، قطعة 7987.
                        </p>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg text-center transform transition-all duration-300 hover:-translate-y-1">
                        <i data-lucide="phone" class="w-12 h-12 text-[#ffcd00] mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">اتصل بنا</h3>
                        <div class="text-gray-600 dark:text-gray-300" dir="ltr">
                            <a href="tel:0225071272" class="block hover:text-[#ffda33] transition-colors">0225071272 (هاتف المتجر)</a>
                            <a href="https://wa.me/201146641942" class="block hover:text-[#ffda33] transition-colors">01146641942 (واتساب)</a>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#2c2f38] p-6 rounded-xl shadow-lg text-center transform transition-all duration-300 hover:-translate-y-1">
                        <i data-lucide="clock" class="w-12 h-12 text-[#ffcd00] mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">ساعات العمل</h3>
                        <p class="text-gray-600 dark:text-gray-300">
                            السبت - الخميس
                            <br>
                            9:00 صباحاً - 11:00 مساءً
                        </p>
                    </div>
                </div>
                

                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg max-w-6xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <form id="contact-form" class="space-y-6">
                            <h3 class="text-2xl font-semibold mb-3">أرسل لنا رسالة</h3>
                            <div>
                                <label for="name" class="block text-sm font-medium mb-1">الاسم</label>
                                <input type="text" id="name" name="name" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="اسمك بالكامل">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium mb-1">رقم الهاتف</label>
                                <input type="tel" id="phone" name="phone" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="01xxxxxxxxx">
                            </div>
                            <div>
                                <label for="message" class="block text-sm font-medium mb-1">الرسالة</label>
                                <textarea id="message" name="message" rows="5" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="كيف يمكننا مساعدتك؟"></textarea>
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#ffda33] transition-colors">
                                إرسال الرسالة
                            </button>
                            <div id="form-success-message" class="hidden text-green-500 font-medium text-center">
                                تم إرسال رسالتك بنجاح!
                            </div>
                        </form>
                        
                        <div class="space-y-6">
                             <h3 class="text-2xl font-semibold mb-3">موقعنا على الخريطة</h3>
                            <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-md h-full min-h-[400px]">
                                <iframe 
                                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d55276.0159441113!2d31.27210741164801!3d30.00350917260086!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x1458380b09995129%3A0x6a05d34f0c476f0!2sMokattam%2C%2C%20Cairo%20Governorate%2C%20Egypt!5e0!3m2!1sen!2sus!4v1678886500000!5m2!1sen!2sus" 
                                    width="100%" 
                                    height="100%" 
                                    style="border:0;" 
                                    allowfullscreen="" 
                                    loading="lazy" 
                                    referrerpolicy="no-referrer-when-downgrade">
                                </iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="page-blog-post" class="page-section pt-8">
                
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-10 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <a href="#blog" class="nav-link font-medium text-[#ffcd00] hover:text-[#ffda33] mb-6 inline-block" data-page="blog">&larr; العودة للمدونة</a>
                    <h1 id="blog-post-title" class="text-3xl sm:text-4xl font-bold mb-6">جاري التحميل...</h1>
                    <img class="w-full h-64 object-cover rounded-lg shadow-md mb-8" 
                         id="blog-post-image"
                         src="https://placehold.co/800x400/eeeeee/777777?text=جاري+تحميل+الصورة" 
                         onerror="this.src='https://placehold.co/800x400/eeeeee/777777?text=Image+Not+Found'" 
                         alt="صورة المقالة">
                    <div id="blog-post-content-wrapper" class="prose prose-lg dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed space-y-4">
                        <p>جاري تحميل المحتوى...</p>
                    </div>
                </div>
            </section>
            
            <section id="page-blog-2" class="page-section hidden">
            </section>
            
            <section id="page-blog-3" class="page-section hidden">
            </section>
            
            <section id="page-blog-4" class="page-section hidden">
            </section>

            
            <section id="page-cart" class="page-section pt-8">
                
                <div class="flex items-center gap-3 mb-8">
                    <i data-lucide="shopping-cart" class="w-8 h-8 sm:w-10 sm:h-10 text-[#ffcd00]"></i>
                    <h1 class="text-3xl sm:text-4xl font-bold">سلة مشترياتك</h1>
                </div>
                
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg">
                    <div id="cart-items-container" class="space-y-6">
                        
                    </div>

                    <div id="cart-empty-message" class="text-center py-12 hidden">
                        <i data-lucide="shopping-cart" class="w-16 h-16 mx-auto text-gray-400"></i>
                        <h2 class="text-2xl font-semibold mt-4">سلّتك فارغة</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-2">يبدو أنك لم تقم بإضافة أي منتجات لسلتك بعد.</p>
                        <a href="#products" class="nav-link mt-6 inline-flex items-center gap-2 px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-lg hover:bg-[#ffda33]" data-page="products">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            <span>ابدأ التسوق</span>
                        </a>
                    </div>

                    <div id="cart-summary" class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6 hidden">
                        <div class="flex justify-end">
                            <div class="w-full md:w-1/3">
                                <div class="flex justify-between text-lg font-medium">
                                    <span>المجموع الفرعي:</span>
                                    <span id="cart-subtotal">0.00 EGP</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-2">
                                    <span>الشحن:</span>
                                    <span>يُحسب عند الدفع</span>
                                </div>
                                <div class="flex justify-between text-2xl font-bold mt-4">
                                    <span>الإجمالي:</span>
                                    <span id="cart-total">0.00 EGP</span>
                                </div>
                                <button id="whatsapp-checkout-btn" class="flex items-center justify-center gap-2 w-full px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-400 transition-colors mt-6">
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    <span>إتمام الطلب (عبر واتساب)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

          
            <section id="page-admin" class="page-section pt-8">
                <h1 class="text-3xl sm:text-4xl font-bold mb-8">لوحة التحكم</h1>
                
                <div class="bg-white dark:bg-[#2c2f38] p-6 sm:p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <form id="admin-settings-form" class="space-y-6">
                        <h2 class="text-2xl font-semibold mb-4">إعدادات البانر العلوي</h2>
                        
                        <div>
                            <label for="admin-light-banner-url" class="block text-sm font-medium mb-1">رابط صورة البانر (الوضع الفاتح)</label>
                            <input type="url" id="admin-light-banner-url" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://example.com/light-banner.jpg">
                        </div>
                        
                        <div>
                            <label for="admin-dark-banner-url" class="block text-sm font-medium mb-1">رابط صورة البانر (الوضع الداكن)</label>
                            <input type="url" id="admin-dark-banner-url" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://example.com/dark-banner.jpg">
                        </div>

                        <hr class="border-gray-200 dark:border-gray-700">
        
                        <h2 class="text-2xl font-semibold mb-4">إعدادات الصفحة الرئيسية</h2>
                        
                        <!-- إضافة قائمة منسدلة لاختيار النوع -->
                        <div>
                            <label for="admin-hero-type" class="block text-sm font-medium mb-1">نوع خلفية الهيرو</label>
                            <select id="admin-hero-type" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                                <option value="video">فيديو</option>
                                <option value="image">صورة</option>
                            </select>
                        </div>

                        <!-- حاوية رابط الفيديو -->
                        <div id="admin-video-url-container">
                            <label for="admin-video-url" class="block text-sm font-medium mb-1">رابط الفيديو (mp4)</label>
                            <input type="url" id="admin-video-url" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://example.com/video.mp4">
                        </div>
                        
                        <!-- حاوية رابط الصورة (مخفية افتراضياً) -->
                        <div id="admin-image-url-container" class="hidden">
                            <label for="admin-image-url" class="block text-sm font-medium mb-1">رابط الصورة (jpg/png/webp)</label>
                            <input type="url" id="admin-image-url" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://example.com/image.jpg">
                        </div>
                        
                        <button type="submit" id="save-admin-settings-btn" class="w-full px-6 py-3 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#ffda33] transition-colors">
                            حفظ الإعدادات
                        </button>
                    </form>
                </div>
            </section>
           
            
        </main>

        <footer class="bg-white dark:bg-[#2c2f38] border-t border-gray-200 dark:border-gray-700 mt-12">
            
            <div class="px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col lg:flex-row justify-between gap-10">
                    <div class="lg:w-2/5 text-center lg:text-right">
                        <a href="#home" class="nav-link inline-block" data-page="home">
                            <span class="text-2xl sm:text-3xl font-bold text-[#ffcd00]">متجر مكة</span>
                        </a>
                        <p class="mt-4 text-sm text-gray-600 dark:text-gray-300 max-w-sm mx-auto lg:mx-0">
                            متجر مكة: كل ما هو جديد في عالم الديكور الحديث والإضاءة. أكثر من 20 عامًا من الخبرة.
                        </p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 lg:w-3/5">
                        <div class="text-center sm:text-right">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">معلومات</h3>
                            <ul class="space-y-3 text-sm">
                                <li>
                                    <a href="#" id="open-terms-modal-btn" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-[#ffcd00]">
                                        <i data-lucide="shield" class="w-4 h-4 text-[#ffcd00] flex-shrink-0"></i>
                                        <span>شروط الاستخدام</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="#" id="open-help-modal-btn" class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-[#ffcd00]">
                                        <i data-lucide="help-circle" class="w-4 h-4 text-[#ffcd00] flex-shrink-0"></i>
                                        <span>مساعدة</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="text-center sm:text-right">
                            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-white mb-4">اتصل بنا</h3>
                            <ul class="space-y-3 text-sm text-gray-600 dark:text-gray-300">
                                <li class="flex items-start gap-3 justify-center sm:justify-start">
                                    <i data-lucide="phone" class="w-4 h-4 text-[#ffcd00] flex-shrink-0 mt-1"></i>
                                    <a href="tel:0225071272" class="hover:text-[#ffda33]" dir="ltr">0225071272 (المتجر)</a>
                                </li>
                                <li class="flex items-start gap-3 justify-center sm:justify-start">
                                    <i data-lucide="smartphone" class="w-4 h-4 text-[#ffcd00] flex-shrink-0 mt-1"></i>
                                    <a href="https://wa.me/201146641942" class="hover:text-[#ffda33]" dir="ltr">01146641942 (واتساب)</a>
                                </li>
                                <li class="flex items-start gap-3 justify-center sm:justify-start">
                                    <i data-lucide="mail" class="w-4 h-4 text-[#ffcd00] flex-shrink-0 mt-1"></i>
                                    <a href="mailto:macaelctrec@gmail.com" class="hover:text-[#ffda33]">macaelctrec@gmail.com</a>
                                </li>
                            </ul>
                        </div>
                    
                    </div>
                </div>
                
                
                <div class="border-t border-gray-200 dark:border-gray-700 mt-8 pt-6">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center sm:text-right">
                            &copy; 2025 متجر مكة للأدوات الكهربائية. جميع الحقوق محفوظة.
                        </p>
                        <div dir="ltr" class="text-center sm:text-left">
                            <div>
                                <span class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Developed By</span>
                                <span class="block text-sm font-semibold text-gray-900 dark:text-white">Badr Ibrahim &amp; Mostafa Mahmoud</span>
                            </div>
                            <div class="flex items-center justify-center sm:justify-start gap-3 mt-2">
                                <a href="tel:01069913150" 
                                   class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg shadow-sm hover:bg-[#ffcd00] hover:text-gray-900 dark:hover:bg-[#ffcd00] dark:hover:text-gray-900 transition-colors"
                                   title="Call 01069913150">
                                    <i data-lucide="phone-call" class="w-4 h-4"></i>
                                    <span class="sr-only">01069913150</span> 
                                </a>
                                <a href="https://badre.site/" target="_blank" rel="noopener noreferrer" 
                                   class="p-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg shadow-sm hover:bg-[#ffcd00] hover:text-gray-900 dark:hover:bg-[#ffcd00] dark:hover:text-gray-900 transition-colors"
                                   title="Visit badre.site">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                    <span class="sr-only">badre.site</span> 
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        
        <a href="https://wa.me/201146641942" target="_blank" rel="noopener noreferrer" 
           class="whatsapp-fab fixed bottom-6 right-6 z-40 bg-green-500 text-white p-3 sm:p-4 rounded-full shadow-lg transform transition-transform hover:scale-110">
            <span class="sr-only">تواصل معنا عبر واتساب</span>
            <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2M12.04 20.13C10.59 20.13 9.17 19.74 7.96 19L7.6 18.78L4.47 19.65L5.37 16.62L5.13 16.26C4.33 14.98 3.86 13.48 3.86 11.91C3.86 7.39 7.54 3.71 12.04 3.71C16.54 3.71 20.22 7.39 20.22 11.91C20.22 16.43 16.54 20.13 12.04 20.13M17.47 14.3C17.18 14.16 15.91 13.54 15.65 13.45C15.4 13.35 15.21 13.3 15.03 13.59C14.84 13.88 14.31 14.5 14.17 14.64C14.02 14.79 13.88 14.84 13.59 14.7C13.3 14.55 12.42 14.26 11.39 13.3C10.59 12.55 10.05 11.64 9.85 11.35C9.66 11.06 9.76 10.95 9.88 10.83C9.99 10.71 10.13 10.53 10.27 10.38C10.42 10.24 10.47 10.12 10.61 9.88C10.76 9.63 10.66 9.42 10.57 9.22C10.47 9.03 9.93 7.76 9.73 7.27C9.54 6.78 9.34 6.83 9.19 6.82C9.05 6.81 8.86 6.81 8.67 6.81C8.49 6.81 8.19 6.91 7.94 7.15C7.69 7.4 7.11 7.93 7.11 9.1C7.11 10.27 7.97 11.39 8.11 11.53C8.26 11.68 9.93 14.19 12.39 15.2C13.01 15.48 13.51 15.62 13.9 15.74C14.51 15.9 15.03 15.86 15.43 15.81C15.89 15.75 16.96 15.14 17.21 14.85C17.46 14.56 17.46 14.36 17.41 14.3Z"></path></svg>
        </a>
        
    </div>

    
    <!-- Modal لإضافة/تعديل المنتج -->
    <div id="add-product-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm p-4" style="animation: fadeIn 0.3s ease-out;">
        <div class="w-full max-w-3xl bg-white dark:bg-[#2c2f38] rounded-xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <h2 id="modal-title" class="text-2xl font-bold">إضافة منتج جديد</h2>
                <button id="close-add-product-modal-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 rounded-full">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="add-product-form" class="p-6 sm:p-8 space-y-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="productName" class="block text-sm font-medium mb-1">اسم المنتج</label>
                        <input type="text" id="productName" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div>
                        <label for="productCategory" class="block text-sm font-medium mb-1">القسم</label>
                        <select id="productCategory" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                            <option value="Lighting">إضاءة</option>
                            <option value="Cables">كابلات</option>
                            <option value="Switches">مفاتيح</option>
                            <option value="Paints">دهانات</option>
                            <option value="Parts">قطع غيار</option>
                            <option value="Other">أخرى</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="productImageUrls" class="block text-sm font-medium mb-1">روابط الصور (مفصولة بفاصلة)</label>
                    <textarea id="productImageUrls" rows="3" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://...image1.jpg, https://...image2.png"></textarea>
                    <p class="text-xs text-gray-500 mt-1">الصورة الأولى ستكون هي الصورة الرئيسية.</p>
                </div>
                
                <div>
                    <label for="productDescription" class="block text-sm font-medium mb-1">الوصف</label>
                    <textarea id="productDescription" rows="4" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="productPrice" class="block text-sm font-medium mb-1">السعر (EGP)</label>
                        <input type="number" id="productPrice" step="0.01" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div class="flex items-center pt-6">
                        <input type="checkbox" id="isOnSale" class="h-4 w-4 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded">
                        <label for="isOnSale" class="mr-3 text-sm font-medium">عليه عرض؟</label>
                    </div>
                    <div id="original-price-container" class="hidden">
                        <label for="originalPrice" class="block text-sm font-medium mb-1">السعر الأصلي (قبل الخصم)</label>
                        <input type="number" id="originalPrice" step="0.01" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                </div>
                
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="isBestSeller" class="h-4 w-4 text-[#ffcd00] focus:ring-[#ffcd00] border-gray-300 rounded">
                    <label for="isBestSeller" class="mr-3 text-sm font-medium">من الأكثر مبيعاً؟</label>
                </div>

                <hr class="border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold">مواصفات إضافية (اختياري)</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                    <div>
                        <label for="productCompany" class="block text-sm font-medium mb-1">الشركة</label>
                        <input type="text" id="productCompany" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div>
                        <label for="productVolts" class="block text-sm font-medium mb-1">الجهد (Volts)</label>
                        <input type="text" id="productVolts" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div>
                        <label for="productLength" class="block text-sm font-medium mb-1">الطول (Meters)</label>
                        <input type="text" id="productLength" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div>
                        <label for="productWarranty" class="block text-sm font-medium mb-1">الضمان</label>
                        <input type="text" id="productWarranty" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div>
                        <label for="productMadeIn" class="block text-sm font-medium mb-1">صنع في</label>
                        <input type="text" id="productMadeIn" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                    <div>
                        <label for="productModel" class="block text-sm font-medium mb-1">رقم الموديل</label>
                        <input type="text" id="productModel" class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                    </div>
                </div>

            </form>
            <div class="flex justify-end items-center gap-4 p-6 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                <button type="button" id="cancel-add-product-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                    إلغاء
                </button>
                <button type="submit" id="modal-submit-btn" form="add-product-form" class="px-6 py-2 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#ffda33]">
                    حفظ المنتج
                </button>
            </div>
        </div>
    </div>


    <div id="add-article-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm p-4" style="animation: fadeIn 0.3s ease-out;">
        <div class="w-full max-w-3xl bg-white dark:bg-[#2c2f38] rounded-xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <h2 id="article-modal-title" class="text-2xl font-bold">إضافة مقالة جديدة</h2>
                <button id="close-add-article-modal-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 rounded-full">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="add-article-form" class="p-6 sm:p-8 space-y-6 overflow-y-auto">
                <div>
                    <label for="articleTitle" class="block text-sm font-medium mb-1">عنوان المقالة</label>
                    <input type="text" id="articleTitle" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]">
                </div>
                
                <div>
                    <label for="articleImageUrl" class="block text-sm font-medium mb-1">رابط صورة المقالة</label>
                    <input type="text" id="articleImageUrl" required class="w-full px-4 py-3 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" placeholder="https://...image.jpg">
                </div>
                
                <hr class="border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold">محتوى المقالة</h3>
                
                <div id="article-paragraphs-container" class="space-y-4">
                 
                </div>

                <div class="flex gap-4">
                    <button type="button" id="add-paragraph-btn" class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span>إضافة فقرة</span>
                    </button>
                    <button type="button" id="add-gallery-btn" class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="image" class="w-4 h-4"></i>
                        <span>إضافة معرض صور</span>
                    </button>
                </div>
                
            </form>
            
            <div class="flex justify-end items-center gap-4 p-6 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                <button type="button" id="cancel-add-article-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                    إلغاء
                </button>
                <button type="submit" id="article-modal-submit-btn" form="add-article-form" class="px-6 py-2 bg-[#ffcd00] text-gray-900 font-bold rounded-lg shadow-md hover:bg-[#ffda33]">
                    حفظ المقالة
                </button>
            </div>
        </div>
    </div>


    <div id="terms-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 backdrop-blur-sm p-4" style="animation: fadeIn 0.3s ease-out;">
        <div class="w-full max-w-2xl bg-white dark:bg-[#2c2f38] rounded-xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-bold">شروط الاستخدام</h2>
                <button id="close-terms-modal-btn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-red-500 rounded-full">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 sm:p-8 space-y-4 overflow-y-auto prose prose-lg dark:prose-invert max-w-none">
                <h3>مرحباً بك في متجر مكة</h3>
                <p>باستخدامك لهذا الموقع، فإنك توافق على الالتزام بالشروط والأحكام التالية. يرجى قراءتها بعناية.</p>
                
                <h4>1. استخدام الموقع</h4>
                <p>يجب استخدام هذا الموقع لأغراض مشروعة فقط. يُمنع استخدامه في أي نشاط قد يشكل انتهاكًا للقوانين المحلية أو الدولية.</p>
                
                <h4>2. المنتجات والأسعار</h4>
                <p>نحن نسعى جاهدين لضمان دقة معلومات المنتجات والأسعار، ولكن قد تحدث أخطاء. نحتفظ بالحق في تصحيح أي أخطاء وتحديث المعلومات في أي وقت دون إشعار مسبق. جميع الأسعار بالجنيه المصري.</p>
                
                <h4>3. الطلبات</h4>
                <p>تعتمد عملية إتمام الطلب على توفر المنتجات. حاليًا، يتم إتمام الطلبات وتأكيدها عبر التواصل المباشر (مثل واتساب) بعد إرسال الفاتورة المبدئية من الموقع.</p>

                <h4>4. سياسة الخصوصية</h4>
                <p>نحن نحترم خصوصيتك. المعلومات التي نجمعها (مثل عند استخدام "تسجيل الدخول بحساب جوجل") تُستخدم فقط لإدارة حسابك وتسهيل عملية الطلب. نحن لا نشارك بياناتك الشخصية مع أطراف ثالثة دون موافقتك.</p>

                <h4>5. المساعد الذكي (AI)</h4>
                <p>المساعد الذكي متوفر لتقديم معلومات عن المنتجات ونصائح عامة. المعلومات المقدمة من المساعد الذكي هي لأغراض إرشادية وقد لا تكون دقيقة بنسبة 100%. للحصول على تأكيد نهائي بخصوص المواصفات أو الأسعار، يرجى التواصل مع فريقنا مباشرة.</p>
                
                <h4>6. حقوق الملكية الفكرية</h4>
                <p>جميع المحتويات على هذا الموقع، بما في ذلك النصوص، الرسومات، الشعارات، والصور، هي ملك لـ "متجر مكة" ومحمية بموجب قوانين حقوق النشر.</p>
            </div>
        </div>
    </div>

    <div id="gemini-help-modal" class="ai-modal-backdrop modal hidden fixed inset-0 z-50 flex items-end justify-end p-0 sm:p-4 bg-black/50 transition-opacity duration-300" data-state="closed">
        
        <div id="gemini-help-panel" class="w-full max-w-full sm:max-w-md max-h-[90vh] sm:max-h-[700px] flex flex-col transition-all duration-300 ease-out opacity-0 translate-y-6 rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden border bg-white/90 dark:bg-[#2c2824]/90 backdrop-blur-lg border-white/20 dark:border-white/10">
            
            <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-white/20 dark:border-white/10">
                <div class="flex items-center gap-3">
                    <span class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full items-center justify-center bg-gradient-to-br from-[#ffcd00] to-[#ffb700]">
                        <i data-lucide="sparkles" class="w-6 h-6 text-gray-900"></i>
                    </span>
                    <div>
                        <h2 class="text-base font-semibold">المساعد الذكي</h2>
                        <p class="text-xs text-gray-500 dark:text-gray-400">اسألني عن المنتجات أو اطلب نصيحة</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button id="clear-chat-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="بدء محادثة جديدة">
                        <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
                    </button>
                    <button id="close-help-modal-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="إغلاق">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <div id="chat-history" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col bg-transparent">
                <div class="model-message self-start">
                    أهلاً بك في متجر مكة! كيف يمكنني مساعدتك اليوم؟
                </div>
                
                <div id="loading-indicator" class="hidden loading-dots self-start">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
         

            <form id="help-form" class="flex-shrink-0 p-4 border-t border-white/20 dark:border-white/10 bg-transparent">
                <div class="relative flex items-center">
                    <input type="text" id="help-input" placeholder="ابحث عن منتج أو اطلب نصيحة..." class="w-full px-4 py-3 pr-12 rounded-full bg-white/80 dark:bg-gray-900/50 border border-gray-200/80 dark:border-gray-500/50 focus:border-[#ffcd00] focus:ring-[#ffcd00] transition-colors" style="padding-left: 52px;">
                    <button type="submit" class="absolute left-2 right-auto p-2.5 bg-[#ffcd00] text-gray-900 rounded-full hover:bg-[#ffda33] transition-colors shadow-sm disabled:opacity-50" style="left: 8px;">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            signOut,
            setPersistence,
            browserSessionPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query,
            Timestamp,
            deleteDoc, 
            doc,        
            updateDoc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        
        const firebaseConfig = {
          apiKey: "AIzaSyBfslkMwWAmFXLPJ_aJZgSA7-59AhoOdUY",
          authDomain: "macaelctrec-f7795.firebaseapp.com",
          projectId: "macaelctrec-f7795",
          storageBucket: "macaelctrec-f7795.firebasestorage.app",
          messagingSenderId: "915102271751",
          appId: "1:915102271751:web:38cf552556f3cc5be15da2",
          measurementId: "G-231CS0RBZD"
        };

        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 
        const provider = new GoogleAuthProvider();
 
        setPersistence(auth, browserSessionPersistence);

        
        let allProducts = [];
        let allArticles = []; 
        let modalListenerAttached = false; 
        let articleModalListenerAttached = false; 
        let currentIsAdmin = false; 
        let preFilterType = 'all'; 
        let defaultProductsCheckDone = false; 

        let aiChatHistory = [];
        const defaultSuggestions = [
            "ما هي أفضل العروض؟",
            "أبحث عن إضاءة ليد",
            "ما هي المنتجات الأكثر مبيعاً؟",
            "أحتاج مساعدة في اختيار كابل"
        ];
        
        let currentGalleryImages = [];
        let currentGalleryIndex = 0;

        
        function generateShortId(length = 5) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        
        function showToast(message) {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }


        function updateGalleryView(index) {
            const mainImgEl = document.getElementById('main-product-image');
            const thumbnailContainer = document.getElementById('details-thumbnail-container');

            if (!mainImgEl || !thumbnailContainer || currentGalleryImages.length === 0) return;


            currentGalleryIndex = (index + currentGalleryImages.length) % currentGalleryImages.length;

            const newImageUrl = currentGalleryImages[currentGalleryIndex];
            

            mainImgEl.src = newImageUrl;

            const thumbnails = thumbnailContainer.querySelectorAll('img');
            thumbnails.forEach((img, i) => {
                img.classList.toggle('border-[#ffcd00]', i === currentGalleryIndex);
                img.classList.toggle('border-transparent', i !== currentGalleryIndex);
            });
        }

        
        const loginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('google-logout-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const loginBtnMobile = document.getElementById('google-login-btn-mobile');
        const logoutBtnMobile = document.getElementById('google-logout-btn-mobile');
        const userInfoMobile = document.getElementById('user-info-mobile');
        const userAvatarMobile = document.getElementById('user-avatar-mobile');
        const userNameMobile = document.getElementById('user-name-mobile');
        
        
        
        const signInWithGoogle = (e) => {
            e.preventDefault();
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    const email = user.email;

                    if (email === "macaelctrec@gmail.com") {
                        console.log('User signed in:', user.displayName);
                        showToast(`!أهلاً بك، ${user.displayName}`);
                    } else {
                        console.warn(`Unauthorized email attempt: ${email}`);
                        signOut(auth);
                        showToast('عذراً، هذا الحساب غير مصرح له بتسجيل الدخول.');
                    }

                }).catch((error) => {
                    console.error('Google Sign-In Error:', error.message);
                    showToast('فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.');
                });
        };
 
        
        const signOutGoogle = (e) => {
            e.preventDefault(); 
            signOut(auth).then(() => {
                console.log('User signed out.');
                showToast('You have been logged out.');
            }).catch((error) => {
                console.error('Sign Out Error:', error);
            });
        };
 
        
        if(loginBtn) loginBtn.addEventListener('click', signInWithGoogle);
        if(logoutBtnMobile) logoutBtnMobile.addEventListener('click', signOutGoogle);
        if(loginBtnMobile) loginBtnMobile.addEventListener('click', signInWithGoogle);
        if(logoutBtnMobile) logoutBtnMobile.addEventListener('click', signOutGoogle);
 

        const userAvatarBtn = document.getElementById('user-avatar-btn');
        const userDropdownMenu = document.getElementById('user-dropdown-menu');

        if (userAvatarBtn && userDropdownMenu) {
            userAvatarBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                const state = userDropdownMenu.dataset.state === 'open' ? 'closed' : 'open';
                userDropdownMenu.dataset.state = state;
            });


            window.addEventListener('click', (e) => {
                if (userDropdownMenu.dataset.state === 'open') {
                    if (!userAvatarBtn.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                        userDropdownMenu.dataset.state = 'closed';
                    }
                }
            });
        }

 
        
        onAuthStateChanged(auth, (user) => {
            const isAdmin = user && user.email === "macaelctrec@gmail.com";
            currentIsAdmin = isAdmin; 
            

            const dropdownAdminLink = document.getElementById('dropdown-admin-link'); // +++ ADJUSTED THIS +++
 
            if (user) { 
                const photo = user.photoURL || 'https://placehold.co/32x32/eeeeee/777777?text=User';
                
                
                if(userInfo) userInfo.classList.remove('hidden');
                if(userInfo) userInfo.classList.add('flex');
                if(userAvatar) userAvatar.src = photo;
                
               
                if(loginBtn) loginBtn.classList.remove('sm:inline-flex'); 
        

             
                if(userInfoMobile) userInfoMobile.classList.remove('hidden');
                if(userInfoMobile) userInfoMobile.classList.add('flex');
                if(userAvatarMobile) userAvatarMobile.src = photo;
                if(userNameMobile) userNameMobile.textContent = user.displayName;
                if(loginBtnMobile) loginBtnMobile.style.display = 'none';
 
               
                const dropdownLogout = document.getElementById('google-logout-btn-dropdown');
                if (dropdownLogout) {
                    if (!dropdownLogout.dataset.listenerAttached) {
                        dropdownLogout.addEventListener('click', signOutGoogle);
                        dropdownLogout.dataset.listenerAttached = 'true';
                    }
                }
                
                const dropdownAdmin = document.getElementById('dropdown-admin-link');
                if (dropdownAdmin) {
                    if (!dropdownAdmin.dataset.listenerAttached) {
                        dropdownAdmin.addEventListener('click', (e) => {
                            
                            userDropdownMenu.dataset.state = 'closed'; 
                        });
                        dropdownAdmin.dataset.listenerAttached = 'true';
                    }
                }
 
            } else { 
                
                if(userInfo) userInfo.classList.add('hidden');
                if(userInfo) userInfo.classList.remove('flex');
                if(userAvatar) userAvatar.src = '';


                if(loginBtn) loginBtn.classList.add('sm:inline-flex'); 



                if(userInfoMobile) userInfoMobile.classList.add('hidden');
                if(userInfoMobile) userInfoMobile.classList.remove('flex');
                if(userAvatarMobile) userAvatarMobile.src = '';
                if(userNameMobile) userNameMobile.textContent = '';
                if(loginBtnMobile) loginBtnMobile.style.display = 'block';
            }

            
            const addProductBtn = document.getElementById('show-add-product-modal-btn');
            const addArticleBtn = document.getElementById('show-add-article-modal-btn'); // +++++ NEW +++++
            
            if (isAdmin) {
                if(addProductBtn) {
                    addProductBtn.classList.remove('hidden');
                    addProductBtn.classList.add('inline-flex'); 

                    
                    if (!modalListenerAttached) {
                        console.log("Admin detected. Attaching modal listener...");
                        const modal = document.getElementById('add-product-modal'); 
                        console.log("Found modal element:", modal); 
                        
                        addProductBtn.addEventListener('click', () => {
                            console.log("'Add Product' button clicked, showing modal.");
                            if (modal) {
                                modal.classList.remove('hidden');
                            } else {
                                console.error("Modal element not found!");
                            }
                        });
                        modalListenerAttached = true; 
                    }
                }


                if(addArticleBtn) {
                    addArticleBtn.classList.remove('hidden');
                    addArticleBtn.classList.add('inline-flex');

                    if (!articleModalListenerAttached) {
                        const articleModal = document.getElementById('add-article-modal');
                        if (articleModal) {
                            addArticleBtn.addEventListener('click', () => {
                                resetArticleModalToAddMode(); 
                                articleModal.classList.remove('hidden');
                            });
                            articleModalListenerAttached = true;
                        }
                    }
                }

  
                if(dropdownAdminLink) dropdownAdminLink.classList.remove('hidden'); // +++ ADJUSTED THIS +++
 
 
            } else {
                if(addProductBtn) {
                    addProductBtn.classList.add('hidden');
                    addProductBtn.classList.remove('inline-flex');
                }
                modalListenerAttached = false; 


                if(addArticleBtn) {
                    addArticleBtn.classList.add('hidden');
                    addArticleBtn.classList.remove('inline-flex');
                }
                articleModalListenerAttached = false;

               
                if(dropdownAdminLink) dropdownAdminLink.classList.add('hidden'); // +++ ADJUSTED THIS +++
 
            }
            
            renderAllProductViews(); 
            renderArticles(); 
            
            
            
            
            loadProducts(); 
            loadArticles(); 
            loadSiteConfig(); 
        });

        let cart = []; 
            const cartCountBadge = document.getElementById('cart-count-badge');
            const mobileCartCountBadge = document.getElementById('mobile-cart-count-badge');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const cartEmptyMessage = document.getElementById('cart-empty-message');
            const cartSummary = document.getElementById('cart-summary');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const cartTotalEl = document.getElementById('cart-total');

            function addToCart(product, quantity = 1) {
                if (!product.id || !product.name || !product.price || !product.image) {
                    console.error('Invalid product data:', product);
                    return;
                }
                const existingProduct = cart.find(item => item.id === product.id);
                if (existingProduct) {
                    existingProduct.quantity += quantity;
                } else {
                    cart.push({ ...product, quantity: quantity });
                }
                updateCartView();
                
                const toastMessage = quantity > 1 
                    ? `تمت إضافة ${quantity} x "${product.name}" إلى السلة!`
                    : `تمت إضافة "${product.name}" إلى السلة!`;
                showToast(toastMessage);
            }

            function updateCartView() {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

                if (totalItems > 0) {
                    cartCountBadge.textContent = totalItems;
                    mobileCartCountBadge.textContent = totalItems;
                    cartCountBadge.classList.remove('hidden');
                    mobileCartCountBadge.classList.remove('hidden');
                } else {
                    cartCountBadge.classList.add('hidden');
                    mobileCartCountBadge.classList.add('hidden');
                }
                
                if (document.getElementById('page-cart').classList.contains('active')) {
                    renderCartPage();
                }
            }

            function renderCartPage() {
                if (!cartItemsContainer || !cartEmptyMessage || !cartSummary) return;

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '';
                    cartEmptyMessage.classList.remove('hidden');
                    cartSummary.classList.add('hidden');
                } else {
                    cartEmptyMessage.classList.add('hidden');
                    cartSummary.classList.remove('hidden');
                    
                    cartItemsContainer.innerHTML = cart.map(item => `
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 border-b border-gray-200 dark:border-gray-700" data-cart-item-id="${item.id}">
                            <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover rounded-lg">
                            <div class="flex-grow text-center sm:text-left">
                                <h3 class="text-lg font-semibold">${item.name}</h3>
                                <p class="text-sm text-gray-500">${item.id}</p>
                            </div>
                            <div class="flex items-center gap-2 sm:gap-4">
                                <input type="number" value="${item.quantity}" min="1" class="cart-item-quantity w-16 px-3 py-2 rounded-lg bg-gray-100 dark:bg-[#3d474e] border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" data-product-id="${item.id}">
                                <p class="text-lg font-bold w-28 text-right">${(parseFloat(item.price) * item.quantity).toFixed(2)} EGP</p>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-400" data-product-id="${item.id}" title="Remove item">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');

                    const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
                    cartSubtotalEl.textContent = `${subtotal.toFixed(2)} EGP`;
                    cartTotalEl.textContent = `${subtotal.toFixed(2)} EGP`; 

                    addCartItemListeners();
                }
                lucide.createIcons();
            }

            function addCartItemListeners() {
                document.querySelectorAll('.remove-from-cart-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.addEventListener('click', (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        removeFromCart(productId);
                    });
                });

                document.querySelectorAll('.cart-item-quantity').forEach(input => {
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    newInput.addEventListener('change', (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        const newQuantity = parseInt(e.currentTarget.value, 10);
                        updateCartQuantity(productId, newQuantity);
                    });
                });
            }

            function removeFromCart(productId) {
                cart = cart.filter(item => item.id !== productId);
                updateCartView();
                renderCartPage();
            }

            function updateCartQuantity(productId, quantity) {
                if (quantity < 1) {
                    removeFromCart(productId);
                    return;
                }
                const product = cart.find(item => item.id === productId);
                if (product) {
                    product.quantity = quantity;
                }
                updateCartView();
                renderCartPage();
            }

            function generateWhatsAppInvoice() {
                if (cart.length === 0) {
                    showToast("سلّتك فارغة.");
                    return;
                }

                const storeName = "متجر مكة للأدوات الكهربائية";
                const phone = "201146641942"; 

                let message = `*فاتورة طلب جديد*\n`;
                message += `------------------------\n`;
                message += `*المتجر:* ${storeName}\n\n`;
                
                message += `*تفاصيل الطلب:*\n`;
                let subtotal = 0;
                cart.forEach((item, index) => {
                    const itemTotal = parseFloat(item.price) * item.quantity;
                    subtotal += itemTotal;
                    message += `${index + 1}. *${item.name}*\n`;
                    message += `   - الكمية: ${item.quantity}\n`;
                    message += `   - سعر الوحدة: ${parseFloat(item.price).toFixed(2)} جنيه\n`;
                    message += `   - إجمالي الصنف: ${itemTotal.toFixed(2)} جنيه\n\n`;
                });

                message += `------------------------\n`;
                message += `*المبلغ الإجمالي:* ${subtotal.toFixed(2)} جنيه\n\n`;
                message += `برجاء تأكيد هذا الطلب للمتابعة.`;
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;

                window.open(whatsappUrl, '_blank');
            }

            
            function setupAddToCartButtons() {
                document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';

                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const card = e.currentTarget.closest('.product-card-wrapper');
                        if (!card) return;

                        const product = {
                            id: card.dataset.productId,
                            name: card.dataset.productName,
                            price: card.dataset.productPrice,
                            image: card.dataset.productImage
                        };
                        

                        let quantityToAdd = 1;
                        const quantityInput = card.querySelector('#details-quantity-input');
                        if (quantityInput) {
                            quantityToAdd = parseInt(quantityInput.value, 10) || 1;
                            if (quantityToAdd < 1) quantityToAdd = 1;
                        }

                        
                        addToCart(product, quantityToAdd);
                    });
                });
            }
            


            
            const modal = document.getElementById('add-product-modal');
            const modalTitle = document.getElementById('modal-title'); 
            const modalSubmitBtn = document.getElementById('modal-submit-btn'); 
            
            const closeModalBtn = document.getElementById('close-add-product-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-add-product-btn');
            const addProductForm = document.getElementById('add-product-form');
            const isOnSaleCheckbox = document.getElementById('isOnSale');
            const originalPriceContainer = document.getElementById('original-price-container');

            
            
            
            
            function resetModalToAddMode() {
                if(modalTitle) modalTitle.textContent = "إضافة منتج جديد";
                if(modalSubmitBtn) modalSubmitBtn.textContent = "حفظ المنتج";
                if(addProductForm) {
                    addProductForm.reset();
                    delete addProductForm.dataset.editingId; 
                }
                if(originalPriceContainer) originalPriceContainer.classList.add('hidden');
            }

            if(closeModalBtn) closeModalBtn.addEventListener('click', () => {
                resetModalToAddMode(); 
                modal.classList.add('hidden');
            });
            if(cancelModalBtn) cancelModalBtn.addEventListener('click', () => {
                resetModalToAddMode(); 
                modal.classList.add('hidden');
            });
            
            if(isOnSaleCheckbox) isOnSaleCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    originalPriceContainer.classList.remove('hidden');
                } else {
                    originalPriceContainer.classList.add('hidden');
                }
            });
                if(addProductForm) addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const editingId = addProductForm.dataset.editingId; 

                
                const imageUrlsString = document.getElementById('productImageUrls').value;
                const imageUrls = imageUrlsString.split(',')       
                                                .map(url => url.trim())   
                                                .filter(url => url && url.length > 0); 
                const productData = { 
                    name: document.getElementById('productName').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    
                    imageUrls: imageUrls, 
                    category: document.getElementById('productCategory').value,
                    description: document.getElementById('productDescription').value,
                    isOnSale: document.getElementById('isOnSale').checked,
                    isBestSeller: document.getElementById('isBestSeller').checked,
                    originalPrice: document.getElementById('isOnSale').checked ? parseFloat(document.getElementById('originalPrice').value) : 0,
                    createdAt: Timestamp.now(),

                    
                    company: document.getElementById('productCompany').value,
                    volts: document.getElementById('productVolts').value,
                    length: document.getElementById('productLength').value,
                    warranty: document.getElementById('productWarranty').value,
                    madeIn: document.getElementById('productMadeIn').value,
                    model: document.getElementById('productModel').value
                };
                try {
                    if (editingId) {
                        
                        const productRef = doc(db, "products", editingId);
                        await updateDoc(productRef, productData);
                        showToast("تم تحديث المنتج بنجاح!");
                    } else {
                        
                        productData.createdAt = Timestamp.now(); 
                        productData.shortId = generateShortId(5); 
                        await addDoc(collection(db, "products"), productData);
                        showToast("تمت إضافة المنتج بنجاح!");
                    }
                    
                    resetModalToAddMode(); 
                    modal.classList.add('hidden'); 
                    
                } catch (error) {
                    console.error("Error saving document: ", error);
                    showToast("خطأ في حفظ المنتج. راجع الكونسول.");
                }
            });


            const articleModal = document.getElementById('add-article-modal');
            const articleModalTitle = document.getElementById('article-modal-title');
            const articleModalSubmitBtn = document.getElementById('article-modal-submit-btn');
            const closeArticleModalBtn = document.getElementById('close-add-article-modal-btn');
            const cancelArticleModalBtn = document.getElementById('cancel-add-article-btn');
            const addArticleForm = document.getElementById('add-article-form');


            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, function(match) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[match];
                });
            }


            function createParagraphBlock(title = '', body = '') {
                const container = document.getElementById('article-paragraphs-container');
                if (!container) return;

                const block = document.createElement('div');

                block.className = 'content-block paragraph-block bg-gray-50 dark:bg-[#3d474e] p-3 rounded-lg border border-gray-200 dark:border-gray-600 relative';
                block.dataset.type = 'paragraph'; 
                
                    block.innerHTML = `
                    <button type="button" class="remove-block-btn absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 z-10" title="Remove block">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    <div>
                        <label class="block text-xs font-medium mb-1 flex items-center gap-2">
                            <span class="paragraph-number text-base font-bold text-gray-500 dark:text-gray-400">1.</span>
                            <span>عنوان الفقرة (اختياري)</span>
                        </label>
                        <input type="text" class="paragraph-title w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-gray-800 border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" value="${escapeHTML(title)}">
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs font-medium mb-1">محتوى الفقرة (اكتب كل نقطة في سطر مستقل)</label>
                        <textarea class="paragraph-body w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-gray-800 border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" rows="3">${escapeHTML(body)}</textarea>
                    </div>
                `;


                block.querySelector('.remove-block-btn').addEventListener('click', () => {
                    block.remove();
                    reNumberParagraphBlocks(); 
                });

                container.appendChild(block);
                lucide.createIcons();
            }


            function createGalleryBlock(images = []) {
                const container = document.getElementById('article-paragraphs-container');
                if (!container) return;

                const block = document.createElement('div');
                block.className = 'content-block gallery-block bg-gray-50 dark:bg-[#3d474e] p-3 rounded-lg border border-gray-200 dark:border-gray-600 relative';
                block.dataset.type = 'gallery'; 
                

                const imageUrls = images.join(', ');

                    block.innerHTML = `
                    <button type="button" class="remove-block-btn absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 z-10" title="Remove block">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    <div>
                        <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                            <i data-lucide="image" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                            <span>معرض الصور</span>
                        </label>
                        <textarea class="gallery-urls w-full px-3 py-2 text-sm rounded-lg bg-white dark:bg-gray-800 border-transparent focus:border-[#ffcd00] focus:ring-[#ffcd00]" rows="3" placeholder="الصق روابط الصور، مفصولة بفاصلة...">${escapeHTML(imageUrls)}</textarea>
                    </div>
                `;


                block.querySelector('.remove-block-btn').addEventListener('click', () => {
                    block.remove();

                });

                container.appendChild(block);
                lucide.createIcons();
            }


            const addParagraphBtn = document.getElementById('add-paragraph-btn');
            if (addParagraphBtn) {
                addParagraphBtn.addEventListener('click', () => {
                    createParagraphBlock(); 
                    reNumberParagraphBlocks();
                });
            }
            
            const addGalleryBtn = document.getElementById('add-gallery-btn');
            if (addGalleryBtn) {
                addGalleryBtn.addEventListener('click', () => {
                    createGalleryBlock(); 

                });
            }


            function reNumberParagraphBlocks() {
                const container = document.getElementById('article-paragraphs-container');
                if (!container) return;
                
                let paragraphCounter = 1;
                const blocks = container.querySelectorAll('.content-block');
                
                blocks.forEach((block) => {
                    
                    if (block.dataset.type === 'paragraph') {
                        const numSpan = block.querySelector('.paragraph-number');
                        if (numSpan) {
                            numSpan.textContent = `${paragraphCounter}.`;
                        }
                        paragraphCounter++;
                    }
                });
            }

            function resetArticleModalToAddMode() {
                if(articleModalTitle) articleModalTitle.textContent = "إضافة مقالة جديدة";
                if(articleModalSubmitBtn) articleModalSubmitBtn.textContent = "حفظ المقالة";
                if(addArticleForm) {
                    addArticleForm.reset();
                    delete addArticleForm.dataset.editingId;
                }
                
                
                const container = document.getElementById('article-paragraphs-container');
                if (container) {
                    container.innerHTML = '';
                }
                createParagraphBlock();
                reNumberParagraphBlocks();
                
            }

            if(closeArticleModalBtn) closeArticleModalBtn.addEventListener('click', () => {
                resetArticleModalToAddMode();
                if(articleModal) articleModal.classList.add('hidden');
            });
            if(cancelArticleModalBtn) cancelArticleModalBtn.addEventListener('click', () => {
                resetArticleModalToAddMode();
                if(articleModal) articleModal.classList.add('hidden');
            });

            if(addArticleForm) addArticleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const editingId = addArticleForm.dataset.editingId;

                
                const contentArray = [];
                document.querySelectorAll('#article-paragraphs-container .content-block').forEach(block => {
                    const type = block.dataset.type;
                    
                    if (type === 'paragraph') {
                        const title = block.querySelector('.paragraph-title').value.trim();
                        const body = block.querySelector('.paragraph-body').value.trim();
                        
                        if (title || body) {
                            contentArray.push({ type: 'paragraph', title: title, body: body });
                        }
                    } else if (type === 'gallery') {
                        const urlsText = block.querySelector('.gallery-urls').value;
                        const images = urlsText.split(',')
                                            .map(url => url.trim())
                                            .filter(url => url.length > 0);
                        
                        if (images.length > 0) {
                            contentArray.push({ type: 'gallery', images: images });
                        }
                    }
                });
                

                const articleData = {
                    title: document.getElementById('articleTitle').value,
                    imageUrl: document.getElementById('articleImageUrl').value,
                    
                    content: contentArray,
                };

                try {
                    if (editingId) {
                        
                        const articleRef = doc(db, "articles", editingId);
                        await updateDoc(articleRef, articleData);
                        showToast("تم تحديث المقالة بنجاح!");
                    } else {
                        
                        articleData.createdAt = Timestamp.now();
                        articleData.shortId = generateShortId(5); 
                        await addDoc(collection(db, "articles"), articleData);
                        showToast("تمت إضافة المقالة بنجاح!");
                    }
                    resetArticleModalToAddMode();
                    if(articleModal) articleModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving article: ", error);
                    showToast("خطأ في حفظ المقالة. راجع الكونسول.");
                }
            });
            


            function renderProductCard(product) {
                
                
                const mainImg = (product.imageUrls && product.imageUrls[0]) ? product.imageUrls[0] : (product.imageUrl || 'https://placehold.co/400x400/eeeeee/777777?text=Image+Error');

                const priceHTML = product.isOnSale
                    ? `<div class="flex items-baseline gap-1.5">
                           <span class="text-lg font-bold text-[#ffcd00]">${product.price.toFixed(2)} EGP</span>
                           <span class="text-sm text-gray-500 dark:text-gray-400 line-through">${product.originalPrice.toFixed(2)} EGP</span>
                       </div>`
                    : `<div class="flex items-baseline gap-1.5">
                           <span class="text-lg font-bold text-gray-900 dark:text-white">${product.price.toFixed(2)} EGP</span>
                        </div>`;

                let saleBadge = '';
                if (product.isOnSale && product.originalPrice && product.originalPrice > product.price) {
                    const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                    if (discountPercent > 0) {
                        
                        saleBadge = `
                            <div class="sale-ribbon">
                                <span>خصم ${discountPercent}%</span>
                            </div>`;
                    } else {
                        
                        saleBadge = `
                            <div class="sale-ribbon">
                                <span>عرض</span>
                            </div>`;
                    }
                } else if (product.isOnSale) {
                    
                    saleBadge = `
                        <div class="sale-ribbon">
                            <span>عرض</span>
                        </div>`;
                }
                
                
                let descriptionSnippet = '';
                if (product.description && product.description.trim() !== '') {
                    const words = product.description.split(' ');
                    } else if (product.isOnSale) {
                    
                    saleBadge = `
                        <div class="sale-ribbon">
                            <span>Sale</span>
                        </div>`;
                }
                
                
                
                
                const deleteButtonHTML = currentIsAdmin
                    ? `<button class="delete-product-btn p-1.5 bg-red-600 text-white rounded-full hover:bg-red-700" title="حذف المنتج" data-product-id="${product.id}">
                           <i data-lucide="trash-2" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                
                const editButtonHTML = currentIsAdmin
                    ? `<button class="edit-product-btn p-1.5 bg-blue-600 text-white rounded-full hover:bg-blue-700" title="تعديل المنتج" data-product-id="${product.id}">
                           <i data-lucide="edit-3" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                const adminButtonsHTML = currentIsAdmin
                    ? `<div class="absolute top-3 right-3 z-10 flex flex-col gap-1.5">
                            ${editButtonHTML}
                            ${deleteButtonHTML}
                       </div>`
                    : '';
                
                


                return `
                <div class="product-card-wrapper bg-white dark:bg-[#2c2f38] rounded-2xl overflow-hidden shadow-md border border-gray-200 dark:border-gray-700 flex flex-col transition-all duration-300 hover:shadow-xl hover:border-[#ffcd00]/50"
                     data-product-id="${product.id}"
                     data-product-name="${product.name}"
                     data-product-price="${product.price}"
                     data-product-image="${mainImg}">
                    
                    
                    
                    <div class="relative overflow-hidden">
                        ${saleBadge}
                        <a href="#product/${product.shortId || product.id}" class="product-details-link" data-product-id="${product.id}">
                            <img class="w-full h-36 sm:h-48 lg:h-56 object-cover" 
                                 src="${mainImg}" 
                                 onerror="this.src='https://placehold.co/400x400/eeeeee/777777?text=Image+Error'"
                                 alt="${product.name}">
                        </a>
                        ${adminButtonsHTML}
                    </div>

                    <div class="p-4 flex-grow flex flex-col">
                        
                        <div class="flex justify-between items-start gap-2 mb-2">
                            <a href="#product/${product.shortId || product.id}" class="product-details-link flex-grow truncate" data-product-id="${product.id}" title="${product.name}">
                                <h3 class="text-base font-semibold text-gray-800 dark:text-white product-name">${product.name}</h3>
                            </a>
                        </div>
                        
                        
                        

                        
                        <div class="star-rating mb-2 text-sm">
                            ${generateStarRating()}
                        </div>
                        

                        <div class="mt-auto pt-2 space-y-3">
                            <div class="flex items-center justify-between gap-4">
                                ${priceHTML}
                            </div>
                            
                            
                            <div class="flex items-center gap-2">
                                <a href="#product/${product.shortId || product.id}" class="product-details-link flex-1 text-center px-4 py-2 bg-transparent border border-[#ffcd00] text-[#ffcd00] text-sm font-semibold rounded-lg hover:bg-[#ffcd00] hover:text-gray-900 dark:hover:text-gray-900 transition-colors" data-product-id="${product.id}">
                                    عرض التفاصيل
                                </a>
                                <button class="add-to-cart-btn flex-shrink-0 p-2 bg-[#ffcd00] text-gray-900 rounded-lg shadow-lg hover:bg-[#ffda33] transition-all duration-300" title="إضافة للسلة">
                                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                 </button>
                            </div>
                            
                        </div>
                    </div>
                </div>`;
            }

            
            function generateStarRating() {
                
                const rating = Math.floor(Math.random() * 3) + 3;
                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) {
                        starsHTML += '<span>★</span>';
                    } else {
                        starsHTML += '<span class="text-gray-300 dark:text-gray-600">☆</span>';
                    }
                }
                return starsHTML;
            }
            

            function renderAllProductViews() {
                
                const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
                const category = document.getElementById('product-category-filter').value;
                const sort = document.getElementById('product-sort-filter').value;

                
                let filteredProducts = allProducts;

                
                if (preFilterType === 'sale') {
                    filteredProducts = allProducts.filter(p => p.isOnSale);
                } else if (preFilterType === 'bestseller') {
                    filteredProducts = allProducts.filter(p => p.isBestSeller);
                }
                

                
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm)
                );

                if (category !== 'all') {
                    filteredProducts = filteredProducts.filter(p => p.category === category);
                }

                
                if (sort === 'price-asc') {
                    filteredProducts.sort((a, b) => a.price - b.price);
                } else if (sort === 'price-desc') {
                    filteredProducts.sort((a, b) => b.price - a.price);
                }

                const offersGrid = document.getElementById('home-offers-grid');
                const bestsellersGrid = document.getElementById('home-bestsellers-grid');
                const productsGrid = document.getElementById('products-grid');
                const noProductsMessage = document.getElementById('no-products-message');

                if (!offersGrid || !bestsellersGrid || !productsGrid) return;

                
                offersGrid.innerHTML = '';
                bestsellersGrid.innerHTML = '';
                productsGrid.innerHTML = '';

                const offers = allProducts.filter(p => p.isOnSale).slice(0, 6); 
                const bestsellers = allProducts.filter(p => p.isBestSeller).slice(0, 6); 

                offers.forEach(p => offersGrid.innerHTML += renderProductCard(p));
                bestsellers.forEach(p => bestsellersGrid.innerHTML += renderProductCard(p));
                
                if (filteredProducts.length === 0) {
                    productsGrid.innerHTML = ''; 
                    productsGrid.classList.add('hidden'); 
                    noProductsMessage.classList.remove('hidden');
                } else {
                    noProductsMessage.classList.add('hidden');
                    productsGrid.classList.remove('hidden'); 
                    productsGrid.innerHTML = ''; 
                    filteredProducts.forEach(p => productsGrid.innerHTML += renderProductCard(p));
                }

                
                setupAddToCartButtons();
                setupDeleteProductButtons(); 
                setupEditProductButtons(); 
                // setupProductDetailsLinks(); // No longer needed, router handles this
                lucide.createIcons();
            }

            function setupDeleteProductButtons() {
                document.querySelectorAll('.delete-product-btn').forEach(btn => {
                    
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const productId = e.currentTarget.dataset.productId;
                        if (!productId) return;

                        
                        
                        console.log("Attempting to delete product:", productId);
                        await deleteProduct(productId);
                    });
                });
            }

            function setupEditProductButtons() {
                document.querySelectorAll('.edit-product-btn').forEach(btn => {
                    
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const productId = e.currentTarget.dataset.productId;
                        if (!productId) return;

                        const product = allProducts.find(p => p.id === productId);
                        if (product) {
                            openEditModal(product);
                        } else {
                            console.error("Product not found for editing:", productId);
                        }
                    });
                });
            }

            
            function openEditModal(product) {
                if (!modal || !addProductForm || !modalTitle || !modalSubmitBtn) return;

                
                modalTitle.textContent = "تعديل المنتج";
                modalSubmitBtn.textContent = "تحديث المنتج";
                addProductForm.dataset.editingId = product.id; 

                
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productPrice').value = product.price || 0;
                
                
                document.getElementById('productImageUrls').value = (product.imageUrls || []).join(', ');
                
                document.getElementById('productCategory').value = product.category || 'Other';
                document.getElementById('productDescription').value = product.description || '';
                
                
                const saleCheck = document.getElementById('isOnSale');
                const bestsellerCheck = document.getElementById('isBestSeller');
                saleCheck.checked = product.isOnSale || false;
                bestsellerCheck.checked = product.isBestSeller || false;

                
                if (product.isOnSale) {
                    originalPriceContainer.classList.remove('hidden');
                    document.getElementById('originalPrice').value = product.originalPrice || 0;
                } else {
                    originalPriceContainer.classList.add('hidden');
                    document.getElementById('originalPrice').value = '';
                }

                
                document.getElementById('productCompany').value = product.company || '';
                document.getElementById('productVolts').value = product.volts || '';
                document.getElementById('productLength').value = product.length || '';
                document.getElementById('productWarranty').value = product.warranty || '';
                document.getElementById('productMadeIn').value = product.madeIn || '';
                document.getElementById('productModel').value = product.model || '';
                
                
                modal.classList.remove('hidden');
            }


            
            function renderArticleCard(article) {
                const deleteButtonHTML = currentIsAdmin
                    ? `<button class="delete-article-btn p-1.5 sm:p-2 bg-red-600 text-white rounded-lg hover:bg-red-700" title="حذف المقالة" data-article-id="${article.id}">
                           <i data-lucide="trash-2" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                const editButtonHTML = currentIsAdmin
                    ? `<button class="edit-article-btn p-1.5 sm:p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" title="تعديل المقالة" data-article-id="${article.id}">
                           <i data-lucide="edit-3" class="w-4 h-4"></i>
                       </button>`
                    : '';
                
                
                let previewText = 'اضغط لقراءة المزيد...';
                if (Array.isArray(article.content) && article.content.length > 0) {
                    
                    const firstBlock = article.content.find(b => b.body);
                    if (firstBlock) {
                        previewText = firstBlock.body.substring(0, 100) + '...';
                    } else if (article.content[0].title) {
                        
                        previewText = article.content[0].title;
                    }
                } else if (typeof article.content === 'string' && article.content) {
                    
                    previewText = (article.content.replace(/<[^>]+>/g, '').substring(0, 100) || 'اضغط لقراءة المزيد') + '...';
                }
                

                return `
                <div class="card-hover bg-white dark:bg-[#2c2f38] rounded-xl shadow-lg overflow-hidden flex flex-col">
                    <img class="w-full h-40 object-cover" src="${article.imageUrl}" onerror="this.src='https://placehold.co/400x250/eeeeee/777777?text=Image+Not+Found'" alt="${article.title}">
                    <div class="p-4 flex-grow flex flex-col">
                        <h2 class="text-lg font-semibold mb-2">${article.title}</h2>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4 flex-grow">
                            ${previewText}
                        </p>
                        <div class="flex items-center justify-between">
                            <a href="#blog/${article.shortId || article.id}" class="article-details-link font-medium text-[#ffcd00] hover:text-[#ffda33]" data-article-id="${article.id}">اقرأ المزيد &larr;</a>
                            <div class="flex gap-2">
                                ${editButtonHTML}
                                ${deleteButtonHTML}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            function renderArticles() {
                const blogGrid = document.getElementById('blog-grid');
                if (!blogGrid) return;

                if (allArticles.length === 0) {
                    blogGrid.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-1 md:col-span-2 lg:col-span-3 text-center">لم يتم العثور على مقالات. تحقق مرة أخرى لاحقاً!</p>';
                    return;
                }

                blogGrid.innerHTML = '';
                allArticles.forEach(article => {
                    blogGrid.innerHTML += renderArticleCard(article);
                });


                setupDeleteArticleButtons();
                setupEditArticleButtons();
                lucide.createIcons();
            }

            function setupArticleDetailsLinks() {
                document.querySelectorAll('.article-details-link').forEach(link => {
                    if (link.dataset.listenerAttached) return;
                    link.dataset.listenerAttached = 'true';
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const articleId = e.currentTarget.dataset.articleId;
                        showPage('blog-post', articleId);
                    });
                });
            }

            function setupDeleteArticleButtons() {
                document.querySelectorAll('.delete-article-btn').forEach(btn => {
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const articleId = e.currentTarget.dataset.articleId;
                        if (!articleId) return;
                        
                        await deleteArticle(articleId);
                    });
                });
            }

            async function deleteArticle(id) {
                try {
                    const articleRef = doc(db, "articles", id);
                    await deleteDoc(articleRef);
                    showToast("تم حذف المقالة بنجاح.");
                } catch (error) {
                    console.error("Error deleting article: ", error);
                    showToast("خطأ: لم نتمكن من حذف المقالة.");
                }
            }

            function setupEditArticleButtons() {
                document.querySelectorAll('.edit-article-btn').forEach(btn => {
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const articleId = e.currentTarget.dataset.articleId;
                        if (!articleId) return;
                        const article = allArticles.find(a => a.id === articleId);
                        if (article) {
                            openEditArticleModal(article);
                        }
                    });
                });
            }

            function openEditArticleModal(article) {
                if (!articleModal || !addArticleForm || !articleModalTitle || !articleModalSubmitBtn) return;

                articleModalTitle.textContent = "تعديل المقالة";
                articleModalSubmitBtn.textContent = "تحديث المقالة";
                addArticleForm.dataset.editingId = article.id;

                document.getElementById('articleTitle').value = article.title || '';
                document.getElementById('articleImageUrl').value = article.imageUrl || '';
                
                
                const container = document.getElementById('article-paragraphs-container');
                if (container) {
                    container.innerHTML = '';
                }
                
                
                if (Array.isArray(article.content) && article.content.length > 0) {
                    article.content.forEach(block => {
                        const type = block.type || 'paragraph';
                        if (type === 'paragraph') {
                            createParagraphBlock(block.title, block.body);
                        } else if (type === 'gallery') {
                            createGalleryBlock(block.images);
                        }
                    });
                } else if (typeof article.content === 'string' && article.content) {
                    
                    
                    createParagraphBlock('', article.content);
                } else {
                    
                    createParagraphBlock();
                }
                reNumberParagraphBlocks();
                
                
                

                articleModal.classList.remove('hidden');
            }

            function renderArticleDetails(articleId) {
                const article = allArticles.find(a => a.shortId === articleId || a.id === articleId);
                if (!article) {
                    showPage('blog');
                    return;
                }

                const titleEl = document.getElementById('blog-post-title');
                const imageEl = document.getElementById('blog-post-image');
                const contentEl = document.getElementById('blog-post-content-wrapper');

                if (titleEl) titleEl.textContent = article.title;
                if (imageEl) {
                    imageEl.src = article.imageUrl;
                    imageEl.alt = article.title;
                }
                
                
                if (contentEl) {
                    let finalHtml = '';
                    let paragraphCounter = 1;
                    
                    
                    if (Array.isArray(article.content)) {
                        article.content.forEach((block) => {
                            const type = block.type || 'paragraph';

                            if (type === 'paragraph') {
                                if (block.title) {
                                    const safeTitle = escapeHTML(block.title);
                                    
                                    finalHtml += `<h2>${paragraphCounter}. ${safeTitle}</h2>\n`;
                                }
                                
                                if (block.body) {
                                    const lines = block.body.split('\n')
                                                        .map(line => line.trim())
                                                        .filter(line => line.length > 0);
                                    
                                    if (lines.length > 0) {
                                        finalHtml += '<ul>\n';
                                        lines.forEach(line => {
                                            finalHtml += `<li>${escapeHTML(line)}</li>\n`;
                                        });
                                        finalHtml += '</ul>\n';
                                    }
                                }
                                paragraphCounter++;
                            
                            } else if (type === 'gallery' && block.images && block.images.length > 0) {
                                
                                
                                finalHtml += '<div class="not-prose grid grid-cols-2 md:grid-cols-3 gap-2 my-4">\n';
                                block.images.forEach(url => {
                                    finalHtml += `
                                        <div>
                                            <img src="${escapeHTML(url)}" 
                                                 class="w-full h-auto object-cover rounded-md shadow-md aspect-square" 
                                                 onerror="this.src='https://placehold.co/400x400/eeeeee/777777?text=Image+Error'" 
                                                 alt="Gallery Image">
                                        </div>\n`;
                                });
                                finalHtml += '</div>\n';
                                
                            }
                        });
                    } else if (typeof article.content === 'string') {
                        
                        
                        finalHtml = article.content;
                    }
                    
                    contentEl.innerHTML = finalHtml || '<p>لا يوجد محتوى متاح.</p>';
                }
                
            }

            

            
            function setupProductDetailsLinks() {
                document.querySelectorAll('.product-details-link').forEach(btn => {
                    
                    if (btn.dataset.listenerAttached) return;
                    btn.dataset.listenerAttached = 'true';
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        const productId = e.currentTarget.dataset.productId;
                        
                        console.log('Details link clicked, Product ID:', productId); 
                        if (!productId) {
                            console.error("Product ID is missing from the button!");
                            return;
                        }
                        
                        showPage('details', productId);
                    });
                });
            }


            
            async function deleteProduct(id) {
                try {
                    const productRef = doc(db, "products", id);
                    await deleteDoc(productRef);
                    showToast("تم حذف المنتج بنجاح.");
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showToast("خطأ: لم نتمكن من حذف المنتج.");
                }
            }

            
            function renderProductDetails(productId) {
                
                console.log('renderProductDetails called for:', productId); 
                const product = allProducts.find(p => p.shortId === productId || p.id === productId);
                
                if (!product) {
                    console.error("Product not found in allProducts array:", productId);
                    showPage('products'); 
                    return;
                }

                
                console.log('Product found:', product); 

                
                const placeholder = 'https://placehold.co/150x150/eeeeee/777777?text=...';
                const mainImgEl = document.getElementById('main-product-image');
                const thumbnailContainer = document.getElementById('details-thumbnail-container');

                
                thumbnailContainer.innerHTML = '';

                
                const imageUrls = (product.imageUrls && product.imageUrls.length > 0) 
                                    ? product.imageUrls 
                                    : [product.imageUrl || placeholder];
                
                
                currentGalleryImages = imageUrls;
                currentGalleryIndex = 0;
                
                
                mainImgEl.src = imageUrls[0];

                
                imageUrls.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Thumbnail ${index + 1}`;
                    img.onerror = function() { this.src = placeholder; };
                    img.className = "cursor-pointer rounded-md border-2 hover:border-[#ffcd00] transition-all duration-200 object-cover w-20 h-20 md:w-full md:h-auto md:aspect-square";
                    
                    
                    if (index === 0) {
                        img.classList.add('border-[#ffcd00]');
                        img.classList.remove('border-transparent');
                    } else {
                        img.classList.add('border-transparent');
                    }

                    
                    img.addEventListener('click', () => {
                        
                        updateGalleryView(index);
                    });
                    
                    thumbnailContainer.appendChild(img);
                });

                
                const prevBtn = document.getElementById('gallery-prev-btn');
                const nextBtn = document.getElementById('gallery-next-btn');
                
                
                const newPrevBtn = prevBtn.cloneNode(true);
                prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
                
                const newNextBtn = nextBtn.cloneNode(true);
                nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);

                newPrevBtn.addEventListener('click', () => {
                    updateGalleryView(currentGalleryIndex - 1);
                });
                
                newNextBtn.addEventListener('click', () => {
                    updateGalleryView(currentGalleryIndex + 1);
                });
                
                const companyEl = document.getElementById('details-product-company');
                if (companyEl) {
                    if (product.company && product.company.trim() !== '') {
                        companyEl.textContent = product.company;
                        companyEl.classList.remove('hidden');
                    } else {
                        companyEl.textContent = '';
                        companyEl.classList.add('hidden');
                    }
                }

                document.getElementById('details-product-name').textContent = product.name;
                
                const detailsRatingEl = document.getElementById('details-star-rating');
                if (detailsRatingEl) {
                    detailsRatingEl.innerHTML = generateStarRating();
                }

                document.getElementById('details-product-description').textContent = product.description || "لا يوجد وصف متاح لهذا المنتج.";

                
                const priceEl = document.getElementById('details-product-price');
                
                priceEl.classList.add('bg-gray-100', 'dark:bg-gray-700', 'p-4', 'rounded-lg', 'border', 'border-gray-200', 'dark:border-gray-600');

                if (product.isOnSale && product.originalPrice && product.originalPrice > product.price) {
                    const discountAmount = product.originalPrice - product.price;
                    const discountPercent = Math.round((discountAmount / product.originalPrice) * 100);
                    priceEl.innerHTML = `
                        <div class="flex items-baseline gap-3">
                            <span class="text-3xl lg:text-4xl font-bold text-[#ffcd00]">${product.price.toFixed(2)} EGP</span>
                            <span class="text-lg lg:text-xl text-gray-500 line-through">${product.originalPrice.toFixed(2)} EGP</span>
                        </div>
                        <div class="text-sm font-semibold text-red-500 mt-2">
                            !وفر ${discountAmount.toFixed(2)} EGP (خصم ${discountPercent}%)
                        </div>
                    `;
                } else {
                    priceEl.innerHTML = `
                        <div class="flex items-baseline gap-3">
                            <span class="text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white">${product.price.toFixed(2)} EGP</span>
                        </div>
                    `;
                }

                
                
                const whatsappLink = document.getElementById('details-whatsapp-link');
                if (whatsappLink) {
                    const storePhone = "201146641942";
                    const productName = product.name;
                    
                    const message = `مرحباً متجر مكة،\n\nأود الاستفسار/الطلب بخصوص هذا المنتج:\n*${productName}*\n\nهل يمكنني معرفة المزيد من التفاصيل أو إتمام الطلب؟\nشكراً لكم.`;
                    const encodedMessage = encodeURIComponent(message);
                    whatsappLink.href = `https://wa.me/${storePhone}?text=${encodedMessage}`;
                }
                

                
                const cartWrapper = document.getElementById('details-add-to-cart-wrapper');
                cartWrapper.dataset.productId = product.id;
                cartWrapper.dataset.productName = product.name;
                cartWrapper.dataset.productPrice = product.price;
                cartWrapper.dataset.productImage = imageUrls[0]; 
                
                
                
                const detailBtn = cartWrapper.querySelector('.add-to-cart-btn');
                if (detailBtn) {
                    detailBtn.dataset.listenerAttached = 'false'; 
                    setupAddToCartButtons(); 
                }
                
                
                const quantityInput = document.getElementById('details-quantity-input');
                if (quantityInput) {
                    quantityInput.value = '1';
                }
                
                
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const isSpecs = btn.dataset.tab === 'specs';
                    btn.classList.toggle('active-tab', isSpecs);
                    btn.classList.toggle('text-[#ffcd00]', isSpecs);
                    btn.classList.toggle('border-[#ffcd00]', isSpecs);
                    btn.classList.toggle('text-gray-500', !isSpecs);
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    const isSpecs = content.id === 'tab-content-specs';
                    content.classList.toggle('hidden', !isSpecs);
                });
                
                

                const specsContainer = document.getElementById('specs-list-container');
                if (specsContainer) {
                    specsContainer.innerHTML = ''; 

                 
                    const specs = [
                        { label: 'الشركة', value: product.company },
                        { label: 'الجهد', value: product.volts },
                        { label: 'الطول', value: product.length ? `${product.length} meters` : undefined },
                        { label: 'الضمان', value: product.warranty },
                        { label: 'صنع في', value: product.madeIn },
                        { label: 'رقم الموديل', value: product.model }
                    ];

                    let specsAdded = 0;

                    
                    specs.forEach(spec => {
                       
                        if (spec.value && String(spec.value).trim() !== '') {
                            const li = document.createElement('li');
                            li.className = "grid grid-cols-1 sm:grid-cols-2 sm:gap-4 pb-2 border-b border-gray-200 dark:border-gray-700";
                            li.innerHTML = `
                                <span class="font-medium text-gray-800 dark:text-gray-100">${spec.label}:</span>
                                <span class="sm:text-left">${spec.value}</span>
                            `;
                            specsContainer.appendChild(li);
                            specsAdded++;
                        }
                    });

                   
                    if (specsAdded === 0) {
                        specsContainer.innerHTML = '<p class="text-gray-500">لا توجد مواصفات إضافية متاحة لهذا المنتج.</p>';
                    } else {
                       
                        if (specsContainer.lastChild) {
                            specsContainer.lastChild.classList.remove('border-b', 'pb-2');
                        }
                    }
                }


            }


            async function fetchAiSuggestions(productId) {
                const loadingElDesktop = document.getElementById('ai-suggestions-loading-desktop');
                const gridElDesktop = document.getElementById('ai-suggestions-grid-desktop');
                const loadingElMobile = document.getElementById('ai-suggestions-loading-mobile');
                const gridElMobile = document.getElementById('ai-suggestions-grid-mobile');
                
              
                if (loadingElDesktop) loadingElDesktop.classList.remove('hidden');
                if (gridElDesktop) gridElDesktop.innerHTML = ''; 
                if (loadingElMobile) loadingElMobile.classList.remove('hidden');
                if (gridElMobile) gridElMobile.innerHTML = ''; 

                try {
                    const currentProduct = allProducts.find(p => p.shortId === productId || p.id === productId);
                    if (!currentProduct) {
                   
                        throw new Error("Current product not found for suggestions.");
                    }

                    const currentCategory = currentProduct.category;
                    const maxSuggestions = 3;
                    let suggestions = [];

        
                    const categoryProducts = allProducts.filter(p => 
                        p.category === currentCategory && (p.shortId !== productId && p.id !== productId)
                    );

                  
                    let shuffledCategory = [...categoryProducts];
                    for (let i = shuffledCategory.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledCategory[i], shuffledCategory[j]] = [shuffledCategory[j], shuffledCategory[i]];
                    }
                    
                    suggestions = shuffledCategory.slice(0, maxSuggestions);

       
                    if (suggestions.length < maxSuggestions) {
                        const otherProducts = allProducts.filter(p => 
                            p.category !== currentCategory && (p.shortId !== productId && p.id !== productId)
                        );

         
                        let shuffledOthers = [...otherProducts];
                        for (let i = shuffledOthers.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [shuffledOthers[i], shuffledOthers[j]] = [shuffledOthers[j], shuffledOthers[i]];
                        }
                        
                        const needed = maxSuggestions - suggestions.length;
                        suggestions = suggestions.concat(shuffledOthers.slice(0, needed));
                    }
                    
                    
                    let suggestionsHtml = ''; 
                    if (suggestions.length === 0) {
                        
                        suggestionsHtml = `<p class="text-gray-500 dark:text-gray-400 col-span-2 sm:col-span-3 text-center">لا توجد منتجات أخرى لاقتراحها.</p>`;
                    } else {
                        
                        suggestions.forEach(product => {
                            if (product) {
                                
                                suggestionsHtml += renderProductCard(product);
                            }
                        });
                    }
                    
                  
                    if (gridElDesktop) gridElDesktop.innerHTML = suggestionsHtml;
                    if (gridElMobile) gridElMobile.innerHTML = suggestionsHtml;
                    
                    
            

                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                 
                    const otherProducts = allProducts.filter(p => p.shortId !== productId && p.id !== productId);
                    let shuffled = [...otherProducts];
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                    const randomSuggestions = shuffled.slice(0, 3);
                    
                    let fallbackHtml = '';
                    if (randomSuggestions.length > 0) {
                         randomSuggestions.forEach(product => {
                            if (product) {
                              
                                fallbackHtml += renderProductCard(product);
                            }
                        });
                     
                    } else {
                        fallbackHtml = `<p class="text-red-500 col-span-2 sm:col-span-3 text-center">لا توجد اقتراحات حالياً.</p>`;
                    }
                    
                    if (gridElDesktop) gridElDesktop.innerHTML = fallbackHtml;
                    if (gridElMobile) gridElMobile.innerHTML = fallbackHtml;

                } finally {
                   
                    if (loadingElDesktop) loadingElDesktop.classList.add('hidden');
                    if (loadingElMobile) loadingElMobile.classList.add('hidden');
                    
                   
                    setupAddToCartButtons();
                    setupDeleteProductButtons();
                    setupEditProductButtons();
             
                    lucide.createIcons();
                }
            }

            function loadProducts() {
                const productsRef = collection(db, "products");
                const q = query(productsRef);

                onSnapshot(q, (querySnapshot) => {
                 
                    allProducts = []; 
                    querySnapshot.forEach((doc) => {
                        allProducts.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Products loaded from Firestore:", allProducts.length);
                    
                    renderAllProductViews();
                }, (error) => {
                    console.error("Error fetching products: ", error);
                    showToast("خطأ أثناء جلب المنتجات.");
                });
            }
            
            document.getElementById('product-search-input').addEventListener('input', () => {
                preFilterType = 'all';
                renderAllProductViews();
            });

            const categoryFilterForPlaceholder = document.getElementById('product-category-filter');
            const searchInputForPlaceholder = document.getElementById('product-search-input');

            function updateSearchPlaceholder() {
                if (!categoryFilterForPlaceholder || !searchInputForPlaceholder) return;
                const selectedOption = categoryFilterForPlaceholder.options[categoryFilterForPlaceholder.selectedIndex];
                const selectedText = selectedOption.value === 'all' ? 'جميع الأقسام' : selectedOption.text;
                searchInputForPlaceholder.placeholder = `ابحث في ${selectedText}...`;
            }

            if (categoryFilterForPlaceholder) {
                categoryFilterForPlaceholder.addEventListener('change', () => {
                    preFilterType = 'all';
                    updateSearchPlaceholder();
                    renderAllProductViews();
                });
            }
            
            document.getElementById('product-sort-filter').addEventListener('change', () => {
                preFilterType = 'all';
                renderAllProductViews();
            });

            function loadArticles() {
                const articlesRef = collection(db, "articles");
                const q = query(articlesRef);

                onSnapshot(q, (querySnapshot) => {
                    allArticles = [];
                    querySnapshot.forEach((doc) => {
                        allArticles.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Articles loaded from Firestore:", allArticles.length);
                    renderArticles();
                }, (error) => {
                    console.error("Error fetching articles: ", error);
                    showToast("خطأ أثناء جلب المقالات.");
                });
            }

           
            function loadSiteConfig() {
               
                const bannerConfigRef = doc(db, "config", "main_banners");
                
                onSnapshot(bannerConfigRef, (docSnap) => {
                    const lightBannerImg = document.getElementById('special-offer-banner-light')?.querySelector('img');
                    const darkBannerImg = document.getElementById('special-offer-banner-dark')?.querySelector('img');
                    const adminLightUrlInput = document.getElementById('admin-light-banner-url');
                    const adminDarkUrlInput = document.getElementById('admin-dark-banner-url');

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                     
                        if (lightBannerImg && data.lightUrl) {
                            lightBannerImg.src = data.lightUrl;
                        }
                        if (darkBannerImg && data.darkUrl) {
                            darkBannerImg.src = data.darkUrl;
                        }
                        
                       
                        if (adminLightUrlInput) {
                            adminLightUrlInput.value = data.lightUrl || '';
                        }
                        if (adminDarkUrlInput) {
                            adminDarkUrlInput.value = data.darkUrl || '';
                        }
                        
                    } else {
                        console.log("No banner config document found!");
                    }
                }, (error) => {
                    console.error("Error fetching banner config: ", error);
                    showToast("خطأ في تحميل إعدادات البانر.");
                });

               
                // --- تعديل دالة تحميل إعدادات الصفحة الرئيسية ---
                const homepageConfigRef = doc(db, "config", "homepage");
                onSnapshot(homepageConfigRef, (docSnap) => {
                    // جلب كل العناصر
                    const videoEl = document.getElementById('hero-video');
                    const videoSourceEl = document.getElementById('hero-video-source');
                    const imageEl = document.getElementById('hero-image');

                    // جلب كل عناصر لوحة التحكم
                    const adminHeroTypeSelect = document.getElementById('admin-hero-type');
                    const adminVideoUrlInput = document.getElementById('admin-video-url');
                    const adminImageUrlInput = document.getElementById('admin-image-url');

                    // إخفاء العناصر أولاً
                    if (videoEl) videoEl.classList.add('hidden');
                    if (imageEl) imageEl.classList.add('hidden');

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const heroType = data.heroType || 'video'; // الافتراضي هو فيديو
                        const videoUrl = data.videoUrl;
                        const imageUrl = data.imageUrl;

                        // --- 1. تحديث واجهة العرض (الهيرو) ---
                        if (heroType === 'video' && videoUrl) {
                            if (videoSourceEl) videoSourceEl.src = videoUrl;
                            if (videoEl) {
                                videoEl.load();
                                videoEl.classList.remove('hidden');
                            }
                        } else if (heroType === 'image' && imageUrl) {
                            if (imageEl) {
                                imageEl.src = imageUrl;
                                imageEl.classList.remove('hidden');
                            }
                        } else {
                            // في حالة عدم وجود إعدادات، عرض الفيديو الافتراضي
                            if (videoEl) {
                                videoEl.load(); // تحميل المصدر الافتراضي الموجود في الـ HTML
                                videoEl.classList.remove('hidden');
                            }
                        }

                        // --- 2. تحديث لوحة التحكم ---
                        if (adminHeroTypeSelect) {
                            adminHeroTypeSelect.value = heroType;
                            // تفعيل الحدث يدوياً لإظهار/إخفاء الحقول الصحيحة
                            adminHeroTypeSelect.dispatchEvent(new Event('change'));
                        }
                        if (adminVideoUrlInput) {
                            adminVideoUrlInput.value = videoUrl || '';
                        }
                        if (adminImageUrlInput) {
                            adminImageUrlInput.value = imageUrl || '';
                        }
                        
                    } else {
                        // لا يوجد ملف إعدادات، اعرض الفيديو الافتراضي
                        console.log("No homepage config document found! Showing default video.");
                        if (videoEl) videoEl.classList.remove('hidden');
                    }
                }, (error) => {
                    console.error("Error fetching homepage config: ", error);
                    showToast("خطأ في تحميل إعدادات الفيديو.");
                    // عرض الفيديو الافتراضي عند حدوث خطأ
                    if (videoEl) videoEl.classList.remove('hidden');
                });
            }
      


            const closeMobileMenu = () => {
                const mobileMenu = document.getElementById('mobile-menu');
                const openIcon = document.getElementById('mobile-menu-open-icon');
                const closeIcon = document.getElementById('mobile-menu-close-icon');
                const mobileMenuButton = document.getElementById('mobile-menu-button');

                if (mobileMenu && openIcon && closeIcon && mobileMenuButton) {
                    mobileMenu.classList.add('hidden');
                    openIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                    mobileMenuButton.setAttribute('aria-expanded', 'false');
                }
            };

            const showPage = (pageId, itemId = null) => {
                
                console.log('showPage called with pageId:', pageId, 'and itemId:', itemId); 
                
                
                const allPages = document.querySelectorAll('.page-section');
                allPages.forEach(page => {
                    page.classList.remove('active');
                });
                
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                    if (pageId === 'cart') {
                        renderCartPage();
                    } else if (pageId === 'details' && itemId) {
                        renderProductDetails(itemId);
                        fetchAiSuggestions(itemId); 
                    } else if (pageId === 'blog-post' && itemId) {
                        renderArticleDetails(itemId);
                    }
                } else {
                    const homePage = document.getElementById('page-home');
                    if (homePage) {
                        homePage.classList.add('active');
                    }
                }
                
                const lightBanner = document.getElementById('special-offer-banner-light');
                const darkBanner = document.getElementById('special-offer-banner-dark');
                
                if (lightBanner && darkBanner) {
                 

                    if (pageId === 'home') {
                        
                        lightBanner.style.transform = 'translateY(0)';
                        darkBanner.style.transform = 'translateY(0)';
                    } else {
                        
                        lightBanner.style.transform = 'translateY(-100%)';
                        darkBanner.style.transform = 'translateY(-100%)';
                    }
                }
           

                window.scrollTo(0, 0);
                closeMobileMenu();
                
                lucide.createIcons();
            };

            try {
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                const openIcon = document.getElementById('mobile-menu-open-icon');
                const closeIcon = document.getElementById('mobile-menu-close-icon');

                if (mobileMenuButton) {
                    mobileMenuButton.addEventListener('click', () => {
                        const isOpen = mobileMenu.classList.toggle('hidden');
                        openIcon.classList.toggle('hidden', !isOpen);
                        closeIcon.classList.toggle('hidden', isOpen);
                        mobileMenuButton.setAttribute('aria-expanded', !isOpen);
                    });
                }
               
                
                
                const allPages = document.querySelectorAll('.page-section');
                const allNavLinks = document.querySelectorAll('.nav-link, .logo-link');
                const allMobileNavLinks = document.querySelectorAll('.mobile-nav-link');

                allNavLinks.forEach(link => {
                    
                    if (link.dataset.navListenerAttached) return; 
                    link.dataset.navListenerAttached = 'true';

                   
                    const categoryFilter = link.dataset.categoryFilter;

                    if (categoryFilter) {
                        link.addEventListener('click', (e) => {
                            e.preventDefault(); 
                            const pageId = e.currentTarget.dataset.page;
                            
                            const categoryDropdown = document.getElementById('product-category-filter');
                            if (categoryDropdown) {
                                categoryDropdown.value = categoryFilter;
                               
                                document.getElementById('product-search-input').value = '';
                                document.getElementById('product-sort-filter').value = 'default';
                                preFilterType = 'all'; 
                                updateSearchPlaceholder(); 
                            }
                            window.location.hash = `#${pageId}`; 
                        });
                    }
                    
                });
                
                allMobileNavLinks.forEach(link => {
         
                    if (link.dataset.navListenerAttached) return;
                    link.dataset.navListenerAttached = 'true';

                  
                });

                const lightBanner = document.getElementById('special-offer-banner-light');
                const darkBanner = document.getElementById('special-offer-banner-dark');
                
                if (lightBanner && darkBanner) {
                  
                    let pageIsSettling = true; 
                    
                  
                    const checkBannerState = () => {
               
                
                        const isHomePage = document.getElementById('page-home').classList.contains('active');
                        if (!isHomePage) {
                       
                            return; 
                        }
                   

                        const currentScrollY = window.scrollY;

                        if (currentScrollY < 10) { 
                            
                            lightBanner.style.transform = 'translateY(0)';
                            darkBanner.style.transform = 'translateY(0)';
                        } else {
                            
                            if (!pageIsSettling) {
                                lightBanner.style.transform = 'translateY(-100%)';
                                darkBanner.style.transform = 'translateY(-100%)';
                            }
                        }
                    };
                    
                
                    window.addEventListener('scroll', checkBannerState, { passive: true });

              
                    lightBanner.style.transform = 'translateY(0)';
                    darkBanner.style.transform = 'translateY(0)';
                    
                  
                    setTimeout(() => {
                        pageIsSettling = false;
                      
                        checkBannerState();
                    }, 500); 
                }
             
                const adminForm = document.getElementById('admin-settings-form');
                if (adminForm) {
                    adminForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                      
                        if (!currentIsAdmin) {
                            showToast("ليس لديك صلاحية.");
                            return;
                        }

                        const saveBtn = document.getElementById('save-admin-settings-btn');
                        const originalBtnText = saveBtn.innerHTML;
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '...جاري الحفظ';

                        try {
                          
                            const lightUrl = document.getElementById('admin-light-banner-url').value;
                            const darkUrl = document.getElementById('admin-dark-banner-url').value;
                            const bannerConfigRef = doc(db, "config", "main_banners");
                            await setDoc(bannerConfigRef, { lightUrl, darkUrl }, { merge: true });

                        
                            // --- تعديل منطق الحفظ ---
                            const heroType = document.getElementById('admin-hero-type').value;
                            const videoUrl = document.getElementById('admin-video-url').value;
                            const imageUrl = document.getElementById('admin-image-url').value;
                            
                            const homepageConfigRef = doc(db, "config", "homepage");
                            // حفظ كل البيانات الجديدة
                            await setDoc(homepageConfigRef, { heroType, videoUrl, imageUrl }, { merge: true });

                            showToast("تم حفظ الإعدادات بنجاح!");
                        } catch (error) {
                            console.error("Error saving config: ", error);
                            showToast("خطأ أثناء حفظ الإعدادات.");
                        } finally {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                    });
                }
               
                
                
                document.querySelectorAll('.see-all-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        preFilterType = e.currentTarget.dataset.filterType;
                        
                        
                        document.getElementById('product-search-input').value = '';
                        document.getElementById('product-category-filter').value = 'all';
                        document.getElementById('product-sort-filter').value = 'default';
                        
                        
                    
                        window.location.hash = '#products';
                    });
                });

                const contactForm = document.getElementById('contact-form');
                const successMessage = document.getElementById('form-success-message');
                if(contactForm) {
                    contactForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        if(successMessage) successMessage.classList.remove('hidden');
                        contactForm.reset();
                        setTimeout(() => {
                            if(successMessage) successMessage.classList.add('hidden');
                        }, 3000);
                    });
                }
                
                const checkoutBtn = document.getElementById('whatsapp-checkout-btn');
                if (checkoutBtn) {
                    checkoutBtn.addEventListener('click', generateWhatsAppInvoice);
                }
                
                // lucide.createIcons(); // <-- هذا هو السطر الذي يجب حذفه

                
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;

                        
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active-tab', 'text-[#ffcd00]', 'border-b-2', 'border-[#ffcd00]');
                            btn.classList.add('text-gray-500');
                        });
                        button.classList.add('active-tab', 'text-[#ffcd00]', 'border-b-2', 'border-[#ffcd00]');
                        button.classList.remove('text-gray-500');

                        
                        tabContents.forEach(content => {
                            if (content.id === `tab-content-${tabId}`) {
                                content.classList.remove('hidden');
                            } else {
                                content.classList.add('hidden');
                            }
                        });
                    });
                });

                
                // --- إضافة منطق لإظهار/إخفاء حقول لوحة التحكم ---
                const adminHeroTypeSelect = document.getElementById('admin-hero-type');
                const adminVideoContainer = document.getElementById('admin-video-url-container');
                const adminImageContainer = document.getElementById('admin-image-url-container');

                if (adminHeroTypeSelect && adminVideoContainer && adminImageContainer) {
                    adminHeroTypeSelect.addEventListener('change', () => {
                        if (adminHeroTypeSelect.value === 'video') {
                            adminVideoContainer.classList.remove('hidden');
                            adminImageContainer.classList.add('hidden');
                        } else {
                            adminVideoContainer.classList.add('hidden');
                            adminImageContainer.classList.remove('hidden');
                        }
                    });
                }
                // --- نهاية الإضافة ---


                function handleRouting() {
                    const hash = window.location.hash || '#home';
                    console.log("Routing to:", hash);

                    const allNavLinks = document.querySelectorAll('.nav-link, .logo-link');
                    const allMobileNavLinks = document.querySelectorAll('.mobile-nav-link');

                    let targetPageId = 'home'; // default
                    let targetItemId = null;
                    const simplePages = ['home', 'products', 'blog', 'contact', 'cart', 'admin', 'about'];

                    if (hash.startsWith('#product/')) {
                        targetPageId = 'details';
                        targetItemId = hash.substring('#product/'.length);
                    } else if (hash.startsWith('#blog/')) {
                        targetPageId = 'blog-post';
                        targetItemId = hash.substring('#blog/'.length);
                    } else {
                        const pageName = hash.substring(1);
                        if (simplePages.includes(pageName)) {
                            targetPageId = pageName;
                        } else {
                            targetPageId = 'home'; 
                        }
                    }
                    

                    showPage(targetPageId, targetItemId);

                    allNavLinks.forEach(link => {
                        link.classList.toggle('active', link.dataset.page === targetPageId);
                    });
                    
                    allMobileNavLinks.forEach(link => {
                        link.classList.toggle('active', link.dataset.page === targetPageId);
                    });
                }


                window.addEventListener('hashchange', handleRouting);


                handleRouting();


            } catch (error) {
                console.error('Error initializing app:', error);
                document.querySelector('main').innerHTML = '<p class="text-center text-red-500">Error loading website content.</p>';
            }
        

    </script>

</body>
</html>